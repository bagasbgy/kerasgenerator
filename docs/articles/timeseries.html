<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Data Generator for Time Series Models • kerasgenerator</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha256-916EbMg70RQy9LHiGkXzG8hSg9EdNy97GazNG/aiY1w=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- sticky kit --><script src="https://cdnjs.cloudflare.com/ajax/libs/sticky-kit/1.1.3/sticky-kit.min.js" integrity="sha256-c4Rlo1ZozqTPE2RLuvbusY3+SU1pQaJC0TjuhygMipw=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<meta property="og:title" content="Data Generator for Time Series Models">
<meta property="og:description" content="">
<meta property="og:image" content="/logo.png">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">kerasgenerator</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.1.2</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/timeseries.html">Data Generator for Time Series Models</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/bagasbgy/kerasgenerator">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Data Generator for Time Series Models</h1>
                        <h4 class="author">R. Dimas Bagas Herlambang</h4>
            
            <h4 class="date">Last updated on: January 7, 2019</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/bagasbgy/kerasgenerator/blob/master/vignettes/timeseries.Rmd"><code>vignettes/timeseries.Rmd</code></a></small>
      <div class="hidden name"><code>timeseries.Rmd</code></div>

    </div>

    
    
<p>Preparing a proper dataset for a supervised time series model in R sometimes could become very complex and tedious. There are some tutorials that already cover this kind of task: check out the tutorial made by <a href="https://blogs.rstudio.com/tensorflow/posts/2018-06-25-sunspots-lstm/">Dancho and Keydana</a> <span class="citation">(<a href="#ref-dancho2018predicting">2018</a>)</span> for basic univariate model fitting without using data generator, and the one made by <a href="https://blogs.rstudio.com/tensorflow/posts/2017-12-20-time-series-forecasting-with-recurrent-neural-networks/">Chollet and Allaire</a> <span class="citation">(<a href="#ref-chollet2017time">2017</a>)</span> for the multivariate model with a custom data generator. However, as you could see from the articles, there are no general framework on how to properly do the data preparation process.</p>
<p>In this article we will show you how <code>kerasgenerator</code> could help us in preparing a data generator for supervised time series <a href="https://keras.rstudio.com"><code>keras</code></a> models.</p>
<div id="introduction" class="section level1">
<h1 class="hasAnchor">
<a href="#introduction" class="anchor"></a>Understanding the Time Series Array Shape</h1>
<p>To fit a supervised time series model, many of <code>keras</code>’ functions expect the target and feature data to be in an <code>array</code> object with a specific number of dimension. The input <code>array</code> need to have three dimension that represent:</p>
<ol style="list-style-type: decimal">
<li>Sample index</li>
<li>Number of timesteps</li>
<li>Number of distinct feature</li>
</ol>
<p>while the output <code>array</code> need to have two dimension that represent:</p>
<ol style="list-style-type: decimal">
<li>Sample index</li>
<li>Number of distinct target</li>
</ol>
<p>To understand better what each dimensions representing, let’s follow a quick example using the popular <a href="https://datamarket.com/data/set/232n/internet-traffic-data-in-bits-from-a-private-isp-with-centres-in-11-european-cities-the-data-corresponds-to-a-transatlantic-link-and-was-collected-from-0657-hours-on-7-june-to-1117-hours-on-31-july-2005-data-collected-at-five-minute-intervals#!ds=232n&amp;display=line">Internet Traffic Data from 11 European Cities</a> dataset, provided by Time Series Data Library <span class="citation">(Hyndman, <a href="#ref-hyndman2019time">2019</a>)</span>. We can download the datasets using <code>rdatamarket</code> package:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="co"># import libs</span></a>
<a class="sourceLine" id="cb1-2" data-line-number="2"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(lubridate)</a>
<a class="sourceLine" id="cb1-3" data-line-number="3"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(magrittr)</a>
<a class="sourceLine" id="cb1-4" data-line-number="4"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(rdatamarket)</a>
<a class="sourceLine" id="cb1-5" data-line-number="5"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(tidyverse)</a>
<a class="sourceLine" id="cb1-6" data-line-number="6"></a>
<a class="sourceLine" id="cb1-7" data-line-number="7"><span class="co"># import dataset</span></a>
<a class="sourceLine" id="cb1-8" data-line-number="8">traffic_tbl &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/rdatamarket/topics/dmlist">dmlist</a></span>(<span class="st">"http://bit.ly/1W1mCQ3"</span>)</a>
<a class="sourceLine" id="cb1-9" data-line-number="9"></a>
<a class="sourceLine" id="cb1-10" data-line-number="10"><span class="co"># readjust datetime</span></a>
<a class="sourceLine" id="cb1-11" data-line-number="11">traffic_tbl <span class="op">%&lt;&gt;%</span></a>
<a class="sourceLine" id="cb1-12" data-line-number="12"><span class="st">  </span><span class="kw">select</span>(<span class="dt">datetime =</span> DateTime, <span class="dt">traffic =</span> Value) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb1-13" data-line-number="13"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">datetime =</span> <span class="kw"><a href="http://lubridate.tidyverse.org/reference/ymd_hms.html">ymd_hms</a></span>(datetime))</a>
<a class="sourceLine" id="cb1-14" data-line-number="14"></a>
<a class="sourceLine" id="cb1-15" data-line-number="15"><span class="co"># quick check</span></a>
<a class="sourceLine" id="cb1-16" data-line-number="16"><span class="kw">glimpse</span>(traffic_tbl)</a></code></pre></div>
<pre><code>## Observations: 14,772
## Variables: 2
## $ datetime &lt;dttm&gt; 2005-06-07 07:00:00, 2005-06-07 07:05:00, 2005-06-07 0…
## $ traffic  &lt;dbl&gt; 3562279127, 3710215571, 3877469703, 3876354871, 4582542…</code></pre>
<p>The dataset is in a general time series format–it contains a time identifier column, each row representing a data within 5-minutes interval, and it is already regularly ordered. This dataset shows a very interesting time series patterns:</p>
<div class="figure" style="text-align: center">
<img src="timeseries_files/figure-html/unnamed-chunk-2-1.png" alt="The Internet Traffic dataset" width="100%"><p class="caption">
The Internet Traffic dataset
</p>
</div>
<p>In supervised time series model, we need to define two important parameters for our datasets:</p>
<ul>
<li>
<p>lookback period:</p>
<p>The lookback period is determining <strong>how many period behind should the targets lookup for its signal</strong>, but it should be noted that <strong>the periods in-between will be ignored</strong>. For example, for target <span class="math inline">\(y_t\)</span> and <span class="math inline">\(l\)</span> lookback, then the target will lookup for feature <span class="math inline">\(x_{t-l}\)</span>.</p>
</li>
<li>
<p>timestep length:</p>
<p>This parameter define <strong>the length of a sample of feature</strong> that would be considered as a sequence of signal for the target. For example, for feature <span class="math inline">\(x_t\)</span> and <span class="math inline">\(ts\)</span> timesteps length, then the target will lookup for feature <span class="math inline">\(x_t, x_{t-l}, x_{t-2}, ..., x_{t-ts+1}\)</span>.</p>
</li>
</ul>
<p><strong>Note</strong> that the terms that I just mentioned might be differ from other source. While all the version reach to a same understanding, I really suggest you to read the original paper of <a href="https://www.bioinf.jku.at/publications/older/2604.pdf">Long Short-Term Memory</a> layer <span class="citation">(Hochreiter &amp; Schmidhuber, <a href="#ref-hochreiter1997long">1997</a>)</span> and other valid resources to reach a better understanding of the terminologies.</p>
<p>Now let’s make some illustration using our dataset to make it clear. Supposed that we want to predict the value of 5-minutes total traffic using the hourly pattern in the same minute of previous hour. Say, we pick the last observation of our dataset as our target then the index for our target and its feature will be:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" data-line-number="1"><span class="co"># set some parameters</span></a>
<a class="sourceLine" id="cb3-2" data-line-number="2">lookback &lt;-<span class="st"> </span><span class="dv">12</span></a>
<a class="sourceLine" id="cb3-3" data-line-number="3">timesteps &lt;-<span class="st"> </span><span class="dv">12</span></a>
<a class="sourceLine" id="cb3-4" data-line-number="4"></a>
<a class="sourceLine" id="cb3-5" data-line-number="5"><span class="co"># specify the target and feature</span></a>
<a class="sourceLine" id="cb3-6" data-line-number="6">target &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/nrow">nrow</a></span>(traffic_tbl)</a>
<a class="sourceLine" id="cb3-7" data-line-number="7">feature_end &lt;-<span class="st"> </span>target <span class="op">-</span><span class="st"> </span>lookback</a>
<a class="sourceLine" id="cb3-8" data-line-number="8">feature_start &lt;-<span class="st"> </span>feature_end <span class="op">-</span><span class="st"> </span>timesteps <span class="op">+</span><span class="st"> </span><span class="dv">1</span></a>
<a class="sourceLine" id="cb3-9" data-line-number="9"></a>
<a class="sourceLine" id="cb3-10" data-line-number="10"><span class="co"># check the values</span></a>
<a class="sourceLine" id="cb3-11" data-line-number="11"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/paste">paste</a></span>(<span class="st">"Target:"</span>, traffic_tbl<span class="op">$</span>datetime[target])</a></code></pre></div>
<pre><code>## [1] "Target: 2005-07-28 13:55:00"</code></pre>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" data-line-number="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/paste">paste</a></span>(<span class="st">"Feature start:"</span>, traffic_tbl<span class="op">$</span>datetime[feature_start])</a></code></pre></div>
<pre><code>## [1] "Feature start: 2005-07-28 12:00:00"</code></pre>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb7-1" data-line-number="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/paste">paste</a></span>(<span class="st">"Feature end:"</span>, traffic_tbl<span class="op">$</span>datetime[feature_end])</a></code></pre></div>
<pre><code>## [1] "Feature end: 2005-07-28 12:55:00"</code></pre>
<p>Notice that I set the <code>feature_start</code> to be <code>feature_end - timesteps + 1</code>. This is because the <code>timesteps</code> value is representing the length of a feature–if we don’t add <code>+ 1</code>, the timesteps would be longer by 1 value. See the following figure for an illustration:</p>
<div class="figure" style="text-align: center">
<img src="timeseries_files/figure-html/unnamed-chunk-4-1.png" alt="Supervised time series model illustration" width="100%"><p class="caption">
Supervised time series model illustration
</p>
</div>
<p>If we follow this format, then we could convert the data into a proper <code>array</code> matrices like this:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb9-1" data-line-number="1"><span class="co"># container arrays</span></a>
<a class="sourceLine" id="cb9-2" data-line-number="2">x_array &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/array">array</a></span>(<span class="dv">0</span>, <span class="dt">dim =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="dv">1</span>, timesteps, <span class="dv">1</span>))</a>
<a class="sourceLine" id="cb9-3" data-line-number="3">y_array &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/array">array</a></span>(<span class="dv">0</span>, <span class="dt">dim =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="dv">1</span>, <span class="dv">1</span>))</a>
<a class="sourceLine" id="cb9-4" data-line-number="4"></a>
<a class="sourceLine" id="cb9-5" data-line-number="5"><span class="co"># specify the row indices</span></a>
<a class="sourceLine" id="cb9-6" data-line-number="6">y_row &lt;-<span class="st"> </span>target</a>
<a class="sourceLine" id="cb9-7" data-line-number="7">x_row &lt;-<span class="st"> </span>y_row <span class="op">-</span><span class="st"> </span>lookback</a>
<a class="sourceLine" id="cb9-8" data-line-number="8"></a>
<a class="sourceLine" id="cb9-9" data-line-number="9"><span class="co"># adjust the x indices according to the timesteps</span></a>
<a class="sourceLine" id="cb9-10" data-line-number="10">x_indices &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/seq">seq</a></span>(x_row <span class="op">-</span><span class="st"> </span>timesteps <span class="op">+</span><span class="st"> </span><span class="dv">1</span>, x_row)</a>
<a class="sourceLine" id="cb9-11" data-line-number="11"></a>
<a class="sourceLine" id="cb9-12" data-line-number="12"><span class="co"># convert the table into matrix</span></a>
<a class="sourceLine" id="cb9-13" data-line-number="13">traffic_matrix &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/data.matrix">data.matrix</a></span>(traffic_tbl)</a>
<a class="sourceLine" id="cb9-14" data-line-number="14"></a>
<a class="sourceLine" id="cb9-15" data-line-number="15"><span class="co"># fill the arrays</span></a>
<a class="sourceLine" id="cb9-16" data-line-number="16">x_array[<span class="dv">1</span>, , <span class="dv">1</span>] &lt;-<span class="st"> </span>traffic_matrix[x_indices, <span class="dv">2</span>]</a>
<a class="sourceLine" id="cb9-17" data-line-number="17">y_array[<span class="dv">1</span>, <span class="dv">1</span>] &lt;-<span class="st"> </span>traffic_matrix[y_row, <span class="dv">2</span>]</a></code></pre></div>
<p>Let’s confirm the structure and content inside the arrays:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb10-1" data-line-number="1"><span class="co"># check the structure</span></a>
<a class="sourceLine" id="cb10-2" data-line-number="2"><span class="kw"><a href="https://www.rdocumentation.org/packages/utils/topics/str">str</a></span>(x_array)</a></code></pre></div>
<pre><code>##  num [1, 1:12, 1] 6.14e+09 6.25e+09 6.29e+09 6.24e+09 6.34e+09 ...</code></pre>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb12-1" data-line-number="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/utils/topics/str">str</a></span>(y_array)</a></code></pre></div>
<pre><code>##  num [1, 1] 6.61e+09</code></pre>
<p>Basically, the <a href="/reference/series_generator"><code><a href="../reference/series_generator.html">series_generator()</a></code></a> function is transforming your data into the same format as in above explanations; <a href="(/reference/forecast_generator)"><code><a href="../reference/forecast_generator.html">forecast_generator()</a></code></a> also works in a similar way, but have a different point of view (see <a href="#forecast">forecasting section</a> for further explanation). Let’s take a look on how those functions in action in the following sections.</p>
</div>
<div id="fitting" class="section level1">
<h1 class="hasAnchor">
<a href="#fitting" class="anchor"></a>Fitting a Time Series Model</h1>
<p>To build a time series data generator, we need to specify some parameters related to our model. Let’s start by the supervised time series model specifications. In addition to <code>lookback</code> and <code>timesteps</code>, we also need to specify the <code>x</code> and <code>y</code> variables, which in this case are both <code>"traffic"</code> variable:</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb14-1" data-line-number="1"><span class="co"># the x and y</span></a>
<a class="sourceLine" id="cb14-2" data-line-number="2">x &lt;-<span class="st"> "traffic"</span></a>
<a class="sourceLine" id="cb14-3" data-line-number="3">y &lt;-<span class="st"> "traffic"</span></a>
<a class="sourceLine" id="cb14-4" data-line-number="4"></a>
<a class="sourceLine" id="cb14-5" data-line-number="5"><span class="co"># supervised parameter</span></a>
<a class="sourceLine" id="cb14-6" data-line-number="6">lookback &lt;-<span class="st"> </span><span class="dv">12</span></a>
<a class="sourceLine" id="cb14-7" data-line-number="7">timesteps &lt;-<span class="st"> </span><span class="dv">12</span></a></code></pre></div>
<p>Another parameters that neet to be set are related to our cross-validation settings. In order to split the dataset into train, validation, and test dataset, the <code><a href="../reference/series_generator.html">series_generator()</a></code> need to know the <code>start_index</code> and <code>end_index</code>. First, let’s start by defining each sample sizes:</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb15-1" data-line-number="1"><span class="co"># number of train-val-test sample</span></a>
<a class="sourceLine" id="cb15-2" data-line-number="2">train_size &lt;-<span class="st"> </span><span class="dv">12</span> <span class="op">*</span><span class="st"> </span><span class="dv">24</span> <span class="op">*</span><span class="st"> </span><span class="dv">7</span> <span class="op">*</span><span class="st"> </span><span class="dv">4</span></a>
<a class="sourceLine" id="cb15-3" data-line-number="3">val_size &lt;-<span class="st"> </span><span class="dv">12</span> <span class="op">*</span><span class="st"> </span><span class="dv">24</span> <span class="op">*</span><span class="st"> </span><span class="dv">7</span></a>
<a class="sourceLine" id="cb15-4" data-line-number="4">test_size &lt;-<span class="st"> </span><span class="dv">12</span> <span class="op">*</span><span class="st"> </span><span class="dv">24</span> <span class="op">*</span><span class="st"> </span><span class="dv">7</span></a></code></pre></div>
<p>Then we can specify the sample indices according to its size. Note that you can choose to sample the row indices, but I really suggest to follow the best practice by splitting the samples according to its time order:</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb16-1" data-line-number="1"><span class="co"># train-val row indices</span></a>
<a class="sourceLine" id="cb16-2" data-line-number="2">test_end &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/nrow">nrow</a></span>(traffic_tbl)</a>
<a class="sourceLine" id="cb16-3" data-line-number="3">test_start &lt;-<span class="st"> </span>test_end <span class="op">-</span><span class="st"> </span>test_size <span class="op">+</span><span class="st"> </span><span class="dv">1</span></a>
<a class="sourceLine" id="cb16-4" data-line-number="4"></a>
<a class="sourceLine" id="cb16-5" data-line-number="5">val_end &lt;-<span class="st"> </span>test_start <span class="op">-</span><span class="st"> </span><span class="dv">1</span></a>
<a class="sourceLine" id="cb16-6" data-line-number="6">val_start &lt;-<span class="st"> </span>val_end <span class="op">-</span><span class="st"> </span>val_size <span class="op">+</span><span class="st"> </span><span class="dv">1</span></a>
<a class="sourceLine" id="cb16-7" data-line-number="7"></a>
<a class="sourceLine" id="cb16-8" data-line-number="8">train_end &lt;-<span class="st"> </span>val_start <span class="op">-</span><span class="st"> </span><span class="dv">1</span></a>
<a class="sourceLine" id="cb16-9" data-line-number="9">train_start &lt;-<span class="st"> </span>train_end <span class="op">-</span><span class="st"> </span>train_size <span class="op">+</span><span class="st"> </span><span class="dv">1</span></a></code></pre></div>
<p>The last but not least, we need to specify the <code>batch_size</code> and the number of <code>steps</code> in order to see the full data for each sample:</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb17-1" data-line-number="1"><span class="co"># batch size</span></a>
<a class="sourceLine" id="cb17-2" data-line-number="2">batch_size &lt;-<span class="st"> </span><span class="dv">12</span> <span class="op">*</span><span class="st"> </span><span class="dv">24</span></a>
<a class="sourceLine" id="cb17-3" data-line-number="3"></a>
<a class="sourceLine" id="cb17-4" data-line-number="4"><span class="co"># number of steps to see full data</span></a>
<a class="sourceLine" id="cb17-5" data-line-number="5">train_steps &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Round">ceiling</a></span>(train_size <span class="op">/</span><span class="st"> </span>batch_size)</a>
<a class="sourceLine" id="cb17-6" data-line-number="6">val_steps &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Round">ceiling</a></span>(val_size <span class="op">/</span><span class="st"> </span>batch_size)</a>
<a class="sourceLine" id="cb17-7" data-line-number="7">test_steps &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Round">ceiling</a></span>(test_size <span class="op">/</span><span class="st"> </span>batch_size)</a></code></pre></div>
<p><strong>Note</strong> that I wrap the <code>size / batch_size</code> with <code>ceiling</code> function. This is necessary to ensure that Keras’ generator function will see all observation.</p>
<p>Before we define the data generators, let’s define a custom function for data preprocessing on the fly using <a href="https://tidymodels.github.io/recipes/"><code>recipes</code></a> functions:</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb18-1" data-line-number="1"><span class="co"># import libs</span></a>
<a class="sourceLine" id="cb18-2" data-line-number="2"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(recipes)</a>
<a class="sourceLine" id="cb18-3" data-line-number="3"></a>
<a class="sourceLine" id="cb18-4" data-line-number="4"><span class="co"># recipe: square root, center, scale</span></a>
<a class="sourceLine" id="cb18-5" data-line-number="5">recipe_obj &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/recipes/topics/recipe">recipe</a></span>(traffic <span class="op">~</span><span class="st"> </span>., traffic_tbl[train_start<span class="op">:</span>train_end, ]) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb18-6" data-line-number="6"><span class="st">  </span><span class="kw"><a href="https://www.rdocumentation.org/packages/recipes/topics/step_sqrt">step_sqrt</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/recipes/topics/has_role">all_outcomes</a></span>()) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb18-7" data-line-number="7"><span class="st">  </span><span class="kw"><a href="https://www.rdocumentation.org/packages/recipes/topics/step_center">step_center</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/recipes/topics/has_role">all_outcomes</a></span>()) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb18-8" data-line-number="8"><span class="st">  </span><span class="kw"><a href="https://www.rdocumentation.org/packages/recipes/topics/step_scale">step_scale</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/recipes/topics/has_role">all_outcomes</a></span>()) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb18-9" data-line-number="9"><span class="st">  </span><span class="kw"><a href="https://www.rdocumentation.org/packages/recipes/topics/prep">prep</a></span>()</a>
<a class="sourceLine" id="cb18-10" data-line-number="10"></a>
<a class="sourceLine" id="cb18-11" data-line-number="11"><span class="co"># custom preprocess function</span></a>
<a class="sourceLine" id="cb18-12" data-line-number="12">prep_funs &lt;-<span class="st"> </span><span class="cf">function</span>(data) {</a>
<a class="sourceLine" id="cb18-13" data-line-number="13">  </a>
<a class="sourceLine" id="cb18-14" data-line-number="14">  <span class="co"># preprocess</span></a>
<a class="sourceLine" id="cb18-15" data-line-number="15">  newdata &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/recipes/topics/bake">bake</a></span>(</a>
<a class="sourceLine" id="cb18-16" data-line-number="16">    <span class="dt">object =</span> recipe_obj,</a>
<a class="sourceLine" id="cb18-17" data-line-number="17">    <span class="dt">new_data =</span> data</a>
<a class="sourceLine" id="cb18-18" data-line-number="18">  )</a>
<a class="sourceLine" id="cb18-19" data-line-number="19">  </a>
<a class="sourceLine" id="cb18-20" data-line-number="20">  <span class="co"># return the processed data</span></a>
<a class="sourceLine" id="cb18-21" data-line-number="21">  <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/function">return</a></span>(newdata)</a>
<a class="sourceLine" id="cb18-22" data-line-number="22">  </a>
<a class="sourceLine" id="cb18-23" data-line-number="23">}</a></code></pre></div>
<p>Finally, we could start to make generators for the train and validation data:</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb19-1" data-line-number="1"><span class="co"># import libs</span></a>
<a class="sourceLine" id="cb19-2" data-line-number="2"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(kerasgenerator)</a>
<a class="sourceLine" id="cb19-3" data-line-number="3"></a>
<a class="sourceLine" id="cb19-4" data-line-number="4"><span class="co"># data generator</span></a>
<a class="sourceLine" id="cb19-5" data-line-number="5">train_gen &lt;-<span class="st"> </span><span class="kw"><a href="../reference/series_generator.html">series_generator</a></span>(</a>
<a class="sourceLine" id="cb19-6" data-line-number="6">  <span class="dt">data =</span> traffic_tbl,</a>
<a class="sourceLine" id="cb19-7" data-line-number="7">  <span class="dt">y =</span> y,</a>
<a class="sourceLine" id="cb19-8" data-line-number="8">  <span class="dt">x =</span> x,</a>
<a class="sourceLine" id="cb19-9" data-line-number="9">  <span class="dt">lookback =</span> lookback,</a>
<a class="sourceLine" id="cb19-10" data-line-number="10">  <span class="dt">timesteps =</span> timesteps,</a>
<a class="sourceLine" id="cb19-11" data-line-number="11">  <span class="dt">start_index =</span> train_start,</a>
<a class="sourceLine" id="cb19-12" data-line-number="12">  <span class="dt">end_index =</span> train_end,</a>
<a class="sourceLine" id="cb19-13" data-line-number="13">  <span class="dt">batch_size =</span> batch_size,</a>
<a class="sourceLine" id="cb19-14" data-line-number="14">  <span class="dt">return_target =</span> <span class="ot">TRUE</span>,</a>
<a class="sourceLine" id="cb19-15" data-line-number="15">  <span class="dt">prep_funs =</span> prep_funs</a>
<a class="sourceLine" id="cb19-16" data-line-number="16">)</a>
<a class="sourceLine" id="cb19-17" data-line-number="17"></a>
<a class="sourceLine" id="cb19-18" data-line-number="18">val_gen &lt;-<span class="st"> </span><span class="kw"><a href="../reference/series_generator.html">series_generator</a></span>(</a>
<a class="sourceLine" id="cb19-19" data-line-number="19">  <span class="dt">data =</span> traffic_tbl,</a>
<a class="sourceLine" id="cb19-20" data-line-number="20">  <span class="dt">y =</span> y,</a>
<a class="sourceLine" id="cb19-21" data-line-number="21">  <span class="dt">x =</span> x,</a>
<a class="sourceLine" id="cb19-22" data-line-number="22">  <span class="dt">lookback =</span> lookback,</a>
<a class="sourceLine" id="cb19-23" data-line-number="23">  <span class="dt">timesteps =</span> timesteps,</a>
<a class="sourceLine" id="cb19-24" data-line-number="24">  <span class="dt">start_index =</span> val_start,</a>
<a class="sourceLine" id="cb19-25" data-line-number="25">  <span class="dt">end_index =</span> val_end,</a>
<a class="sourceLine" id="cb19-26" data-line-number="26">  <span class="dt">batch_size =</span> batch_size,</a>
<a class="sourceLine" id="cb19-27" data-line-number="27">  <span class="dt">return_target =</span> <span class="ot">TRUE</span>,</a>
<a class="sourceLine" id="cb19-28" data-line-number="28">  <span class="dt">prep_funs =</span> prep_funs</a>
<a class="sourceLine" id="cb19-29" data-line-number="29">)</a></code></pre></div>
<p>Let’s see how the generators work with Keras’ model. First, let’s define our time series Keras model:</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb20-1" data-line-number="1"><span class="co"># import libs</span></a>
<a class="sourceLine" id="cb20-2" data-line-number="2"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(keras)</a>
<a class="sourceLine" id="cb20-3" data-line-number="3"></a>
<a class="sourceLine" id="cb20-4" data-line-number="4"><span class="co"># initiate a sequential model</span></a>
<a class="sourceLine" id="cb20-5" data-line-number="5">model &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/keras/topics/keras_model_sequential">keras_model_sequential</a></span>()</a>
<a class="sourceLine" id="cb20-6" data-line-number="6"></a>
<a class="sourceLine" id="cb20-7" data-line-number="7"><span class="co"># define the model</span></a>
<a class="sourceLine" id="cb20-8" data-line-number="8">model <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb20-9" data-line-number="9"><span class="st">  </span></a>
<a class="sourceLine" id="cb20-10" data-line-number="10"><span class="st">  </span><span class="co"># layer lstm</span></a>
<a class="sourceLine" id="cb20-11" data-line-number="11"><span class="st">  </span><span class="kw"><a href="https://www.rdocumentation.org/packages/keras/topics/layer_lstm">layer_lstm</a></span>(</a>
<a class="sourceLine" id="cb20-12" data-line-number="12">    <span class="dt">name =</span> <span class="st">"lstm1"</span>,</a>
<a class="sourceLine" id="cb20-13" data-line-number="13">    <span class="dt">input_shape =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(timesteps, <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/length">length</a></span>(x)),</a>
<a class="sourceLine" id="cb20-14" data-line-number="14">    <span class="dt">units =</span> <span class="dv">128</span>,</a>
<a class="sourceLine" id="cb20-15" data-line-number="15">    <span class="dt">dropout =</span> <span class="fl">0.1</span>,</a>
<a class="sourceLine" id="cb20-16" data-line-number="16">    <span class="dt">recurrent_dropout =</span> <span class="fl">0.2</span>,</a>
<a class="sourceLine" id="cb20-17" data-line-number="17">    <span class="dt">return_sequences =</span> <span class="ot">TRUE</span></a>
<a class="sourceLine" id="cb20-18" data-line-number="18">  ) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb20-19" data-line-number="19"><span class="st">  </span></a>
<a class="sourceLine" id="cb20-20" data-line-number="20"><span class="st">  </span><span class="kw"><a href="https://www.rdocumentation.org/packages/keras/topics/layer_lstm">layer_lstm</a></span>(</a>
<a class="sourceLine" id="cb20-21" data-line-number="21">    <span class="dt">name =</span> <span class="st">"lstm2"</span>,</a>
<a class="sourceLine" id="cb20-22" data-line-number="22">    <span class="dt">units =</span> <span class="dv">64</span>,</a>
<a class="sourceLine" id="cb20-23" data-line-number="23">    <span class="dt">dropout =</span> <span class="fl">0.1</span>,</a>
<a class="sourceLine" id="cb20-24" data-line-number="24">    <span class="dt">recurrent_dropout =</span> <span class="fl">0.2</span>,</a>
<a class="sourceLine" id="cb20-25" data-line-number="25">    <span class="dt">return_sequences =</span> <span class="ot">TRUE</span></a>
<a class="sourceLine" id="cb20-26" data-line-number="26">  ) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb20-27" data-line-number="27"><span class="st">  </span></a>
<a class="sourceLine" id="cb20-28" data-line-number="28"><span class="st">  </span><span class="kw"><a href="https://www.rdocumentation.org/packages/keras/topics/layer_lstm">layer_lstm</a></span>(</a>
<a class="sourceLine" id="cb20-29" data-line-number="29">    <span class="dt">name =</span> <span class="st">"lstm3"</span>,</a>
<a class="sourceLine" id="cb20-30" data-line-number="30">    <span class="dt">units =</span> <span class="dv">32</span>,</a>
<a class="sourceLine" id="cb20-31" data-line-number="31">    <span class="dt">dropout =</span> <span class="fl">0.1</span>,</a>
<a class="sourceLine" id="cb20-32" data-line-number="32">    <span class="dt">recurrent_dropout =</span> <span class="fl">0.2</span>,</a>
<a class="sourceLine" id="cb20-33" data-line-number="33">    <span class="dt">return_sequences =</span> <span class="ot">FALSE</span></a>
<a class="sourceLine" id="cb20-34" data-line-number="34">  ) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb20-35" data-line-number="35"><span class="st">  </span></a>
<a class="sourceLine" id="cb20-36" data-line-number="36"><span class="st">  </span><span class="co"># layer output</span></a>
<a class="sourceLine" id="cb20-37" data-line-number="37"><span class="st">  </span><span class="kw"><a href="https://www.rdocumentation.org/packages/keras/topics/layer_dense">layer_dense</a></span>(</a>
<a class="sourceLine" id="cb20-38" data-line-number="38">    <span class="dt">name =</span> <span class="st">"output"</span>,</a>
<a class="sourceLine" id="cb20-39" data-line-number="39">    <span class="dt">units =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/length">length</a></span>(y)</a>
<a class="sourceLine" id="cb20-40" data-line-number="40">  )</a>
<a class="sourceLine" id="cb20-41" data-line-number="41"></a>
<a class="sourceLine" id="cb20-42" data-line-number="42"><span class="co"># compile the model</span></a>
<a class="sourceLine" id="cb20-43" data-line-number="43">model <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/keras/topics/reexports">compile</a></span>(</a>
<a class="sourceLine" id="cb20-44" data-line-number="44">  <span class="dt">optimizer =</span> <span class="st">"rmsprop"</span>,</a>
<a class="sourceLine" id="cb20-45" data-line-number="45">  <span class="dt">loss =</span> <span class="st">"mse"</span></a>
<a class="sourceLine" id="cb20-46" data-line-number="46">)</a>
<a class="sourceLine" id="cb20-47" data-line-number="47"></a>
<a class="sourceLine" id="cb20-48" data-line-number="48"><span class="co"># model summary</span></a>
<a class="sourceLine" id="cb20-49" data-line-number="49"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/summary">summary</a></span>(model)</a></code></pre></div>
<pre><code>## ___________________________________________________________________________
## Layer (type)                     Output Shape                  Param #     
## ===========================================================================
## lstm1 (LSTM)                     (None, 12, 128)               66560       
## ___________________________________________________________________________
## lstm2 (LSTM)                     (None, 12, 64)                49408       
## ___________________________________________________________________________
## lstm3 (LSTM)                     (None, 32)                    12416       
## ___________________________________________________________________________
## output (Dense)                   (None, 1)                     33          
## ===========================================================================
## Total params: 128,417
## Trainable params: 128,417
## Non-trainable params: 0
## ___________________________________________________________________________</code></pre>
<p>Since we use a data generator, use <a href="(https://keras.rstudio.com/reference/fit_generator.html)"><code><a href="https://www.rdocumentation.org/packages/keras/topics/fit_generator">fit_generator()</a></code></a> function to fit the model:</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb22-1" data-line-number="1"><span class="co"># set number of epochs</span></a>
<a class="sourceLine" id="cb22-2" data-line-number="2">epochs &lt;-<span class="st"> </span><span class="dv">30</span></a>
<a class="sourceLine" id="cb22-3" data-line-number="3"></a>
<a class="sourceLine" id="cb22-4" data-line-number="4"><span class="co"># model fitting</span></a>
<a class="sourceLine" id="cb22-5" data-line-number="5">history &lt;-<span class="st"> </span>model <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/keras/topics/fit_generator">fit_generator</a></span>(</a>
<a class="sourceLine" id="cb22-6" data-line-number="6">  <span class="dt">generator =</span> train_gen,</a>
<a class="sourceLine" id="cb22-7" data-line-number="7">  <span class="dt">steps_per_epoch =</span> train_steps,</a>
<a class="sourceLine" id="cb22-8" data-line-number="8">  <span class="dt">validation_data =</span> val_gen,</a>
<a class="sourceLine" id="cb22-9" data-line-number="9">  <span class="dt">validation_steps =</span> val_steps,</a>
<a class="sourceLine" id="cb22-10" data-line-number="10">  <span class="dt">epochs =</span> epochs</a>
<a class="sourceLine" id="cb22-11" data-line-number="11">)</a>
<a class="sourceLine" id="cb22-12" data-line-number="12"></a>
<a class="sourceLine" id="cb22-13" data-line-number="13"><span class="co"># history plot</span></a>
<a class="sourceLine" id="cb22-14" data-line-number="14"><span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/plot">plot</a></span>(history)</a></code></pre></div>
<p><img src="timeseries_files/figure-html/unnamed-chunk-14-1.png" width="100%" style="display: block; margin: auto;"></p>
<p>You can also pass the generator to <a href="(https://keras.rstudio.com/reference/evaluate_generator.html)"><code><a href="https://www.rdocumentation.org/packages/keras/topics/evaluate_generator">evaluate_generator()</a></code></a> to evaluate the results. Let’s try to evaluate on the test dataset:</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb23-1" data-line-number="1"><span class="co"># test data generator</span></a>
<a class="sourceLine" id="cb23-2" data-line-number="2">test_gen &lt;-<span class="st"> </span><span class="kw"><a href="../reference/series_generator.html">series_generator</a></span>(</a>
<a class="sourceLine" id="cb23-3" data-line-number="3">  <span class="dt">data =</span> traffic_tbl,</a>
<a class="sourceLine" id="cb23-4" data-line-number="4">  <span class="dt">y =</span> y,</a>
<a class="sourceLine" id="cb23-5" data-line-number="5">  <span class="dt">x =</span> x,</a>
<a class="sourceLine" id="cb23-6" data-line-number="6">  <span class="dt">lookback =</span> lookback,</a>
<a class="sourceLine" id="cb23-7" data-line-number="7">  <span class="dt">timesteps =</span> timesteps,</a>
<a class="sourceLine" id="cb23-8" data-line-number="8">  <span class="dt">start_index =</span> test_start,</a>
<a class="sourceLine" id="cb23-9" data-line-number="9">  <span class="dt">end_index =</span> test_end,</a>
<a class="sourceLine" id="cb23-10" data-line-number="10">  <span class="dt">batch_size =</span> batch_size,</a>
<a class="sourceLine" id="cb23-11" data-line-number="11">  <span class="dt">return_target =</span> <span class="ot">TRUE</span>,</a>
<a class="sourceLine" id="cb23-12" data-line-number="12">  <span class="dt">prep_funs =</span> prep_funs</a>
<a class="sourceLine" id="cb23-13" data-line-number="13">)</a>
<a class="sourceLine" id="cb23-14" data-line-number="14"></a>
<a class="sourceLine" id="cb23-15" data-line-number="15"><span class="co"># evaluate on test dataset</span></a>
<a class="sourceLine" id="cb23-16" data-line-number="16">model <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/keras/topics/evaluate_generator">evaluate_generator</a></span>(</a>
<a class="sourceLine" id="cb23-17" data-line-number="17">  <span class="dt">generator =</span> test_gen,</a>
<a class="sourceLine" id="cb23-18" data-line-number="18">  <span class="dt">steps =</span> test_steps</a>
<a class="sourceLine" id="cb23-19" data-line-number="19">)</a></code></pre></div>
<pre><code>##       loss 
## 0.04472111</code></pre>
</div>
<div id="forecast" class="section level1">
<h1 class="hasAnchor">
<a href="#forecast" class="anchor"></a>Forecasting using Data Generator</h1>
<p>Like in <a href="/reference/series_generator"><code><a href="../reference/series_generator.html">series_generator()</a></code></a> function, we need to specify some parameters for <a href="/reference/forecast_generator"><code><a href="../reference/forecast_generator.html">forecast_generator()</a></code></a>:</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb25-1" data-line-number="1"><span class="co"># forecast horizon</span></a>
<a class="sourceLine" id="cb25-2" data-line-number="2">horizon &lt;-<span class="st"> </span><span class="dv">12</span></a>
<a class="sourceLine" id="cb25-3" data-line-number="3"></a>
<a class="sourceLine" id="cb25-4" data-line-number="4"><span class="co"># forecast indices</span></a>
<a class="sourceLine" id="cb25-5" data-line-number="5">last_index &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/nrow">nrow</a></span>(traffic_tbl)</a>
<a class="sourceLine" id="cb25-6" data-line-number="6"></a>
<a class="sourceLine" id="cb25-7" data-line-number="7"><span class="co"># number of steps to see full data</span></a>
<a class="sourceLine" id="cb25-8" data-line-number="8">fcast_steps &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Round">ceiling</a></span>(horizon <span class="op">/</span><span class="st"> </span>batch_size)</a></code></pre></div>
<p><strong>Note that the forecast <code>horizon</code> should not be greater than the value of <code>lookback</code> if you want to forecast from the last observation</strong>.</p>
<p>Then, we can proceed to define the generator for forecasting and pass it to <a href="(https://keras.rstudio.com/reference/predict_generator.html)"><code><a href="https://www.rdocumentation.org/packages/keras/topics/predict_generator">predict_generator()</a></code></a> function.</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb26-1" data-line-number="1"><span class="co"># forecast generator</span></a>
<a class="sourceLine" id="cb26-2" data-line-number="2">fcast_gen &lt;-<span class="st"> </span><span class="kw"><a href="../reference/forecast_generator.html">forecast_generator</a></span>(</a>
<a class="sourceLine" id="cb26-3" data-line-number="3">  <span class="dt">data =</span> traffic_tbl,</a>
<a class="sourceLine" id="cb26-4" data-line-number="4">  <span class="dt">x =</span> x,</a>
<a class="sourceLine" id="cb26-5" data-line-number="5">  <span class="dt">lookback =</span> lookback,</a>
<a class="sourceLine" id="cb26-6" data-line-number="6">  <span class="dt">timesteps =</span> timesteps,</a>
<a class="sourceLine" id="cb26-7" data-line-number="7">  <span class="dt">last_index =</span> last_index,</a>
<a class="sourceLine" id="cb26-8" data-line-number="8">  <span class="dt">horizon =</span> horizon,</a>
<a class="sourceLine" id="cb26-9" data-line-number="9">  <span class="dt">batch_size =</span> batch_size,</a>
<a class="sourceLine" id="cb26-10" data-line-number="10">  <span class="dt">prep_funs =</span> prep_funs</a>
<a class="sourceLine" id="cb26-11" data-line-number="11">)</a>
<a class="sourceLine" id="cb26-12" data-line-number="12"></a>
<a class="sourceLine" id="cb26-13" data-line-number="13"><span class="co"># forecast using generator</span></a>
<a class="sourceLine" id="cb26-14" data-line-number="14">fcast &lt;-<span class="st"> </span>model <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/keras/topics/predict_generator">predict_generator</a></span>(</a>
<a class="sourceLine" id="cb26-15" data-line-number="15">  <span class="dt">generator =</span> fcast_gen,</a>
<a class="sourceLine" id="cb26-16" data-line-number="16">  <span class="dt">steps =</span> fcast_steps</a>
<a class="sourceLine" id="cb26-17" data-line-number="17">)</a>
<a class="sourceLine" id="cb26-18" data-line-number="18"></a>
<a class="sourceLine" id="cb26-19" data-line-number="19"><span class="co"># check the content</span></a>
<a class="sourceLine" id="cb26-20" data-line-number="20"><span class="kw"><a href="https://www.rdocumentation.org/packages/utils/topics/str">str</a></span>(fcast)</a></code></pre></div>
<pre><code>##  num [1:12, 1] 1.39 1.43 1.49 1.52 1.5 ...</code></pre>
<p><strong>BONUS:</strong> you can reconvert the forecast output like this</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb28-1" data-line-number="1"><span class="co"># import libs</span></a>
<a class="sourceLine" id="cb28-2" data-line-number="2"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(timetk)</a>
<a class="sourceLine" id="cb28-3" data-line-number="3"></a>
<a class="sourceLine" id="cb28-4" data-line-number="4"><span class="co"># make future time series index</span></a>
<a class="sourceLine" id="cb28-5" data-line-number="5">fcast_index &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/timetk/topics/tk_make_future_timeseries">tk_make_future_timeseries</a></span>(</a>
<a class="sourceLine" id="cb28-6" data-line-number="6">  <span class="dt">idx =</span> traffic_tbl<span class="op">$</span>datetime,</a>
<a class="sourceLine" id="cb28-7" data-line-number="7">  <span class="dt">n_future =</span> horizon</a>
<a class="sourceLine" id="cb28-8" data-line-number="8">)</a>
<a class="sourceLine" id="cb28-9" data-line-number="9"></a>
<a class="sourceLine" id="cb28-10" data-line-number="10"><span class="co"># get recipe values for revert back</span></a>
<a class="sourceLine" id="cb28-11" data-line-number="11">recipe_center &lt;-<span class="st"> </span>recipe_obj<span class="op">$</span>steps[[<span class="dv">2</span>]]<span class="op">$</span>means[<span class="st">"traffic"</span>]</a>
<a class="sourceLine" id="cb28-12" data-line-number="12">recipe_scale &lt;-<span class="st"> </span>recipe_obj<span class="op">$</span>steps[[<span class="dv">3</span>]]<span class="op">$</span>sds[<span class="st">"traffic"</span>]</a>
<a class="sourceLine" id="cb28-13" data-line-number="13"></a>
<a class="sourceLine" id="cb28-14" data-line-number="14"><span class="co"># check the forecast output</span></a>
<a class="sourceLine" id="cb28-15" data-line-number="15">fcast <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb28-16" data-line-number="16"><span class="st">  </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/as.data.frame">as.data.frame</a></span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb28-17" data-line-number="17"><span class="st">  </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/setNames">setNames</a></span>(<span class="st">"traffic"</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb28-18" data-line-number="18"><span class="st">  </span><span class="kw">mutate</span>(</a>
<a class="sourceLine" id="cb28-19" data-line-number="19">    <span class="dt">datetime =</span> fcast_index,</a>
<a class="sourceLine" id="cb28-20" data-line-number="20">    <span class="dt">traffic =</span> (traffic <span class="op">*</span><span class="st"> </span>recipe_scale <span class="op">+</span><span class="st"> </span>recipe_center) <span class="op">^</span><span class="st"> </span><span class="dv">2</span></a>
<a class="sourceLine" id="cb28-21" data-line-number="21">  ) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb28-22" data-line-number="22"><span class="st">  </span><span class="kw">select</span>(datetime, traffic) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb28-23" data-line-number="23"><span class="st">  </span><span class="kw"><a href="https://www.rdocumentation.org/packages/utils/topics/head">head</a></span>()</a></code></pre></div>
<pre><code>##              datetime    traffic
## 1 2005-07-28 14:00:00 6870224535
## 2 2005-07-28 14:05:00 6997586948
## 3 2005-07-28 14:10:00 7167291333
## 4 2005-07-28 14:15:00 7257118442
## 5 2005-07-28 14:20:00 7205969106
## 6 2005-07-28 14:25:00 7113351632</code></pre>
</div>
<div id="reference" class="section level1 unnumbered">
<h1 class="hasAnchor">
<a href="#reference" class="anchor"></a>References</h1>
<div id="refs" class="references">
<div id="ref-chollet2017time">
<p>Chollet, F., &amp; Allaire, J. (2017). TensorFlow for r: Time series forecasting with recurrent neural networks. Retrieved from <a href="https://blogs.rstudio.com/tensorflow/posts/2017-12-20-time-series-forecasting-with-recurrent-neural-networks/" class="uri">https://blogs.rstudio.com/tensorflow/posts/2017-12-20-time-series-forecasting-with-recurrent-neural-networks/</a></p>
</div>
<div id="ref-dancho2018predicting">
<p>Dancho, M., &amp; Keydana, S. (2018). TensorFlow for r: Predicting sunspot frequency with keras. Retrieved from <a href="https://blogs.rstudio.com/tensorflow/posts/2018-06-25-sunspots-lstm/" class="uri">https://blogs.rstudio.com/tensorflow/posts/2018-06-25-sunspots-lstm/</a></p>
</div>
<div id="ref-hochreiter1997long">
<p>Hochreiter, S., &amp; Schmidhuber, J. (1997). Long short-term memory. <em>Neural Computation</em>, <em>9</em>(8), 1735–1780.</p>
</div>
<div id="ref-hyndman2019time">
<p>Hyndman, R. J. (2019). Time series data library. Retrieved from <a href="https://datamarket.com/data/list/?q=provider:tsdl" class="uri">https://datamarket.com/data/list/?q=provider:tsdl</a></p>
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#introduction">Understanding the Time Series Array Shape</a></li>
      <li><a href="#fitting">Fitting a Time Series Model</a></li>
      <li><a href="#forecast">Forecasting using Data Generator</a></li>
      <li><a href="#reference">References</a></li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by <a href="https://bagasbgy.netlify.com">R. Dimas Bagas Herlambang</a>.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.3.0.9000.</p>
</div>
      </footer>
</div>

  

  </body>
</html>
