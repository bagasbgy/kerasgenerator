<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Data Generator for Supervised Time Series using Keras • kerasgenerator</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha256-916EbMg70RQy9LHiGkXzG8hSg9EdNy97GazNG/aiY1w=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/all.min.css" integrity="sha256-nAmazAk6vS34Xqo0BSrTb+abbtFlgsFK7NKSi6o7Y78=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/v4-shims.min.css" integrity="sha256-6qHlizsOWFskGlwVOKuns+D1nB6ssZrHQrNj1wGplHc=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/headroom.min.js" integrity="sha256-DJFC1kqIhelURkuza0AvYal5RxMtpzLjFhsnVIeuk+U=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<meta property="og:title" content="Data Generator for Supervised Time Series using Keras">
<meta property="og:description" content="">
<meta property="og:image" content="/logo.png">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">kerasgenerator</a>
        <span class="version label label-danger" data-toggle="tooltip" data-placement="bottom" title="Unreleased version">0.0.0.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/timeseries.html">Data Generator for Supervised Time Series using Keras</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Data Generator for Supervised Time Series using Keras</h1>
                        <h4 class="author">R. Dimas Bagas Herlambang</h4>
            
            <h4 class="date">September 24, 2019</h4>
      
      
      <div class="hidden name"><code>timeseries.Rmd</code></div>

    </div>

    
    
<div id="introduction" class="section level2">
<h2 class="hasAnchor">
<a href="#introduction" class="anchor"></a>Introduction</h2>
<p>Time series and forecasting using Deep Learning approach is gaining more popularity recently. From classic Recurrent Neural Network (RNN) implementation, like Long Short-Term Memory <span class="citation">(Hochreiter &amp; Schmidhuber, <a href="#ref-hochreiter_long_1997">1997</a>)</span> which adopted by some big names like Uber <span class="citation">(Laptev, Smyl, &amp; Shanmugam, <a href="#ref-laptev_engineering_2017">2017</a>)</span>, to some unorthodox approach like WaveNet <span class="citation">(Oord &amp; Dieleman, <a href="#ref-van_den_oord_wavenet_2016">2016</a>)</span>; all of these huge breakthrough show us that Deep Learning approaches are very promising. Yet, the supervised time series data generator is still getting less attention, and many available resources don’t have a clear consensus regarding the standard.</p>
<p>To address this issue, <code>kerasgenerator</code> provide; <code><a href="../reference/flow_series_from_dataframe.html">flow_series_from_dataframe()</a></code> function to helps us understand the data generation process for supervised time series problems. In this article, we will going through some basic supervised time series parameters, which also complemented with an univariate time series data as an example.</p>
<p><strong>Note</strong> that, actually, there are several articles that already addressing similar examples; and highly recommended to read! Some of those articles are including Chollet and Allaire <span class="citation">(<a href="#ref-chollet_tensorflow_2017">2017</a>)</span>, and Dancho and Keydana <span class="citation">(<a href="#ref-dancho_tensorflow_2018">2018</a>)</span>. Thus, this article is intended to help us understand more the data generation process through visualizations and animations, which inline with the parameters that would be used inside the <code><a href="../reference/flow_series_from_dataframe.html">flow_series_from_dataframe()</a></code> funciton.</p>
<div id="libraries-used" class="section level3">
<h3 class="hasAnchor">
<a href="#libraries-used" class="anchor"></a>Libraries used</h3>
<p>For this example, we will going through some implementation example. For this example, we will use several libraries:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="co"># import libs</span></a>
<a class="sourceLine" id="cb1-2" data-line-number="2"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(keras)</a>
<a class="sourceLine" id="cb1-3" data-line-number="3"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(kerasgenerator)</a>
<a class="sourceLine" id="cb1-4" data-line-number="4"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(lubridate)</a>
<a class="sourceLine" id="cb1-5" data-line-number="5"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(tidymodels)</a>
<a class="sourceLine" id="cb1-6" data-line-number="6"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(tidyverse)</a></code></pre></div>
</div>
<div id="example-problems" class="section level3">
<h3 class="hasAnchor">
<a href="#example-problems" class="anchor"></a>Example problems</h3>
<p>In this article, we will use <strong><code>AirPassengers</code></strong> dataset, which already available in base R installation. This dataset represent an univariate monthly time series and very suitable for basic example: <strong>“Can we predict the number of international airline passengers based on its historical data?”</strong></p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" data-line-number="1"><span class="co"># example data</span></a>
<a class="sourceLine" id="cb2-2" data-line-number="2">airpassenger_df &lt;-<span class="st"> </span><span class="kw">as_tibble</span>(AirPassengers) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb2-3" data-line-number="3"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">date =</span> <span class="kw"><a href="https://rdrr.io/r/base/seq.Date.html">seq.Date</a></span>(<span class="kw"><a href="http://lubridate.tidyverse.org/reference/ymd.html">ymd</a></span>(<span class="st">"1949-01-01"</span>), <span class="dt">by =</span> <span class="st">"1 month"</span>, <span class="dt">length.out =</span> <span class="kw"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(.))) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb2-4" data-line-number="4"><span class="st">  </span><span class="kw">select</span>(date, <span class="dt">passenger =</span> x)</a>
<a class="sourceLine" id="cb2-5" data-line-number="5"></a>
<a class="sourceLine" id="cb2-6" data-line-number="6"><span class="co"># quick check</span></a>
<a class="sourceLine" id="cb2-7" data-line-number="7"><span class="kw">ggplot</span>(airpassenger_df, <span class="kw">aes</span>(<span class="dt">x =</span> date, <span class="dt">y =</span> passenger)) <span class="op">+</span></a>
<a class="sourceLine" id="cb2-8" data-line-number="8"><span class="st">  </span><span class="kw">geom_line</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb2-9" data-line-number="9"><span class="st">  </span><span class="kw">labs</span>(<span class="dt">title =</span> <span class="st">"Number of international airline passengers"</span>, <span class="dt">x =</span> <span class="ot">NULL</span>, <span class="dt">y =</span> <span class="ot">NULL</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb2-10" data-line-number="10"><span class="st">  </span><span class="kw">theme_minimal</span>()</a></code></pre></div>
<p><img src="timeseries_files/figure-html/unnamed-chunk-1-1.png" width="85%" style="display: block; margin: auto;"></p>
</div>
<div id="supervised-time-series" class="section level3">
<h3 class="hasAnchor">
<a href="#supervised-time-series" class="anchor"></a>Supervised time series</h3>
<p>There are a slight differences between our “usual” time series and supervised time series approach. In classical time series models, we are seeking the best fit to the supplied time series, then make those fitted model to create a forecast. For supervised time series, we are going to make a model through supervised approach: <strong>given a set of <code>x</code> values, can we predict the <code>y</code> value(s)?</strong> So instead of just giving the time series, we should also define the <code>x</code>s as our past values, and <code>y</code>s as our future values from the specified time series.</p>
<p>Let’s start by the <code>x</code>s. The <code>x</code> values are intended to be our predictors. Generally speaking, like in every supervised problem, the <code>x</code>s could be from one variable–as in univariate time series problems–or from multiple variables–as in multivariate time series problems.</p>
<p>However, there are some important parameters that we need to set to make our <code>x</code>s represent a proper predictor in our supervised time series problems. These parameters are <code>lookback</code> and <code>timesteps</code>:</p>
<ul>
<li>
<strong><code>lookback</code></strong>: How much we should lookback for our last <code>x</code> value to predict the <code>y</code>?</li>
<li>
<strong><code>timesteps</code></strong>: How many <code>x</code> we will consider to predict the <code>y</code>?</li>
</ul>
<p>To put it simply, let’s say for our monthly <code>airpassenger_df</code> data we want to predict the value of <code>passenger</code> in January 1951 using last 24 historical data–January 1949 to December 1950–then we will use <code>lookback = 1</code> and <code>timesteps = 24</code>. For another example, we want to predict the value in January 1951 using only the data from January 1950–the exact same month but in the previous year–then we will use <code>lookback = 12</code> and <code>timesteps = 1</code>.</p>
<p>We will see some example animation for these settings, but we need to understand the parameters regarding our <code>y</code> values first. In supervised time series, the <code>y</code> parameters could help us determine the forecast horizon, as in <code>h</code> parameter inside <a href="http://pkg.robjhyndman.com/forecast/reference/forecast.html"><code>forecast()</code></a> function. These parameters are <code>length_out</code> and <code>stride</code>:</p>
<ul>
<li>
<strong><code>length_out</code></strong>: How many time ahead that we will predict?</li>
<li>
<strong><code>stride</code></strong>: How much is the sampling rate between consecutive <code>y</code> values?</li>
</ul>
<p>Finally, to helps us understand, we will going through several type of supervised time series problems in the following sections.</p>
<div id="many-to-one" class="section level4">
<h4 class="hasAnchor">
<a href="#many-to-one" class="anchor"></a>Many-to-one</h4>
<!-- in development -->
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" data-line-number="1"><span class="co"># an example generator settings: many-to-one with stride = 1</span></a>
<a class="sourceLine" id="cb3-2" data-line-number="2">x &lt;-<span class="st"> "passenger"</span></a>
<a class="sourceLine" id="cb3-3" data-line-number="3">y &lt;-<span class="st"> "passenger"</span></a>
<a class="sourceLine" id="cb3-4" data-line-number="4">length_out &lt;-<span class="st"> </span><span class="dv">1</span></a>
<a class="sourceLine" id="cb3-5" data-line-number="5">stride &lt;-<span class="st"> </span><span class="dv">1</span></a>
<a class="sourceLine" id="cb3-6" data-line-number="6">lookback &lt;-<span class="st"> </span><span class="dv">1</span></a>
<a class="sourceLine" id="cb3-7" data-line-number="7">timesteps &lt;-<span class="st"> </span><span class="dv">24</span></a>
<a class="sourceLine" id="cb3-8" data-line-number="8">batch_size &lt;-<span class="st"> </span><span class="dv">12</span></a>
<a class="sourceLine" id="cb3-9" data-line-number="9"></a>
<a class="sourceLine" id="cb3-10" data-line-number="10"><span class="co"># an example generator: many-to-one</span></a>
<a class="sourceLine" id="cb3-11" data-line-number="11">data_gen &lt;-<span class="st"> </span><span class="kw"><a href="../reference/flow_series_from_dataframe.html">flow_series_from_dataframe</a></span>(</a>
<a class="sourceLine" id="cb3-12" data-line-number="12">  <span class="dt">data =</span> airpassenger_df,</a>
<a class="sourceLine" id="cb3-13" data-line-number="13">  <span class="dt">x =</span> x,</a>
<a class="sourceLine" id="cb3-14" data-line-number="14">  <span class="dt">y =</span> y,</a>
<a class="sourceLine" id="cb3-15" data-line-number="15">  <span class="dt">length_out =</span> length_out,</a>
<a class="sourceLine" id="cb3-16" data-line-number="16">  <span class="dt">stride =</span> stride,</a>
<a class="sourceLine" id="cb3-17" data-line-number="17">  <span class="dt">lookback =</span> lookback,</a>
<a class="sourceLine" id="cb3-18" data-line-number="18">  <span class="dt">timesteps =</span> timesteps,</a>
<a class="sourceLine" id="cb3-19" data-line-number="19">  <span class="dt">batch_size =</span> batch_size,</a>
<a class="sourceLine" id="cb3-20" data-line-number="20">  <span class="dt">mode =</span> <span class="st">"training"</span></a>
<a class="sourceLine" id="cb3-21" data-line-number="21">)</a>
<a class="sourceLine" id="cb3-22" data-line-number="22"></a>
<a class="sourceLine" id="cb3-23" data-line-number="23"><span class="co"># quick check</span></a>
<a class="sourceLine" id="cb3-24" data-line-number="24"><span class="kw"><a href="https://rdrr.io/r/utils/str.html">str</a></span>(<span class="kw">data_gen</span>())</a>
<a class="sourceLine" id="cb3-25" data-line-number="25"><span class="co">#&gt; List of 2</span></a>
<a class="sourceLine" id="cb3-26" data-line-number="26"><span class="co">#&gt;  $ : num [1:12, 1:24, 1] 112 118 132 129 121 135 148 148 136 119 ...</span></a>
<a class="sourceLine" id="cb3-27" data-line-number="27"><span class="co">#&gt;  $ : num [1:12, 1, 1] 145 150 178 163 172 178 199 199 184 162 ...</span></a></code></pre></div>
<!-- in development -->
<p><img src="timeseries_files/figure-html/unnamed-chunk-3-1.gif" width="85%" style="display: block; margin: auto;"></p>
<!-- in development -->
</div>
<div id="many-to-many" class="section level4">
<h4 class="hasAnchor">
<a href="#many-to-many" class="anchor"></a>Many-to-many</h4>
<!-- in development -->
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" data-line-number="1"><span class="co"># an example generator settings: many-to-many with stride = 1</span></a>
<a class="sourceLine" id="cb4-2" data-line-number="2">x &lt;-<span class="st"> "passenger"</span></a>
<a class="sourceLine" id="cb4-3" data-line-number="3">y &lt;-<span class="st"> "passenger"</span></a>
<a class="sourceLine" id="cb4-4" data-line-number="4">length_out &lt;-<span class="st"> </span><span class="dv">12</span></a>
<a class="sourceLine" id="cb4-5" data-line-number="5">stride &lt;-<span class="st"> </span><span class="dv">1</span></a>
<a class="sourceLine" id="cb4-6" data-line-number="6">lookback &lt;-<span class="st"> </span><span class="dv">1</span></a>
<a class="sourceLine" id="cb4-7" data-line-number="7">timesteps &lt;-<span class="st"> </span><span class="dv">24</span></a>
<a class="sourceLine" id="cb4-8" data-line-number="8">batch_size &lt;-<span class="st"> </span><span class="dv">12</span></a>
<a class="sourceLine" id="cb4-9" data-line-number="9"></a>
<a class="sourceLine" id="cb4-10" data-line-number="10"><span class="co"># an example generator: many-to-many, stride = 1</span></a>
<a class="sourceLine" id="cb4-11" data-line-number="11">data_gen &lt;-<span class="st"> </span><span class="kw"><a href="../reference/flow_series_from_dataframe.html">flow_series_from_dataframe</a></span>(</a>
<a class="sourceLine" id="cb4-12" data-line-number="12">  <span class="dt">data =</span> airpassenger_df,</a>
<a class="sourceLine" id="cb4-13" data-line-number="13">  <span class="dt">x =</span> x,</a>
<a class="sourceLine" id="cb4-14" data-line-number="14">  <span class="dt">y =</span> y,</a>
<a class="sourceLine" id="cb4-15" data-line-number="15">  <span class="dt">length_out =</span> length_out,</a>
<a class="sourceLine" id="cb4-16" data-line-number="16">  <span class="dt">stride =</span> stride,</a>
<a class="sourceLine" id="cb4-17" data-line-number="17">  <span class="dt">lookback =</span> lookback,</a>
<a class="sourceLine" id="cb4-18" data-line-number="18">  <span class="dt">timesteps =</span> timesteps,</a>
<a class="sourceLine" id="cb4-19" data-line-number="19">  <span class="dt">batch_size =</span> batch_size,</a>
<a class="sourceLine" id="cb4-20" data-line-number="20">  <span class="dt">mode =</span> <span class="st">"training"</span></a>
<a class="sourceLine" id="cb4-21" data-line-number="21">)</a>
<a class="sourceLine" id="cb4-22" data-line-number="22"></a>
<a class="sourceLine" id="cb4-23" data-line-number="23"><span class="co"># quick check</span></a>
<a class="sourceLine" id="cb4-24" data-line-number="24"><span class="kw"><a href="https://rdrr.io/r/utils/str.html">str</a></span>(<span class="kw">data_gen</span>())</a>
<a class="sourceLine" id="cb4-25" data-line-number="25"><span class="co">#&gt; List of 2</span></a>
<a class="sourceLine" id="cb4-26" data-line-number="26"><span class="co">#&gt;  $ : num [1:12, 1:24, 1] 112 118 132 129 121 135 148 148 136 119 ...</span></a>
<a class="sourceLine" id="cb4-27" data-line-number="27"><span class="co">#&gt;  $ : num [1:12, 1:12, 1] 145 150 178 163 172 178 199 199 184 162 ...</span></a></code></pre></div>
<!-- in development -->
<p><img src="timeseries_files/figure-html/unnamed-chunk-5-1.gif" width="85%" style="display: block; margin: auto;"></p>
<!-- in development -->
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" data-line-number="1"><span class="co"># an example generator settings: many-to-many with stride = 12</span></a>
<a class="sourceLine" id="cb5-2" data-line-number="2">x &lt;-<span class="st"> "passenger"</span></a>
<a class="sourceLine" id="cb5-3" data-line-number="3">y &lt;-<span class="st"> "passenger"</span></a>
<a class="sourceLine" id="cb5-4" data-line-number="4">length_out &lt;-<span class="st"> </span><span class="dv">12</span></a>
<a class="sourceLine" id="cb5-5" data-line-number="5">stride &lt;-<span class="st"> </span><span class="dv">12</span></a>
<a class="sourceLine" id="cb5-6" data-line-number="6">lookback &lt;-<span class="st"> </span><span class="dv">1</span></a>
<a class="sourceLine" id="cb5-7" data-line-number="7">timesteps &lt;-<span class="st"> </span><span class="dv">24</span></a>
<a class="sourceLine" id="cb5-8" data-line-number="8">batch_size &lt;-<span class="st"> </span><span class="dv">2</span></a>
<a class="sourceLine" id="cb5-9" data-line-number="9"></a>
<a class="sourceLine" id="cb5-10" data-line-number="10"><span class="co"># an example generator: many-to-many, stride = 12</span></a>
<a class="sourceLine" id="cb5-11" data-line-number="11">data_gen &lt;-<span class="st"> </span><span class="kw"><a href="../reference/flow_series_from_dataframe.html">flow_series_from_dataframe</a></span>(</a>
<a class="sourceLine" id="cb5-12" data-line-number="12">  <span class="dt">data =</span> airpassenger_df,</a>
<a class="sourceLine" id="cb5-13" data-line-number="13">  <span class="dt">x =</span> x,</a>
<a class="sourceLine" id="cb5-14" data-line-number="14">  <span class="dt">y =</span> y,</a>
<a class="sourceLine" id="cb5-15" data-line-number="15">  <span class="dt">length_out =</span> length_out,</a>
<a class="sourceLine" id="cb5-16" data-line-number="16">  <span class="dt">stride =</span> stride,</a>
<a class="sourceLine" id="cb5-17" data-line-number="17">  <span class="dt">lookback =</span> lookback,</a>
<a class="sourceLine" id="cb5-18" data-line-number="18">  <span class="dt">timesteps =</span> timesteps,</a>
<a class="sourceLine" id="cb5-19" data-line-number="19">  <span class="dt">batch_size =</span> batch_size,</a>
<a class="sourceLine" id="cb5-20" data-line-number="20">  <span class="dt">mode =</span> <span class="st">"training"</span></a>
<a class="sourceLine" id="cb5-21" data-line-number="21">)</a>
<a class="sourceLine" id="cb5-22" data-line-number="22"></a>
<a class="sourceLine" id="cb5-23" data-line-number="23"><span class="co"># quick check</span></a>
<a class="sourceLine" id="cb5-24" data-line-number="24"><span class="kw"><a href="https://rdrr.io/r/utils/str.html">str</a></span>(<span class="kw">data_gen</span>())</a>
<a class="sourceLine" id="cb5-25" data-line-number="25"><span class="co">#&gt; List of 2</span></a>
<a class="sourceLine" id="cb5-26" data-line-number="26"><span class="co">#&gt;  $ : num [1:2, 1:24, 1] 112 115 118 126 132 141 129 135 121 125 ...</span></a>
<a class="sourceLine" id="cb5-27" data-line-number="27"><span class="co">#&gt;  $ : num [1:2, 1:12, 1] 145 171 150 180 178 193 163 181 172 183 ...</span></a></code></pre></div>
<!-- in development -->
<p><img src="timeseries_files/figure-html/unnamed-chunk-7-1.gif" width="85%" style="display: block; margin: auto;"></p>
</div>
</div>
</div>
<div id="practical-example" class="section level2">
<h2 class="hasAnchor">
<a href="#practical-example" class="anchor"></a>Practical example</h2>
<div id="many-to-one-1" class="section level3">
<h3 class="hasAnchor">
<a href="#many-to-one-1" class="anchor"></a>Many-to-one</h3>
<!-- in development -->
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" data-line-number="1"><span class="co"># supervised time series settings</span></a>
<a class="sourceLine" id="cb6-2" data-line-number="2">x &lt;-<span class="st"> "passenger"</span></a>
<a class="sourceLine" id="cb6-3" data-line-number="3">y &lt;-<span class="st"> "passenger"</span></a>
<a class="sourceLine" id="cb6-4" data-line-number="4">length_out &lt;-<span class="st"> </span><span class="dv">1</span></a>
<a class="sourceLine" id="cb6-5" data-line-number="5">stride &lt;-<span class="st"> </span><span class="dv">1</span></a>
<a class="sourceLine" id="cb6-6" data-line-number="6">lookback &lt;-<span class="st"> </span><span class="dv">1</span></a>
<a class="sourceLine" id="cb6-7" data-line-number="7">timesteps &lt;-<span class="st"> </span><span class="dv">24</span></a>
<a class="sourceLine" id="cb6-8" data-line-number="8"></a>
<a class="sourceLine" id="cb6-9" data-line-number="9"><span class="co"># validation and test size</span></a>
<a class="sourceLine" id="cb6-10" data-line-number="10">val_size &lt;-<span class="st"> </span><span class="dv">12</span></a>
<a class="sourceLine" id="cb6-11" data-line-number="11">test_size &lt;-<span class="st"> </span><span class="dv">12</span></a>
<a class="sourceLine" id="cb6-12" data-line-number="12"></a>
<a class="sourceLine" id="cb6-13" data-line-number="13"><span class="co"># test split</span></a>
<a class="sourceLine" id="cb6-14" data-line-number="14">data_test &lt;-<span class="st"> </span>airpassenger_df <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb6-15" data-line-number="15"><span class="st">  </span><span class="kw"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(<span class="kw">row_number</span>() <span class="op">&gt;</span><span class="st"> </span><span class="kw">n</span>() <span class="op">-</span><span class="st"> </span>test_size <span class="op">-</span><span class="st"> </span>lookback <span class="op">-</span><span class="st"> </span>timesteps <span class="op">+</span><span class="st"> </span><span class="dv">1</span>)</a>
<a class="sourceLine" id="cb6-16" data-line-number="16"></a>
<a class="sourceLine" id="cb6-17" data-line-number="17"><span class="co"># initial train after test-split</span></a>
<a class="sourceLine" id="cb6-18" data-line-number="18">data_train &lt;-<span class="st"> </span>airpassenger_df <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb6-19" data-line-number="19"><span class="st">  </span><span class="kw"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(<span class="kw">row_number</span>() <span class="op">&lt;=</span><span class="st"> </span><span class="kw">n</span>() <span class="op">-</span><span class="st"> </span>test_size)</a>
<a class="sourceLine" id="cb6-20" data-line-number="20"></a>
<a class="sourceLine" id="cb6-21" data-line-number="21"><span class="co"># validation split</span></a>
<a class="sourceLine" id="cb6-22" data-line-number="22">data_val &lt;-<span class="st"> </span>data_train <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb6-23" data-line-number="23"><span class="st">  </span><span class="kw"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(<span class="kw">row_number</span>() <span class="op">&gt;</span><span class="st"> </span><span class="kw">n</span>() <span class="op">-</span><span class="st"> </span>val_size <span class="op">-</span><span class="st"> </span>lookback <span class="op">-</span><span class="st"> </span>timesteps <span class="op">+</span><span class="st"> </span><span class="dv">1</span>)</a>
<a class="sourceLine" id="cb6-24" data-line-number="24"></a>
<a class="sourceLine" id="cb6-25" data-line-number="25"><span class="co"># final train after validation-split</span></a>
<a class="sourceLine" id="cb6-26" data-line-number="26">data_train &lt;-<span class="st"> </span>data_train <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb6-27" data-line-number="27"><span class="st">  </span><span class="kw"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(<span class="kw">row_number</span>() <span class="op">&lt;=</span><span class="st"> </span><span class="kw">n</span>() <span class="op">-</span><span class="st"> </span>val_size)</a></code></pre></div>
<!-- in development -->
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb7-1" data-line-number="1"><span class="co"># create preprocess recipe</span></a>
<a class="sourceLine" id="cb7-2" data-line-number="2">rec &lt;-<span class="st"> </span><span class="kw">recipe</span>(passenger <span class="op">~</span><span class="st"> </span>., <span class="dt">data =</span> data_train) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb7-3" data-line-number="3"><span class="st">  </span><span class="kw">step_rm</span>(date) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb7-4" data-line-number="4"><span class="st">  </span><span class="kw">step_log</span>(passenger) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb7-5" data-line-number="5"><span class="st">  </span><span class="kw">step_normalize</span>(passenger) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb7-6" data-line-number="6"><span class="st">  </span><span class="kw">prep</span>()</a>
<a class="sourceLine" id="cb7-7" data-line-number="7"></a>
<a class="sourceLine" id="cb7-8" data-line-number="8"><span class="co"># prepare recipes-revert functions</span></a>
<a class="sourceLine" id="cb7-9" data-line-number="9">rec_rev &lt;-<span class="st"> </span><span class="cf">function</span>(x, rec) {</a>
<a class="sourceLine" id="cb7-10" data-line-number="10"></a>
<a class="sourceLine" id="cb7-11" data-line-number="11">  means &lt;-<span class="st"> </span>rec<span class="op">$</span>steps[[<span class="dv">3</span>]]<span class="op">$</span>means[[<span class="st">"passenger"</span>]]</a>
<a class="sourceLine" id="cb7-12" data-line-number="12">  sds &lt;-<span class="st"> </span>rec<span class="op">$</span>steps[[<span class="dv">3</span>]]<span class="op">$</span>sds[[<span class="st">"passenger"</span>]]</a>
<a class="sourceLine" id="cb7-13" data-line-number="13"></a>
<a class="sourceLine" id="cb7-14" data-line-number="14">  x &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/Log.html">exp</a></span>(x <span class="op">*</span><span class="st"> </span>sds <span class="op">+</span><span class="st"> </span>means)</a>
<a class="sourceLine" id="cb7-15" data-line-number="15">  x &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/Round.html">round</a></span>(x)</a>
<a class="sourceLine" id="cb7-16" data-line-number="16">  x &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span>(x <span class="op">&lt;</span><span class="st"> </span><span class="dv">0</span>, <span class="dv">0</span>, x)</a>
<a class="sourceLine" id="cb7-17" data-line-number="17"></a>
<a class="sourceLine" id="cb7-18" data-line-number="18">  x</a>
<a class="sourceLine" id="cb7-19" data-line-number="19"></a>
<a class="sourceLine" id="cb7-20" data-line-number="20">}</a>
<a class="sourceLine" id="cb7-21" data-line-number="21"></a>
<a class="sourceLine" id="cb7-22" data-line-number="22"><span class="co"># get all preprocessed data</span></a>
<a class="sourceLine" id="cb7-23" data-line-number="23">data_train_prep &lt;-<span class="st"> </span><span class="kw">juice</span>(rec)</a>
<a class="sourceLine" id="cb7-24" data-line-number="24">data_val_prep &lt;-<span class="st"> </span><span class="kw">bake</span>(rec, data_val)</a>
<a class="sourceLine" id="cb7-25" data-line-number="25">data_test_prep &lt;-<span class="st"> </span><span class="kw">bake</span>(rec, data_test)</a></code></pre></div>
<!-- in development -->
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb8-1" data-line-number="1"><span class="co"># generator settings</span></a>
<a class="sourceLine" id="cb8-2" data-line-number="2">batch_size &lt;-<span class="st"> </span><span class="dv">12</span></a>
<a class="sourceLine" id="cb8-3" data-line-number="3"></a>
<a class="sourceLine" id="cb8-4" data-line-number="4"><span class="co"># train-val-test generator</span></a>
<a class="sourceLine" id="cb8-5" data-line-number="5">data_train_gen &lt;-<span class="st"> </span><span class="kw"><a href="../reference/flow_series_from_dataframe.html">flow_series_from_dataframe</a></span>(</a>
<a class="sourceLine" id="cb8-6" data-line-number="6">  <span class="dt">data =</span> data_train_prep,</a>
<a class="sourceLine" id="cb8-7" data-line-number="7">  <span class="dt">x =</span> x,</a>
<a class="sourceLine" id="cb8-8" data-line-number="8">  <span class="dt">y =</span> y,</a>
<a class="sourceLine" id="cb8-9" data-line-number="9">  <span class="dt">length_out =</span> length_out,</a>
<a class="sourceLine" id="cb8-10" data-line-number="10">  <span class="dt">stride =</span> stride,</a>
<a class="sourceLine" id="cb8-11" data-line-number="11">  <span class="dt">lookback =</span> lookback,</a>
<a class="sourceLine" id="cb8-12" data-line-number="12">  <span class="dt">timesteps =</span> timesteps,</a>
<a class="sourceLine" id="cb8-13" data-line-number="13">  <span class="dt">batch_size =</span> batch_size,</a>
<a class="sourceLine" id="cb8-14" data-line-number="14">  <span class="dt">mode =</span> <span class="st">"training"</span></a>
<a class="sourceLine" id="cb8-15" data-line-number="15">)</a>
<a class="sourceLine" id="cb8-16" data-line-number="16"></a>
<a class="sourceLine" id="cb8-17" data-line-number="17">data_val_gen &lt;-<span class="st"> </span><span class="kw"><a href="../reference/flow_series_from_dataframe.html">flow_series_from_dataframe</a></span>(</a>
<a class="sourceLine" id="cb8-18" data-line-number="18">  <span class="dt">data =</span> data_val_prep,</a>
<a class="sourceLine" id="cb8-19" data-line-number="19">  <span class="dt">x =</span> x,</a>
<a class="sourceLine" id="cb8-20" data-line-number="20">  <span class="dt">y =</span> y,</a>
<a class="sourceLine" id="cb8-21" data-line-number="21">  <span class="dt">length_out =</span> length_out,</a>
<a class="sourceLine" id="cb8-22" data-line-number="22">  <span class="dt">stride =</span> stride,</a>
<a class="sourceLine" id="cb8-23" data-line-number="23">  <span class="dt">lookback =</span> lookback,</a>
<a class="sourceLine" id="cb8-24" data-line-number="24">  <span class="dt">timesteps =</span> timesteps,</a>
<a class="sourceLine" id="cb8-25" data-line-number="25">  <span class="dt">batch_size =</span> batch_size,</a>
<a class="sourceLine" id="cb8-26" data-line-number="26">  <span class="dt">mode =</span> <span class="st">"training"</span></a>
<a class="sourceLine" id="cb8-27" data-line-number="27">)</a>
<a class="sourceLine" id="cb8-28" data-line-number="28"></a>
<a class="sourceLine" id="cb8-29" data-line-number="29">data_test_gen &lt;-<span class="st"> </span><span class="kw"><a href="../reference/flow_series_from_dataframe.html">flow_series_from_dataframe</a></span>(</a>
<a class="sourceLine" id="cb8-30" data-line-number="30">  <span class="dt">data =</span> data_test_prep,</a>
<a class="sourceLine" id="cb8-31" data-line-number="31">  <span class="dt">x =</span> x,</a>
<a class="sourceLine" id="cb8-32" data-line-number="32">  <span class="dt">y =</span> y,</a>
<a class="sourceLine" id="cb8-33" data-line-number="33">  <span class="dt">length_out =</span> length_out,</a>
<a class="sourceLine" id="cb8-34" data-line-number="34">  <span class="dt">stride =</span> stride,</a>
<a class="sourceLine" id="cb8-35" data-line-number="35">  <span class="dt">lookback =</span> lookback,</a>
<a class="sourceLine" id="cb8-36" data-line-number="36">  <span class="dt">timesteps =</span> timesteps,</a>
<a class="sourceLine" id="cb8-37" data-line-number="37">  <span class="dt">batch_size =</span> batch_size,</a>
<a class="sourceLine" id="cb8-38" data-line-number="38">  <span class="dt">mode =</span> <span class="st">"training"</span></a>
<a class="sourceLine" id="cb8-39" data-line-number="39">)</a></code></pre></div>
<!-- in development -->
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb9-1" data-line-number="1"><span class="co"># define input layer</span></a>
<a class="sourceLine" id="cb9-2" data-line-number="2">input &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/pkg/keras/man/layer_input.html">layer_input</a></span>(<span class="dt">name =</span> <span class="st">"input"</span>, <span class="dt">shape =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(timesteps, <span class="kw"><a href="https://rdrr.io/r/base/length.html">length</a></span>(x)))</a>
<a class="sourceLine" id="cb9-3" data-line-number="3"></a>
<a class="sourceLine" id="cb9-4" data-line-number="4"><span class="co"># define hidden layers</span></a>
<a class="sourceLine" id="cb9-5" data-line-number="5">cnn1 &lt;-<span class="st"> </span>input <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb9-6" data-line-number="6"><span class="st">  </span><span class="kw"><a href="https://rdrr.io/pkg/keras/man/layer_conv_1d.html">layer_conv_1d</a></span>(<span class="dt">name =</span> <span class="st">"cnn_1_1"</span>, <span class="dt">filters =</span> <span class="dv">16</span>, <span class="dt">kernel_size =</span> <span class="dv">12</span>, <span class="dt">padding =</span> <span class="st">"same"</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb9-7" data-line-number="7"><span class="st">  </span><span class="kw"><a href="https://rdrr.io/pkg/keras/man/layer_activation_leaky_relu.html">layer_activation_leaky_relu</a></span>(<span class="dt">name =</span> <span class="st">"cnn_1_1_act"</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb9-8" data-line-number="8"><span class="st">  </span><span class="kw"><a href="https://rdrr.io/pkg/keras/man/layer_flatten.html">layer_flatten</a></span>(<span class="dt">name =</span> <span class="st">"cnn_1_1_flat"</span>)</a>
<a class="sourceLine" id="cb9-9" data-line-number="9"></a>
<a class="sourceLine" id="cb9-10" data-line-number="10">cnn2 &lt;-<span class="st"> </span>input <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb9-11" data-line-number="11"><span class="st">  </span><span class="kw"><a href="https://rdrr.io/pkg/keras/man/layer_conv_1d.html">layer_conv_1d</a></span>(<span class="dt">name =</span> <span class="st">"cnn_2_1"</span>, <span class="dt">filters =</span> <span class="dv">16</span>, <span class="dt">kernel_size =</span> <span class="dv">3</span>, <span class="dt">padding =</span> <span class="st">"same"</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb9-12" data-line-number="12"><span class="st">  </span><span class="kw"><a href="https://rdrr.io/pkg/keras/man/layer_activation_leaky_relu.html">layer_activation_leaky_relu</a></span>(<span class="dt">name =</span> <span class="st">"cnn_2_1_act"</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb9-13" data-line-number="13"><span class="st">  </span><span class="kw"><a href="https://rdrr.io/pkg/keras/man/layer_flatten.html">layer_flatten</a></span>(<span class="dt">name =</span> <span class="st">"cnn_2_1_flat"</span>)</a>
<a class="sourceLine" id="cb9-14" data-line-number="14"></a>
<a class="sourceLine" id="cb9-15" data-line-number="15">cnn &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(cnn1, cnn2) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb9-16" data-line-number="16"><span class="st">  </span><span class="kw"><a href="https://rdrr.io/pkg/keras/man/layer_concatenate.html">layer_concatenate</a></span>(<span class="dt">name =</span> <span class="st">"cnn_concat"</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb9-17" data-line-number="17"><span class="st">  </span><span class="kw"><a href="https://rdrr.io/pkg/keras/man/layer_dropout.html">layer_dropout</a></span>(<span class="dt">name =</span> <span class="st">"cnn_dp"</span>, <span class="dt">rate =</span> <span class="fl">0.1</span>)</a>
<a class="sourceLine" id="cb9-18" data-line-number="18"></a>
<a class="sourceLine" id="cb9-19" data-line-number="19">hiddens &lt;-<span class="st"> </span>cnn <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb9-20" data-line-number="20"><span class="st">  </span><span class="kw"><a href="https://rdrr.io/pkg/keras/man/layer_dense.html">layer_dense</a></span>(<span class="dt">name =</span> <span class="st">"dense_1"</span>, <span class="dt">units =</span> <span class="dv">32</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb9-21" data-line-number="21"><span class="st">  </span><span class="kw"><a href="https://rdrr.io/pkg/keras/man/layer_activation_leaky_relu.html">layer_activation_leaky_relu</a></span>(<span class="dt">name =</span> <span class="st">"dense_1_act"</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb9-22" data-line-number="22"><span class="st">  </span><span class="kw"><a href="https://rdrr.io/pkg/keras/man/layer_dropout.html">layer_dropout</a></span>(<span class="dt">name =</span> <span class="st">"dense_1_dp"</span>, <span class="dt">rate =</span> <span class="fl">0.1</span>)</a>
<a class="sourceLine" id="cb9-23" data-line-number="23"></a>
<a class="sourceLine" id="cb9-24" data-line-number="24"><span class="co"># define output layers</span></a>
<a class="sourceLine" id="cb9-25" data-line-number="25">output &lt;-<span class="st"> </span>hiddens <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb9-26" data-line-number="26"><span class="st">  </span><span class="kw"><a href="https://rdrr.io/pkg/keras/man/layer_dense.html">layer_dense</a></span>(<span class="dt">name =</span> <span class="st">"output"</span>, <span class="dt">units =</span> <span class="kw"><a href="https://rdrr.io/r/base/length.html">length</a></span>(y) <span class="op">*</span><span class="st"> </span>length_out) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb9-27" data-line-number="27"><span class="st">  </span><span class="kw"><a href="https://rdrr.io/pkg/keras/man/layer_reshape.html">layer_reshape</a></span>(<span class="dt">name =</span> <span class="st">"output_reshape"</span>, <span class="dt">target_shape =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(length_out, <span class="dv">1</span>))</a>
<a class="sourceLine" id="cb9-28" data-line-number="28"></a>
<a class="sourceLine" id="cb9-29" data-line-number="29"><span class="co"># wrap-up to full model</span></a>
<a class="sourceLine" id="cb9-30" data-line-number="30">model &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/pkg/keras/man/keras_model.html">keras_model</a></span>(<span class="dt">inputs =</span> input, <span class="dt">outputs =</span> output)</a>
<a class="sourceLine" id="cb9-31" data-line-number="31"></a>
<a class="sourceLine" id="cb9-32" data-line-number="32"><span class="co"># compile the model</span></a>
<a class="sourceLine" id="cb9-33" data-line-number="33">model <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/pkg/keras/man/reexports.html">compile</a></span>(</a>
<a class="sourceLine" id="cb9-34" data-line-number="34">  <span class="dt">optimizer =</span> <span class="kw"><a href="https://rdrr.io/pkg/keras/man/optimizer_adam.html">optimizer_adam</a></span>(<span class="dt">lr =</span> <span class="fl">0.0001</span>),</a>
<a class="sourceLine" id="cb9-35" data-line-number="35">  <span class="dt">loss =</span> <span class="st">"mean_absolute_error"</span></a>
<a class="sourceLine" id="cb9-36" data-line-number="36">)</a>
<a class="sourceLine" id="cb9-37" data-line-number="37"></a>
<a class="sourceLine" id="cb9-38" data-line-number="38"><span class="co"># model summary</span></a>
<a class="sourceLine" id="cb9-39" data-line-number="39"><span class="kw"><a href="https://rdrr.io/r/base/summary.html">summary</a></span>(model)</a>
<a class="sourceLine" id="cb9-40" data-line-number="40"><span class="co">#&gt; ___________________________________________________________________________</span></a>
<a class="sourceLine" id="cb9-41" data-line-number="41"><span class="co">#&gt; Layer (type)            Output Shape     Param #  Connected to             </span></a>
<a class="sourceLine" id="cb9-42" data-line-number="42"><span class="co">#&gt; ===========================================================================</span></a>
<a class="sourceLine" id="cb9-43" data-line-number="43"><span class="co">#&gt; input (InputLayer)      (None, 24, 1)    0                                 </span></a>
<a class="sourceLine" id="cb9-44" data-line-number="44"><span class="co">#&gt; ___________________________________________________________________________</span></a>
<a class="sourceLine" id="cb9-45" data-line-number="45"><span class="co">#&gt; cnn_1_1 (Conv1D)        (None, 24, 16)   208      input[0][0]              </span></a>
<a class="sourceLine" id="cb9-46" data-line-number="46"><span class="co">#&gt; ___________________________________________________________________________</span></a>
<a class="sourceLine" id="cb9-47" data-line-number="47"><span class="co">#&gt; cnn_2_1 (Conv1D)        (None, 24, 16)   64       input[0][0]              </span></a>
<a class="sourceLine" id="cb9-48" data-line-number="48"><span class="co">#&gt; ___________________________________________________________________________</span></a>
<a class="sourceLine" id="cb9-49" data-line-number="49"><span class="co">#&gt; cnn_1_1_act (LeakyReLU) (None, 24, 16)   0        cnn_1_1[0][0]            </span></a>
<a class="sourceLine" id="cb9-50" data-line-number="50"><span class="co">#&gt; ___________________________________________________________________________</span></a>
<a class="sourceLine" id="cb9-51" data-line-number="51"><span class="co">#&gt; cnn_2_1_act (LeakyReLU) (None, 24, 16)   0        cnn_2_1[0][0]            </span></a>
<a class="sourceLine" id="cb9-52" data-line-number="52"><span class="co">#&gt; ___________________________________________________________________________</span></a>
<a class="sourceLine" id="cb9-53" data-line-number="53"><span class="co">#&gt; cnn_1_1_flat (Flatten)  (None, 384)      0        cnn_1_1_act[0][0]        </span></a>
<a class="sourceLine" id="cb9-54" data-line-number="54"><span class="co">#&gt; ___________________________________________________________________________</span></a>
<a class="sourceLine" id="cb9-55" data-line-number="55"><span class="co">#&gt; cnn_2_1_flat (Flatten)  (None, 384)      0        cnn_2_1_act[0][0]        </span></a>
<a class="sourceLine" id="cb9-56" data-line-number="56"><span class="co">#&gt; ___________________________________________________________________________</span></a>
<a class="sourceLine" id="cb9-57" data-line-number="57"><span class="co">#&gt; cnn_concat (Concatenate (None, 768)      0        cnn_1_1_flat[0][0]       </span></a>
<a class="sourceLine" id="cb9-58" data-line-number="58"><span class="co">#&gt;                                                   cnn_2_1_flat[0][0]       </span></a>
<a class="sourceLine" id="cb9-59" data-line-number="59"><span class="co">#&gt; ___________________________________________________________________________</span></a>
<a class="sourceLine" id="cb9-60" data-line-number="60"><span class="co">#&gt; cnn_dp (Dropout)        (None, 768)      0        cnn_concat[0][0]         </span></a>
<a class="sourceLine" id="cb9-61" data-line-number="61"><span class="co">#&gt; ___________________________________________________________________________</span></a>
<a class="sourceLine" id="cb9-62" data-line-number="62"><span class="co">#&gt; dense_1 (Dense)         (None, 32)       24608    cnn_dp[0][0]             </span></a>
<a class="sourceLine" id="cb9-63" data-line-number="63"><span class="co">#&gt; ___________________________________________________________________________</span></a>
<a class="sourceLine" id="cb9-64" data-line-number="64"><span class="co">#&gt; dense_1_act (LeakyReLU) (None, 32)       0        dense_1[0][0]            </span></a>
<a class="sourceLine" id="cb9-65" data-line-number="65"><span class="co">#&gt; ___________________________________________________________________________</span></a>
<a class="sourceLine" id="cb9-66" data-line-number="66"><span class="co">#&gt; dense_1_dp (Dropout)    (None, 32)       0        dense_1_act[0][0]        </span></a>
<a class="sourceLine" id="cb9-67" data-line-number="67"><span class="co">#&gt; ___________________________________________________________________________</span></a>
<a class="sourceLine" id="cb9-68" data-line-number="68"><span class="co">#&gt; output (Dense)          (None, 1)        33       dense_1_dp[0][0]         </span></a>
<a class="sourceLine" id="cb9-69" data-line-number="69"><span class="co">#&gt; ___________________________________________________________________________</span></a>
<a class="sourceLine" id="cb9-70" data-line-number="70"><span class="co">#&gt; output_reshape (Reshape (None, 1, 1)     0        output[0][0]             </span></a>
<a class="sourceLine" id="cb9-71" data-line-number="71"><span class="co">#&gt; ===========================================================================</span></a>
<a class="sourceLine" id="cb9-72" data-line-number="72"><span class="co">#&gt; Total params: 24,913</span></a>
<a class="sourceLine" id="cb9-73" data-line-number="73"><span class="co">#&gt; Trainable params: 24,913</span></a>
<a class="sourceLine" id="cb9-74" data-line-number="74"><span class="co">#&gt; Non-trainable params: 0</span></a>
<a class="sourceLine" id="cb9-75" data-line-number="75"><span class="co">#&gt; ___________________________________________________________________________</span></a></code></pre></div>
<!-- in development -->
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb10-1" data-line-number="1"><span class="co"># get generator meta</span></a>
<a class="sourceLine" id="cb10-2" data-line-number="2">steps_per_epoch &lt;-<span class="st"> </span><span class="kw"><a href="../reference/generator_meta.html">generator_meta</a></span>(data_train_gen, <span class="st">"steps_to_all"</span>)</a>
<a class="sourceLine" id="cb10-3" data-line-number="3">validation_steps &lt;-<span class="st"> </span><span class="kw"><a href="../reference/generator_meta.html">generator_meta</a></span>(data_val_gen, <span class="st">"steps_to_all"</span>)</a>
<a class="sourceLine" id="cb10-4" data-line-number="4"></a>
<a class="sourceLine" id="cb10-5" data-line-number="5"><span class="co"># fit the model</span></a>
<a class="sourceLine" id="cb10-6" data-line-number="6">history &lt;-<span class="st"> </span>model <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/pkg/keras/man/fit_generator.html">fit_generator</a></span>(</a>
<a class="sourceLine" id="cb10-7" data-line-number="7">  <span class="dt">generator =</span> data_train_gen,</a>
<a class="sourceLine" id="cb10-8" data-line-number="8">  <span class="dt">steps_per_epoch =</span> steps_per_epoch,</a>
<a class="sourceLine" id="cb10-9" data-line-number="9">  <span class="dt">epochs =</span> <span class="dv">100</span>,</a>
<a class="sourceLine" id="cb10-10" data-line-number="10">  <span class="dt">validation_data =</span> data_val_gen,</a>
<a class="sourceLine" id="cb10-11" data-line-number="11">  <span class="dt">validation_steps =</span> validation_steps</a>
<a class="sourceLine" id="cb10-12" data-line-number="12">)</a>
<a class="sourceLine" id="cb10-13" data-line-number="13"></a>
<a class="sourceLine" id="cb10-14" data-line-number="14"><span class="co"># visualize training results</span></a>
<a class="sourceLine" id="cb10-15" data-line-number="15"><span class="kw"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span>(history)</a></code></pre></div>
<p><img src="timeseries_files/figure-html/unnamed-chunk-12-1.png" width="85%" style="display: block; margin: auto;"></p>
<!-- in development -->
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb11-1" data-line-number="1"><span class="co"># get prediction on train</span></a>
<a class="sourceLine" id="cb11-2" data-line-number="2">pred_train &lt;-<span class="st"> </span>model <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb11-3" data-line-number="3"><span class="st">  </span><span class="kw"><a href="https://rdrr.io/pkg/keras/man/predict_generator.html">predict_generator</a></span>(</a>
<a class="sourceLine" id="cb11-4" data-line-number="4">    <span class="dt">generator =</span> <span class="kw"><a href="../reference/generator_mode.html">generator_mode</a></span>(data_train_gen, <span class="st">"prediction"</span>),</a>
<a class="sourceLine" id="cb11-5" data-line-number="5">    <span class="dt">steps =</span> <span class="kw"><a href="../reference/generator_meta.html">generator_meta</a></span>(data_train_gen, <span class="st">"steps_to_all"</span>)</a>
<a class="sourceLine" id="cb11-6" data-line-number="6">  )</a>
<a class="sourceLine" id="cb11-7" data-line-number="7"></a>
<a class="sourceLine" id="cb11-8" data-line-number="8">pred_train &lt;-<span class="st"> </span><span class="kw">as_tibble</span>(pred_train)</a>
<a class="sourceLine" id="cb11-9" data-line-number="9"></a>
<a class="sourceLine" id="cb11-10" data-line-number="10"><span class="kw"><a href="https://rdrr.io/r/base/names.html">names</a></span>(pred_train) &lt;-<span class="st"> "passenger"</span></a>
<a class="sourceLine" id="cb11-11" data-line-number="11"></a>
<a class="sourceLine" id="cb11-12" data-line-number="12">pred_train &lt;-<span class="st"> </span>pred_train <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb11-13" data-line-number="13"><span class="st">  </span><span class="kw">mutate</span>(</a>
<a class="sourceLine" id="cb11-14" data-line-number="14">    <span class="dt">date =</span> <span class="kw"><a href="https://rdrr.io/r/utils/head.html">tail</a></span>(data_train<span class="op">$</span>date, <span class="kw"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(pred_train)),</a>
<a class="sourceLine" id="cb11-15" data-line-number="15">    <span class="dt">passenger =</span> <span class="kw">rec_rev</span>(passenger, rec)</a>
<a class="sourceLine" id="cb11-16" data-line-number="16">  )</a>
<a class="sourceLine" id="cb11-17" data-line-number="17"></a>
<a class="sourceLine" id="cb11-18" data-line-number="18"><span class="co"># get prediction on validation</span></a>
<a class="sourceLine" id="cb11-19" data-line-number="19">pred_val &lt;-<span class="st"> </span>model <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb11-20" data-line-number="20"><span class="st">  </span><span class="kw"><a href="https://rdrr.io/pkg/keras/man/predict_generator.html">predict_generator</a></span>(</a>
<a class="sourceLine" id="cb11-21" data-line-number="21">    <span class="dt">generator =</span> <span class="kw"><a href="../reference/generator_mode.html">generator_mode</a></span>(data_val_gen, <span class="st">"prediction"</span>),</a>
<a class="sourceLine" id="cb11-22" data-line-number="22">    <span class="dt">steps =</span> <span class="kw"><a href="../reference/generator_meta.html">generator_meta</a></span>(data_val_gen, <span class="st">"steps_to_all"</span>)</a>
<a class="sourceLine" id="cb11-23" data-line-number="23">  )</a>
<a class="sourceLine" id="cb11-24" data-line-number="24"></a>
<a class="sourceLine" id="cb11-25" data-line-number="25">pred_val &lt;-<span class="st"> </span><span class="kw">as_tibble</span>(pred_val)</a>
<a class="sourceLine" id="cb11-26" data-line-number="26"></a>
<a class="sourceLine" id="cb11-27" data-line-number="27"><span class="kw"><a href="https://rdrr.io/r/base/names.html">names</a></span>(pred_val) &lt;-<span class="st"> "passenger"</span></a>
<a class="sourceLine" id="cb11-28" data-line-number="28"></a>
<a class="sourceLine" id="cb11-29" data-line-number="29">pred_val &lt;-<span class="st"> </span>pred_val <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb11-30" data-line-number="30"><span class="st">  </span><span class="kw">mutate</span>(</a>
<a class="sourceLine" id="cb11-31" data-line-number="31">    <span class="dt">date =</span> <span class="kw"><a href="https://rdrr.io/r/utils/head.html">tail</a></span>(data_val<span class="op">$</span>date, <span class="kw"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(pred_val)),</a>
<a class="sourceLine" id="cb11-32" data-line-number="32">    <span class="dt">passenger =</span> <span class="kw">rec_rev</span>(passenger, rec)</a>
<a class="sourceLine" id="cb11-33" data-line-number="33">  )</a>
<a class="sourceLine" id="cb11-34" data-line-number="34"></a>
<a class="sourceLine" id="cb11-35" data-line-number="35"><span class="co"># get prediction on test</span></a>
<a class="sourceLine" id="cb11-36" data-line-number="36">pred_test &lt;-<span class="st"> </span>model <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb11-37" data-line-number="37"><span class="st">  </span><span class="kw"><a href="https://rdrr.io/pkg/keras/man/predict_generator.html">predict_generator</a></span>(</a>
<a class="sourceLine" id="cb11-38" data-line-number="38">    <span class="dt">generator =</span> <span class="kw"><a href="../reference/generator_mode.html">generator_mode</a></span>(data_test_gen, <span class="st">"prediction"</span>),</a>
<a class="sourceLine" id="cb11-39" data-line-number="39">    <span class="dt">steps =</span> <span class="kw"><a href="../reference/generator_meta.html">generator_meta</a></span>(data_test_gen, <span class="st">"steps_to_all"</span>)</a>
<a class="sourceLine" id="cb11-40" data-line-number="40">  )</a>
<a class="sourceLine" id="cb11-41" data-line-number="41"></a>
<a class="sourceLine" id="cb11-42" data-line-number="42">pred_test &lt;-<span class="st"> </span><span class="kw">as_tibble</span>(pred_test)</a>
<a class="sourceLine" id="cb11-43" data-line-number="43"></a>
<a class="sourceLine" id="cb11-44" data-line-number="44"><span class="kw"><a href="https://rdrr.io/r/base/names.html">names</a></span>(pred_test) &lt;-<span class="st"> "passenger"</span></a>
<a class="sourceLine" id="cb11-45" data-line-number="45"></a>
<a class="sourceLine" id="cb11-46" data-line-number="46">pred_test &lt;-<span class="st"> </span>pred_test <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb11-47" data-line-number="47"><span class="st">  </span><span class="kw">mutate</span>(</a>
<a class="sourceLine" id="cb11-48" data-line-number="48">    <span class="dt">date =</span> <span class="kw"><a href="https://rdrr.io/r/utils/head.html">tail</a></span>(data_test<span class="op">$</span>date, <span class="kw"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(pred_test)),</a>
<a class="sourceLine" id="cb11-49" data-line-number="49">    <span class="dt">passenger =</span> <span class="kw">rec_rev</span>(passenger, rec)</a>
<a class="sourceLine" id="cb11-50" data-line-number="50">  )</a></code></pre></div>
<!-- in development -->
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb12-1" data-line-number="1"><span class="co"># wrap-up all data</span></a>
<a class="sourceLine" id="cb12-2" data-line-number="2">data_list &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(</a>
<a class="sourceLine" id="cb12-3" data-line-number="3">  <span class="st">"Actual"</span> =<span class="st"> </span>airpassenger_df,</a>
<a class="sourceLine" id="cb12-4" data-line-number="4">  <span class="st">"Prediction-Train"</span> =<span class="st"> </span>pred_train,</a>
<a class="sourceLine" id="cb12-5" data-line-number="5">  <span class="st">"Prediction-Validation"</span> =<span class="st"> </span><span class="kw">bind_rows</span>(<span class="kw"><a href="https://rdrr.io/r/utils/head.html">tail</a></span>(pred_train, <span class="dv">1</span>), pred_val),</a>
<a class="sourceLine" id="cb12-6" data-line-number="6">  <span class="st">"Prediction-Test"</span> =<span class="st"> </span><span class="kw">bind_rows</span>(<span class="kw"><a href="https://rdrr.io/r/utils/head.html">tail</a></span>(pred_val, <span class="dv">1</span>), pred_test)</a>
<a class="sourceLine" id="cb12-7" data-line-number="7">)</a>
<a class="sourceLine" id="cb12-8" data-line-number="8"></a>
<a class="sourceLine" id="cb12-9" data-line-number="9"><span class="co"># prepare visualization data</span></a>
<a class="sourceLine" id="cb12-10" data-line-number="10">data_viz &lt;-<span class="st"> </span><span class="kw">bind_rows</span>(data_list, <span class="dt">.id =</span> <span class="st">"series"</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb12-11" data-line-number="11"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">series =</span> <span class="kw"><a href="https://rdrr.io/r/base/factor.html">factor</a></span>(series, <span class="dt">levels =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(</a>
<a class="sourceLine" id="cb12-12" data-line-number="12">    <span class="st">"Actual"</span>,</a>
<a class="sourceLine" id="cb12-13" data-line-number="13">    <span class="st">"Prediction-Train"</span>,</a>
<a class="sourceLine" id="cb12-14" data-line-number="14">    <span class="st">"Prediction-Validation"</span>,</a>
<a class="sourceLine" id="cb12-15" data-line-number="15">    <span class="st">"Prediction-Test"</span></a>
<a class="sourceLine" id="cb12-16" data-line-number="16">  )))</a>
<a class="sourceLine" id="cb12-17" data-line-number="17"></a>
<a class="sourceLine" id="cb12-18" data-line-number="18"><span class="co"># visualize</span></a>
<a class="sourceLine" id="cb12-19" data-line-number="19"><span class="kw">ggplot</span>(data_viz, <span class="kw">aes</span>(<span class="dt">x =</span> date, <span class="dt">y =</span> passenger)) <span class="op">+</span></a>
<a class="sourceLine" id="cb12-20" data-line-number="20"><span class="st">  </span><span class="kw">geom_line</span>(<span class="kw">aes</span>(<span class="dt">colour =</span> series)) <span class="op">+</span></a>
<a class="sourceLine" id="cb12-21" data-line-number="21"><span class="st">  </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="ot">NULL</span>, <span class="dt">y =</span> <span class="ot">NULL</span>, <span class="dt">colour =</span> <span class="ot">NULL</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb12-22" data-line-number="22"><span class="st">  </span><span class="kw">theme_minimal</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb12-23" data-line-number="23"><span class="st">  </span><span class="kw">theme</span>(<span class="dt">legend.position =</span> <span class="st">"top"</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb12-24" data-line-number="24"><span class="st">  </span><span class="kw">scale_colour_manual</span>(<span class="dt">values =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(</a>
<a class="sourceLine" id="cb12-25" data-line-number="25">    <span class="st">"Actual"</span> =<span class="st"> "black"</span>,</a>
<a class="sourceLine" id="cb12-26" data-line-number="26">    <span class="st">"Prediction-Train"</span> =<span class="st"> "blue"</span>,</a>
<a class="sourceLine" id="cb12-27" data-line-number="27">    <span class="st">"Prediction-Validation"</span> =<span class="st"> "green"</span>,</a>
<a class="sourceLine" id="cb12-28" data-line-number="28">    <span class="st">"Prediction-Test"</span> =<span class="st"> "red"</span></a>
<a class="sourceLine" id="cb12-29" data-line-number="29">  ))</a></code></pre></div>
<p><img src="timeseries_files/figure-html/unnamed-chunk-14-1.png" width="85%" style="display: block; margin: auto;"></p>
<!-- in development -->
</div>
<div id="many-to-many-1" class="section level3">
<h3 class="hasAnchor">
<a href="#many-to-many-1" class="anchor"></a>Many-to-many</h3>
<!-- in development -->
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb13-1" data-line-number="1"><span class="co"># supervised time series settings</span></a>
<a class="sourceLine" id="cb13-2" data-line-number="2">x &lt;-<span class="st"> "passenger"</span></a>
<a class="sourceLine" id="cb13-3" data-line-number="3">y &lt;-<span class="st"> "passenger"</span></a>
<a class="sourceLine" id="cb13-4" data-line-number="4">length_out &lt;-<span class="st"> </span><span class="dv">12</span></a>
<a class="sourceLine" id="cb13-5" data-line-number="5">stride &lt;-<span class="st"> </span><span class="dv">12</span></a>
<a class="sourceLine" id="cb13-6" data-line-number="6">lookback &lt;-<span class="st"> </span><span class="dv">1</span></a>
<a class="sourceLine" id="cb13-7" data-line-number="7">timesteps &lt;-<span class="st"> </span><span class="dv">24</span></a>
<a class="sourceLine" id="cb13-8" data-line-number="8"></a>
<a class="sourceLine" id="cb13-9" data-line-number="9"><span class="co"># validation and test size</span></a>
<a class="sourceLine" id="cb13-10" data-line-number="10">val_size &lt;-<span class="st"> </span><span class="dv">1</span> <span class="op">*</span><span class="st"> </span>length_out</a>
<a class="sourceLine" id="cb13-11" data-line-number="11">test_size &lt;-<span class="st"> </span><span class="dv">1</span> <span class="op">*</span><span class="st"> </span>length_out</a>
<a class="sourceLine" id="cb13-12" data-line-number="12"></a>
<a class="sourceLine" id="cb13-13" data-line-number="13"><span class="co"># test split</span></a>
<a class="sourceLine" id="cb13-14" data-line-number="14">data_test &lt;-<span class="st"> </span>airpassenger_df <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb13-15" data-line-number="15"><span class="st">  </span><span class="kw"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(<span class="kw">row_number</span>() <span class="op">&gt;</span><span class="st"> </span><span class="kw">n</span>() <span class="op">-</span><span class="st"> </span>test_size <span class="op">-</span><span class="st"> </span>lookback <span class="op">-</span><span class="st"> </span>timesteps <span class="op">+</span><span class="st"> </span><span class="dv">1</span>)</a>
<a class="sourceLine" id="cb13-16" data-line-number="16"></a>
<a class="sourceLine" id="cb13-17" data-line-number="17"><span class="co"># initial train after test-split</span></a>
<a class="sourceLine" id="cb13-18" data-line-number="18">data_train &lt;-<span class="st"> </span>airpassenger_df <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb13-19" data-line-number="19"><span class="st">  </span><span class="kw"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(<span class="kw">row_number</span>() <span class="op">&lt;=</span><span class="st"> </span><span class="kw">n</span>() <span class="op">-</span><span class="st"> </span>test_size)</a>
<a class="sourceLine" id="cb13-20" data-line-number="20"></a>
<a class="sourceLine" id="cb13-21" data-line-number="21"><span class="co"># validation split</span></a>
<a class="sourceLine" id="cb13-22" data-line-number="22">data_val &lt;-<span class="st"> </span>data_train <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb13-23" data-line-number="23"><span class="st">  </span><span class="kw"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(<span class="kw">row_number</span>() <span class="op">&gt;</span><span class="st"> </span><span class="kw">n</span>() <span class="op">-</span><span class="st"> </span>val_size <span class="op">-</span><span class="st"> </span>lookback <span class="op">-</span><span class="st"> </span>timesteps <span class="op">+</span><span class="st"> </span><span class="dv">1</span>)</a>
<a class="sourceLine" id="cb13-24" data-line-number="24"></a>
<a class="sourceLine" id="cb13-25" data-line-number="25"><span class="co"># final train after validation-split</span></a>
<a class="sourceLine" id="cb13-26" data-line-number="26">data_train &lt;-<span class="st"> </span>data_train <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb13-27" data-line-number="27"><span class="st">  </span><span class="kw"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(<span class="kw">row_number</span>() <span class="op">&lt;=</span><span class="st"> </span><span class="kw">n</span>() <span class="op">-</span><span class="st"> </span>val_size)</a></code></pre></div>
<!-- in development -->
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb14-1" data-line-number="1"><span class="co"># create preprocess recipe</span></a>
<a class="sourceLine" id="cb14-2" data-line-number="2">rec &lt;-<span class="st"> </span><span class="kw">recipe</span>(passenger <span class="op">~</span><span class="st"> </span>., <span class="dt">data =</span> data_train) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb14-3" data-line-number="3"><span class="st">  </span><span class="kw">step_rm</span>(date) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb14-4" data-line-number="4"><span class="st">  </span><span class="kw">step_log</span>(passenger) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb14-5" data-line-number="5"><span class="st">  </span><span class="kw">step_normalize</span>(passenger) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb14-6" data-line-number="6"><span class="st">  </span><span class="kw">prep</span>()</a>
<a class="sourceLine" id="cb14-7" data-line-number="7"></a>
<a class="sourceLine" id="cb14-8" data-line-number="8"><span class="co"># prepare recipes-revert functions</span></a>
<a class="sourceLine" id="cb14-9" data-line-number="9">rec_rev &lt;-<span class="st"> </span><span class="cf">function</span>(x, rec) {</a>
<a class="sourceLine" id="cb14-10" data-line-number="10"></a>
<a class="sourceLine" id="cb14-11" data-line-number="11">  means &lt;-<span class="st"> </span>rec<span class="op">$</span>steps[[<span class="dv">3</span>]]<span class="op">$</span>means[[<span class="st">"passenger"</span>]]</a>
<a class="sourceLine" id="cb14-12" data-line-number="12">  sds &lt;-<span class="st"> </span>rec<span class="op">$</span>steps[[<span class="dv">3</span>]]<span class="op">$</span>sds[[<span class="st">"passenger"</span>]]</a>
<a class="sourceLine" id="cb14-13" data-line-number="13"></a>
<a class="sourceLine" id="cb14-14" data-line-number="14">  x &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/Log.html">exp</a></span>(x <span class="op">*</span><span class="st"> </span>sds <span class="op">+</span><span class="st"> </span>means)</a>
<a class="sourceLine" id="cb14-15" data-line-number="15">  x &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/Round.html">round</a></span>(x)</a>
<a class="sourceLine" id="cb14-16" data-line-number="16">  x &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span>(x <span class="op">&lt;</span><span class="st"> </span><span class="dv">0</span>, <span class="dv">0</span>, x)</a>
<a class="sourceLine" id="cb14-17" data-line-number="17"></a>
<a class="sourceLine" id="cb14-18" data-line-number="18">  x</a>
<a class="sourceLine" id="cb14-19" data-line-number="19"></a>
<a class="sourceLine" id="cb14-20" data-line-number="20">}</a>
<a class="sourceLine" id="cb14-21" data-line-number="21"></a>
<a class="sourceLine" id="cb14-22" data-line-number="22"><span class="co"># get all preprocessed data</span></a>
<a class="sourceLine" id="cb14-23" data-line-number="23">data_train_prep &lt;-<span class="st"> </span><span class="kw">juice</span>(rec)</a>
<a class="sourceLine" id="cb14-24" data-line-number="24">data_val_prep &lt;-<span class="st"> </span><span class="kw">bake</span>(rec, data_val)</a>
<a class="sourceLine" id="cb14-25" data-line-number="25">data_test_prep &lt;-<span class="st"> </span><span class="kw">bake</span>(rec, data_test)</a></code></pre></div>
<!-- in development -->
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb15-1" data-line-number="1"><span class="co"># generator settings</span></a>
<a class="sourceLine" id="cb15-2" data-line-number="2">batch_size &lt;-<span class="st"> </span><span class="dv">2</span></a>
<a class="sourceLine" id="cb15-3" data-line-number="3"></a>
<a class="sourceLine" id="cb15-4" data-line-number="4"><span class="co"># train-val-test generator</span></a>
<a class="sourceLine" id="cb15-5" data-line-number="5">data_train_gen &lt;-<span class="st"> </span><span class="kw"><a href="../reference/flow_series_from_dataframe.html">flow_series_from_dataframe</a></span>(</a>
<a class="sourceLine" id="cb15-6" data-line-number="6">  <span class="dt">data =</span> data_train_prep,</a>
<a class="sourceLine" id="cb15-7" data-line-number="7">  <span class="dt">x =</span> x,</a>
<a class="sourceLine" id="cb15-8" data-line-number="8">  <span class="dt">y =</span> y,</a>
<a class="sourceLine" id="cb15-9" data-line-number="9">  <span class="dt">length_out =</span> length_out,</a>
<a class="sourceLine" id="cb15-10" data-line-number="10">  <span class="dt">stride =</span> stride,</a>
<a class="sourceLine" id="cb15-11" data-line-number="11">  <span class="dt">lookback =</span> lookback,</a>
<a class="sourceLine" id="cb15-12" data-line-number="12">  <span class="dt">timesteps =</span> timesteps,</a>
<a class="sourceLine" id="cb15-13" data-line-number="13">  <span class="dt">batch_size =</span> batch_size,</a>
<a class="sourceLine" id="cb15-14" data-line-number="14">  <span class="dt">mode =</span> <span class="st">"training"</span></a>
<a class="sourceLine" id="cb15-15" data-line-number="15">)</a>
<a class="sourceLine" id="cb15-16" data-line-number="16"></a>
<a class="sourceLine" id="cb15-17" data-line-number="17">data_val_gen &lt;-<span class="st"> </span><span class="kw"><a href="../reference/flow_series_from_dataframe.html">flow_series_from_dataframe</a></span>(</a>
<a class="sourceLine" id="cb15-18" data-line-number="18">  <span class="dt">data =</span> data_val_prep,</a>
<a class="sourceLine" id="cb15-19" data-line-number="19">  <span class="dt">x =</span> x,</a>
<a class="sourceLine" id="cb15-20" data-line-number="20">  <span class="dt">y =</span> y,</a>
<a class="sourceLine" id="cb15-21" data-line-number="21">  <span class="dt">length_out =</span> length_out,</a>
<a class="sourceLine" id="cb15-22" data-line-number="22">  <span class="dt">stride =</span> stride,</a>
<a class="sourceLine" id="cb15-23" data-line-number="23">  <span class="dt">lookback =</span> lookback,</a>
<a class="sourceLine" id="cb15-24" data-line-number="24">  <span class="dt">timesteps =</span> timesteps,</a>
<a class="sourceLine" id="cb15-25" data-line-number="25">  <span class="dt">batch_size =</span> batch_size,</a>
<a class="sourceLine" id="cb15-26" data-line-number="26">  <span class="dt">mode =</span> <span class="st">"training"</span></a>
<a class="sourceLine" id="cb15-27" data-line-number="27">)</a>
<a class="sourceLine" id="cb15-28" data-line-number="28"></a>
<a class="sourceLine" id="cb15-29" data-line-number="29">data_test_gen &lt;-<span class="st"> </span><span class="kw"><a href="../reference/flow_series_from_dataframe.html">flow_series_from_dataframe</a></span>(</a>
<a class="sourceLine" id="cb15-30" data-line-number="30">  <span class="dt">data =</span> data_test_prep,</a>
<a class="sourceLine" id="cb15-31" data-line-number="31">  <span class="dt">x =</span> x,</a>
<a class="sourceLine" id="cb15-32" data-line-number="32">  <span class="dt">y =</span> y,</a>
<a class="sourceLine" id="cb15-33" data-line-number="33">  <span class="dt">length_out =</span> length_out,</a>
<a class="sourceLine" id="cb15-34" data-line-number="34">  <span class="dt">stride =</span> stride,</a>
<a class="sourceLine" id="cb15-35" data-line-number="35">  <span class="dt">lookback =</span> lookback,</a>
<a class="sourceLine" id="cb15-36" data-line-number="36">  <span class="dt">timesteps =</span> timesteps,</a>
<a class="sourceLine" id="cb15-37" data-line-number="37">  <span class="dt">batch_size =</span> batch_size,</a>
<a class="sourceLine" id="cb15-38" data-line-number="38">  <span class="dt">mode =</span> <span class="st">"training"</span></a>
<a class="sourceLine" id="cb15-39" data-line-number="39">)</a></code></pre></div>
<!-- in development -->
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb16-1" data-line-number="1"><span class="co"># define input layer</span></a>
<a class="sourceLine" id="cb16-2" data-line-number="2">input &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/pkg/keras/man/layer_input.html">layer_input</a></span>(<span class="dt">name =</span> <span class="st">"input"</span>, <span class="dt">shape =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(timesteps, <span class="kw"><a href="https://rdrr.io/r/base/length.html">length</a></span>(x)))</a>
<a class="sourceLine" id="cb16-3" data-line-number="3"></a>
<a class="sourceLine" id="cb16-4" data-line-number="4"><span class="co"># define hidden layers</span></a>
<a class="sourceLine" id="cb16-5" data-line-number="5">cnn1 &lt;-<span class="st"> </span>input <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb16-6" data-line-number="6"><span class="st">  </span><span class="kw"><a href="https://rdrr.io/pkg/keras/man/layer_conv_1d.html">layer_conv_1d</a></span>(<span class="dt">name =</span> <span class="st">"cnn_1_1"</span>, <span class="dt">filters =</span> <span class="dv">32</span>, <span class="dt">kernel_size =</span> <span class="dv">12</span>, <span class="dt">padding =</span> <span class="st">"same"</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb16-7" data-line-number="7"><span class="st">  </span><span class="kw"><a href="https://rdrr.io/pkg/keras/man/layer_activation_leaky_relu.html">layer_activation_leaky_relu</a></span>(<span class="dt">name =</span> <span class="st">"cnn_1_1_act"</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb16-8" data-line-number="8"><span class="st">  </span><span class="kw"><a href="https://rdrr.io/pkg/keras/man/layer_flatten.html">layer_flatten</a></span>(<span class="dt">name =</span> <span class="st">"cnn_1_1_flat"</span>)</a>
<a class="sourceLine" id="cb16-9" data-line-number="9"></a>
<a class="sourceLine" id="cb16-10" data-line-number="10">cnn2 &lt;-<span class="st"> </span>input <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb16-11" data-line-number="11"><span class="st">  </span><span class="kw"><a href="https://rdrr.io/pkg/keras/man/layer_conv_1d.html">layer_conv_1d</a></span>(<span class="dt">name =</span> <span class="st">"cnn_2_1"</span>, <span class="dt">filters =</span> <span class="dv">32</span>, <span class="dt">kernel_size =</span> <span class="dv">3</span>, <span class="dt">padding =</span> <span class="st">"same"</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb16-12" data-line-number="12"><span class="st">  </span><span class="kw"><a href="https://rdrr.io/pkg/keras/man/layer_activation_leaky_relu.html">layer_activation_leaky_relu</a></span>(<span class="dt">name =</span> <span class="st">"cnn_2_1_act"</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb16-13" data-line-number="13"><span class="st">  </span><span class="kw"><a href="https://rdrr.io/pkg/keras/man/layer_flatten.html">layer_flatten</a></span>(<span class="dt">name =</span> <span class="st">"cnn_2_1_flat"</span>)</a>
<a class="sourceLine" id="cb16-14" data-line-number="14"></a>
<a class="sourceLine" id="cb16-15" data-line-number="15">cnn &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(cnn1, cnn2) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb16-16" data-line-number="16"><span class="st">  </span><span class="kw"><a href="https://rdrr.io/pkg/keras/man/layer_concatenate.html">layer_concatenate</a></span>(<span class="dt">name =</span> <span class="st">"cnn_concat"</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb16-17" data-line-number="17"><span class="st">  </span><span class="kw"><a href="https://rdrr.io/pkg/keras/man/layer_dropout.html">layer_dropout</a></span>(<span class="dt">name =</span> <span class="st">"cnn_dp"</span>, <span class="dt">rate =</span> <span class="fl">0.1</span>)</a>
<a class="sourceLine" id="cb16-18" data-line-number="18"></a>
<a class="sourceLine" id="cb16-19" data-line-number="19">hiddens &lt;-<span class="st"> </span>cnn <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb16-20" data-line-number="20"><span class="st">  </span><span class="kw"><a href="https://rdrr.io/pkg/keras/man/layer_dense.html">layer_dense</a></span>(<span class="dt">name =</span> <span class="st">"dense_1"</span>, <span class="dt">units =</span> <span class="dv">64</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb16-21" data-line-number="21"><span class="st">  </span><span class="kw"><a href="https://rdrr.io/pkg/keras/man/layer_activation_leaky_relu.html">layer_activation_leaky_relu</a></span>(<span class="dt">name =</span> <span class="st">"dense_1_act"</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb16-22" data-line-number="22"><span class="st">  </span><span class="kw"><a href="https://rdrr.io/pkg/keras/man/layer_dropout.html">layer_dropout</a></span>(<span class="dt">name =</span> <span class="st">"dense_1_dp"</span>, <span class="dt">rate =</span> <span class="fl">0.1</span>)</a>
<a class="sourceLine" id="cb16-23" data-line-number="23"></a>
<a class="sourceLine" id="cb16-24" data-line-number="24"><span class="co"># define output layers</span></a>
<a class="sourceLine" id="cb16-25" data-line-number="25">output &lt;-<span class="st"> </span>hiddens <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb16-26" data-line-number="26"><span class="st">  </span><span class="kw"><a href="https://rdrr.io/pkg/keras/man/layer_dense.html">layer_dense</a></span>(<span class="dt">name =</span> <span class="st">"output"</span>, <span class="dt">units =</span> <span class="kw"><a href="https://rdrr.io/r/base/length.html">length</a></span>(y) <span class="op">*</span><span class="st"> </span>length_out) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb16-27" data-line-number="27"><span class="st">  </span><span class="kw"><a href="https://rdrr.io/pkg/keras/man/layer_reshape.html">layer_reshape</a></span>(<span class="dt">name =</span> <span class="st">"output_reshape"</span>, <span class="dt">target_shape =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(length_out, <span class="dv">1</span>))</a>
<a class="sourceLine" id="cb16-28" data-line-number="28"></a>
<a class="sourceLine" id="cb16-29" data-line-number="29"><span class="co"># wrap-up to full model</span></a>
<a class="sourceLine" id="cb16-30" data-line-number="30">model &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/pkg/keras/man/keras_model.html">keras_model</a></span>(<span class="dt">inputs =</span> input, <span class="dt">outputs =</span> output)</a>
<a class="sourceLine" id="cb16-31" data-line-number="31"></a>
<a class="sourceLine" id="cb16-32" data-line-number="32"><span class="co"># compile the model</span></a>
<a class="sourceLine" id="cb16-33" data-line-number="33">model <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/pkg/keras/man/reexports.html">compile</a></span>(</a>
<a class="sourceLine" id="cb16-34" data-line-number="34">  <span class="dt">optimizer =</span> <span class="kw"><a href="https://rdrr.io/pkg/keras/man/optimizer_adam.html">optimizer_adam</a></span>(<span class="dt">lr =</span> <span class="fl">0.0001</span>),</a>
<a class="sourceLine" id="cb16-35" data-line-number="35">  <span class="dt">loss =</span> <span class="st">"mean_absolute_error"</span></a>
<a class="sourceLine" id="cb16-36" data-line-number="36">)</a>
<a class="sourceLine" id="cb16-37" data-line-number="37"></a>
<a class="sourceLine" id="cb16-38" data-line-number="38"><span class="co"># model summary</span></a>
<a class="sourceLine" id="cb16-39" data-line-number="39"><span class="kw"><a href="https://rdrr.io/r/base/summary.html">summary</a></span>(model)</a>
<a class="sourceLine" id="cb16-40" data-line-number="40"><span class="co">#&gt; ___________________________________________________________________________</span></a>
<a class="sourceLine" id="cb16-41" data-line-number="41"><span class="co">#&gt; Layer (type)            Output Shape     Param #  Connected to             </span></a>
<a class="sourceLine" id="cb16-42" data-line-number="42"><span class="co">#&gt; ===========================================================================</span></a>
<a class="sourceLine" id="cb16-43" data-line-number="43"><span class="co">#&gt; input (InputLayer)      (None, 24, 1)    0                                 </span></a>
<a class="sourceLine" id="cb16-44" data-line-number="44"><span class="co">#&gt; ___________________________________________________________________________</span></a>
<a class="sourceLine" id="cb16-45" data-line-number="45"><span class="co">#&gt; cnn_1_1 (Conv1D)        (None, 24, 32)   416      input[0][0]              </span></a>
<a class="sourceLine" id="cb16-46" data-line-number="46"><span class="co">#&gt; ___________________________________________________________________________</span></a>
<a class="sourceLine" id="cb16-47" data-line-number="47"><span class="co">#&gt; cnn_2_1 (Conv1D)        (None, 24, 32)   128      input[0][0]              </span></a>
<a class="sourceLine" id="cb16-48" data-line-number="48"><span class="co">#&gt; ___________________________________________________________________________</span></a>
<a class="sourceLine" id="cb16-49" data-line-number="49"><span class="co">#&gt; cnn_1_1_act (LeakyReLU) (None, 24, 32)   0        cnn_1_1[0][0]            </span></a>
<a class="sourceLine" id="cb16-50" data-line-number="50"><span class="co">#&gt; ___________________________________________________________________________</span></a>
<a class="sourceLine" id="cb16-51" data-line-number="51"><span class="co">#&gt; cnn_2_1_act (LeakyReLU) (None, 24, 32)   0        cnn_2_1[0][0]            </span></a>
<a class="sourceLine" id="cb16-52" data-line-number="52"><span class="co">#&gt; ___________________________________________________________________________</span></a>
<a class="sourceLine" id="cb16-53" data-line-number="53"><span class="co">#&gt; cnn_1_1_flat (Flatten)  (None, 768)      0        cnn_1_1_act[0][0]        </span></a>
<a class="sourceLine" id="cb16-54" data-line-number="54"><span class="co">#&gt; ___________________________________________________________________________</span></a>
<a class="sourceLine" id="cb16-55" data-line-number="55"><span class="co">#&gt; cnn_2_1_flat (Flatten)  (None, 768)      0        cnn_2_1_act[0][0]        </span></a>
<a class="sourceLine" id="cb16-56" data-line-number="56"><span class="co">#&gt; ___________________________________________________________________________</span></a>
<a class="sourceLine" id="cb16-57" data-line-number="57"><span class="co">#&gt; cnn_concat (Concatenate (None, 1536)     0        cnn_1_1_flat[0][0]       </span></a>
<a class="sourceLine" id="cb16-58" data-line-number="58"><span class="co">#&gt;                                                   cnn_2_1_flat[0][0]       </span></a>
<a class="sourceLine" id="cb16-59" data-line-number="59"><span class="co">#&gt; ___________________________________________________________________________</span></a>
<a class="sourceLine" id="cb16-60" data-line-number="60"><span class="co">#&gt; cnn_dp (Dropout)        (None, 1536)     0        cnn_concat[0][0]         </span></a>
<a class="sourceLine" id="cb16-61" data-line-number="61"><span class="co">#&gt; ___________________________________________________________________________</span></a>
<a class="sourceLine" id="cb16-62" data-line-number="62"><span class="co">#&gt; dense_1 (Dense)         (None, 64)       98368    cnn_dp[0][0]             </span></a>
<a class="sourceLine" id="cb16-63" data-line-number="63"><span class="co">#&gt; ___________________________________________________________________________</span></a>
<a class="sourceLine" id="cb16-64" data-line-number="64"><span class="co">#&gt; dense_1_act (LeakyReLU) (None, 64)       0        dense_1[0][0]            </span></a>
<a class="sourceLine" id="cb16-65" data-line-number="65"><span class="co">#&gt; ___________________________________________________________________________</span></a>
<a class="sourceLine" id="cb16-66" data-line-number="66"><span class="co">#&gt; dense_1_dp (Dropout)    (None, 64)       0        dense_1_act[0][0]        </span></a>
<a class="sourceLine" id="cb16-67" data-line-number="67"><span class="co">#&gt; ___________________________________________________________________________</span></a>
<a class="sourceLine" id="cb16-68" data-line-number="68"><span class="co">#&gt; output (Dense)          (None, 12)       780      dense_1_dp[0][0]         </span></a>
<a class="sourceLine" id="cb16-69" data-line-number="69"><span class="co">#&gt; ___________________________________________________________________________</span></a>
<a class="sourceLine" id="cb16-70" data-line-number="70"><span class="co">#&gt; output_reshape (Reshape (None, 12, 1)    0        output[0][0]             </span></a>
<a class="sourceLine" id="cb16-71" data-line-number="71"><span class="co">#&gt; ===========================================================================</span></a>
<a class="sourceLine" id="cb16-72" data-line-number="72"><span class="co">#&gt; Total params: 99,692</span></a>
<a class="sourceLine" id="cb16-73" data-line-number="73"><span class="co">#&gt; Trainable params: 99,692</span></a>
<a class="sourceLine" id="cb16-74" data-line-number="74"><span class="co">#&gt; Non-trainable params: 0</span></a>
<a class="sourceLine" id="cb16-75" data-line-number="75"><span class="co">#&gt; ___________________________________________________________________________</span></a></code></pre></div>
<!-- in development -->
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb17-1" data-line-number="1"><span class="co"># get generator meta</span></a>
<a class="sourceLine" id="cb17-2" data-line-number="2">steps_per_epoch &lt;-<span class="st"> </span><span class="kw"><a href="../reference/generator_meta.html">generator_meta</a></span>(data_train_gen, <span class="st">"steps_to_all"</span>)</a>
<a class="sourceLine" id="cb17-3" data-line-number="3">validation_steps &lt;-<span class="st"> </span><span class="kw"><a href="../reference/generator_meta.html">generator_meta</a></span>(data_val_gen, <span class="st">"steps_to_all"</span>)</a>
<a class="sourceLine" id="cb17-4" data-line-number="4"></a>
<a class="sourceLine" id="cb17-5" data-line-number="5"><span class="co"># fit the model</span></a>
<a class="sourceLine" id="cb17-6" data-line-number="6">history &lt;-<span class="st"> </span>model <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/pkg/keras/man/fit_generator.html">fit_generator</a></span>(</a>
<a class="sourceLine" id="cb17-7" data-line-number="7">  <span class="dt">generator =</span> data_train_gen,</a>
<a class="sourceLine" id="cb17-8" data-line-number="8">  <span class="dt">steps_per_epoch =</span> steps_per_epoch,</a>
<a class="sourceLine" id="cb17-9" data-line-number="9">  <span class="dt">epochs =</span> <span class="dv">100</span>,</a>
<a class="sourceLine" id="cb17-10" data-line-number="10">  <span class="dt">validation_data =</span> data_val_gen,</a>
<a class="sourceLine" id="cb17-11" data-line-number="11">  <span class="dt">validation_steps =</span> validation_steps</a>
<a class="sourceLine" id="cb17-12" data-line-number="12">)</a>
<a class="sourceLine" id="cb17-13" data-line-number="13"></a>
<a class="sourceLine" id="cb17-14" data-line-number="14"><span class="co"># visualize training results</span></a>
<a class="sourceLine" id="cb17-15" data-line-number="15"><span class="kw"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span>(history)</a></code></pre></div>
<p><img src="timeseries_files/figure-html/unnamed-chunk-19-1.png" width="85%" style="display: block; margin: auto;"></p>
<!-- in development -->
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb18-1" data-line-number="1"><span class="co"># get prediction on train</span></a>
<a class="sourceLine" id="cb18-2" data-line-number="2">pred_train &lt;-<span class="st"> </span>model <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb18-3" data-line-number="3"><span class="st">  </span><span class="kw"><a href="https://rdrr.io/pkg/keras/man/predict_generator.html">predict_generator</a></span>(</a>
<a class="sourceLine" id="cb18-4" data-line-number="4">    <span class="dt">generator =</span> <span class="kw"><a href="../reference/generator_mode.html">generator_mode</a></span>(data_train_gen, <span class="st">"prediction"</span>),</a>
<a class="sourceLine" id="cb18-5" data-line-number="5">    <span class="dt">steps =</span> <span class="kw"><a href="../reference/generator_meta.html">generator_meta</a></span>(data_train_gen, <span class="st">"steps_to_all"</span>)</a>
<a class="sourceLine" id="cb18-6" data-line-number="6">  )</a>
<a class="sourceLine" id="cb18-7" data-line-number="7"></a>
<a class="sourceLine" id="cb18-8" data-line-number="8">pred_train_vec &lt;-<span class="st"> </span><span class="ot">NULL</span></a>
<a class="sourceLine" id="cb18-9" data-line-number="9"></a>
<a class="sourceLine" id="cb18-10" data-line-number="10"><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="kw"><a href="https://rdrr.io/r/base/dim.html">dim</a></span>(pred_train)[<span class="dv">1</span>]) {</a>
<a class="sourceLine" id="cb18-11" data-line-number="11">  </a>
<a class="sourceLine" id="cb18-12" data-line-number="12">  pred_train_vec &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(pred_train_vec, pred_train[i, <span class="dv">1</span><span class="op">:</span><span class="dv">12</span>, <span class="dv">1</span>])</a>
<a class="sourceLine" id="cb18-13" data-line-number="13">  </a>
<a class="sourceLine" id="cb18-14" data-line-number="14">}</a>
<a class="sourceLine" id="cb18-15" data-line-number="15"></a>
<a class="sourceLine" id="cb18-16" data-line-number="16">pred_train &lt;-<span class="st"> </span><span class="kw">tibble</span>(</a>
<a class="sourceLine" id="cb18-17" data-line-number="17">  <span class="dt">passenger =</span> pred_train_vec</a>
<a class="sourceLine" id="cb18-18" data-line-number="18">)</a>
<a class="sourceLine" id="cb18-19" data-line-number="19"></a>
<a class="sourceLine" id="cb18-20" data-line-number="20">pred_train &lt;-<span class="st"> </span>pred_train <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb18-21" data-line-number="21"><span class="st">  </span><span class="kw">mutate</span>(</a>
<a class="sourceLine" id="cb18-22" data-line-number="22">    <span class="dt">date =</span> <span class="kw"><a href="https://rdrr.io/r/utils/head.html">tail</a></span>(data_train<span class="op">$</span>date, <span class="kw"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(pred_train)),</a>
<a class="sourceLine" id="cb18-23" data-line-number="23">    <span class="dt">passenger =</span> <span class="kw">rec_rev</span>(passenger, rec)</a>
<a class="sourceLine" id="cb18-24" data-line-number="24">  )</a>
<a class="sourceLine" id="cb18-25" data-line-number="25"></a>
<a class="sourceLine" id="cb18-26" data-line-number="26"><span class="co"># get prediction on validation</span></a>
<a class="sourceLine" id="cb18-27" data-line-number="27">pred_val &lt;-<span class="st"> </span>model <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb18-28" data-line-number="28"><span class="st">  </span><span class="kw"><a href="https://rdrr.io/pkg/keras/man/predict_generator.html">predict_generator</a></span>(</a>
<a class="sourceLine" id="cb18-29" data-line-number="29">    <span class="dt">generator =</span> <span class="kw"><a href="../reference/generator_mode.html">generator_mode</a></span>(data_val_gen, <span class="st">"prediction"</span>),</a>
<a class="sourceLine" id="cb18-30" data-line-number="30">    <span class="dt">steps =</span> <span class="kw"><a href="../reference/generator_meta.html">generator_meta</a></span>(data_val_gen, <span class="st">"steps_to_all"</span>)</a>
<a class="sourceLine" id="cb18-31" data-line-number="31">  )</a>
<a class="sourceLine" id="cb18-32" data-line-number="32"></a>
<a class="sourceLine" id="cb18-33" data-line-number="33">pred_val_vec &lt;-<span class="st"> </span><span class="ot">NULL</span></a>
<a class="sourceLine" id="cb18-34" data-line-number="34"></a>
<a class="sourceLine" id="cb18-35" data-line-number="35"><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="kw"><a href="https://rdrr.io/r/base/dim.html">dim</a></span>(pred_val)[<span class="dv">1</span>]) {</a>
<a class="sourceLine" id="cb18-36" data-line-number="36">  </a>
<a class="sourceLine" id="cb18-37" data-line-number="37">  pred_val_vec &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(pred_val_vec, pred_val[i, <span class="dv">1</span><span class="op">:</span><span class="dv">12</span>, <span class="dv">1</span>])</a>
<a class="sourceLine" id="cb18-38" data-line-number="38">  </a>
<a class="sourceLine" id="cb18-39" data-line-number="39">}</a>
<a class="sourceLine" id="cb18-40" data-line-number="40"></a>
<a class="sourceLine" id="cb18-41" data-line-number="41">pred_val &lt;-<span class="st"> </span><span class="kw">tibble</span>(</a>
<a class="sourceLine" id="cb18-42" data-line-number="42">  <span class="dt">passenger =</span> pred_val_vec</a>
<a class="sourceLine" id="cb18-43" data-line-number="43">)</a>
<a class="sourceLine" id="cb18-44" data-line-number="44"></a>
<a class="sourceLine" id="cb18-45" data-line-number="45">pred_val &lt;-<span class="st"> </span>pred_val <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb18-46" data-line-number="46"><span class="st">  </span><span class="kw">mutate</span>(</a>
<a class="sourceLine" id="cb18-47" data-line-number="47">    <span class="dt">date =</span> <span class="kw"><a href="https://rdrr.io/r/utils/head.html">tail</a></span>(data_val<span class="op">$</span>date, <span class="kw"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(pred_val)),</a>
<a class="sourceLine" id="cb18-48" data-line-number="48">    <span class="dt">passenger =</span> <span class="kw">rec_rev</span>(passenger, rec)</a>
<a class="sourceLine" id="cb18-49" data-line-number="49">  )</a>
<a class="sourceLine" id="cb18-50" data-line-number="50"></a>
<a class="sourceLine" id="cb18-51" data-line-number="51"><span class="co"># get prediction on test</span></a>
<a class="sourceLine" id="cb18-52" data-line-number="52">pred_test &lt;-<span class="st"> </span>model <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb18-53" data-line-number="53"><span class="st">  </span><span class="kw"><a href="https://rdrr.io/pkg/keras/man/predict_generator.html">predict_generator</a></span>(</a>
<a class="sourceLine" id="cb18-54" data-line-number="54">    <span class="dt">generator =</span> <span class="kw"><a href="../reference/generator_mode.html">generator_mode</a></span>(data_test_gen, <span class="st">"prediction"</span>),</a>
<a class="sourceLine" id="cb18-55" data-line-number="55">    <span class="dt">steps =</span> <span class="kw"><a href="../reference/generator_meta.html">generator_meta</a></span>(data_test_gen, <span class="st">"steps_to_all"</span>)</a>
<a class="sourceLine" id="cb18-56" data-line-number="56">  )</a>
<a class="sourceLine" id="cb18-57" data-line-number="57"></a>
<a class="sourceLine" id="cb18-58" data-line-number="58">pred_test_vec &lt;-<span class="st"> </span><span class="ot">NULL</span></a>
<a class="sourceLine" id="cb18-59" data-line-number="59"></a>
<a class="sourceLine" id="cb18-60" data-line-number="60"><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="kw"><a href="https://rdrr.io/r/base/dim.html">dim</a></span>(pred_test)[<span class="dv">1</span>]) {</a>
<a class="sourceLine" id="cb18-61" data-line-number="61">  </a>
<a class="sourceLine" id="cb18-62" data-line-number="62">  pred_test_vec &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(pred_test_vec, pred_test[i, <span class="dv">1</span><span class="op">:</span><span class="dv">12</span>, <span class="dv">1</span>])</a>
<a class="sourceLine" id="cb18-63" data-line-number="63">  </a>
<a class="sourceLine" id="cb18-64" data-line-number="64">}</a>
<a class="sourceLine" id="cb18-65" data-line-number="65"></a>
<a class="sourceLine" id="cb18-66" data-line-number="66">pred_test &lt;-<span class="st"> </span><span class="kw">tibble</span>(</a>
<a class="sourceLine" id="cb18-67" data-line-number="67">  <span class="dt">passenger =</span> pred_test_vec</a>
<a class="sourceLine" id="cb18-68" data-line-number="68">)</a>
<a class="sourceLine" id="cb18-69" data-line-number="69"></a>
<a class="sourceLine" id="cb18-70" data-line-number="70">pred_test &lt;-<span class="st"> </span>pred_test <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb18-71" data-line-number="71"><span class="st">  </span><span class="kw">mutate</span>(</a>
<a class="sourceLine" id="cb18-72" data-line-number="72">    <span class="dt">date =</span> <span class="kw"><a href="https://rdrr.io/r/utils/head.html">tail</a></span>(data_test<span class="op">$</span>date, <span class="kw"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(pred_test)),</a>
<a class="sourceLine" id="cb18-73" data-line-number="73">    <span class="dt">passenger =</span> <span class="kw">rec_rev</span>(passenger, rec)</a>
<a class="sourceLine" id="cb18-74" data-line-number="74">  )</a></code></pre></div>
<!-- in development -->
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb19-1" data-line-number="1"><span class="co"># wrap-up all data</span></a>
<a class="sourceLine" id="cb19-2" data-line-number="2">data_list &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(</a>
<a class="sourceLine" id="cb19-3" data-line-number="3">  <span class="st">"Actual"</span> =<span class="st"> </span>airpassenger_df,</a>
<a class="sourceLine" id="cb19-4" data-line-number="4">  <span class="st">"Prediction-Train"</span> =<span class="st"> </span>pred_train,</a>
<a class="sourceLine" id="cb19-5" data-line-number="5">  <span class="st">"Prediction-Validation"</span> =<span class="st"> </span><span class="kw">bind_rows</span>(<span class="kw"><a href="https://rdrr.io/r/utils/head.html">tail</a></span>(pred_train, <span class="dv">1</span>), pred_val),</a>
<a class="sourceLine" id="cb19-6" data-line-number="6">  <span class="st">"Prediction-Test"</span> =<span class="st"> </span><span class="kw">bind_rows</span>(<span class="kw"><a href="https://rdrr.io/r/utils/head.html">tail</a></span>(pred_val, <span class="dv">1</span>), pred_test)</a>
<a class="sourceLine" id="cb19-7" data-line-number="7">)</a>
<a class="sourceLine" id="cb19-8" data-line-number="8"></a>
<a class="sourceLine" id="cb19-9" data-line-number="9"><span class="co"># prepare visualization data</span></a>
<a class="sourceLine" id="cb19-10" data-line-number="10">data_viz &lt;-<span class="st"> </span><span class="kw">bind_rows</span>(data_list, <span class="dt">.id =</span> <span class="st">"series"</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb19-11" data-line-number="11"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">series =</span> <span class="kw"><a href="https://rdrr.io/r/base/factor.html">factor</a></span>(series, <span class="dt">levels =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(</a>
<a class="sourceLine" id="cb19-12" data-line-number="12">    <span class="st">"Actual"</span>,</a>
<a class="sourceLine" id="cb19-13" data-line-number="13">    <span class="st">"Prediction-Train"</span>,</a>
<a class="sourceLine" id="cb19-14" data-line-number="14">    <span class="st">"Prediction-Validation"</span>,</a>
<a class="sourceLine" id="cb19-15" data-line-number="15">    <span class="st">"Prediction-Test"</span></a>
<a class="sourceLine" id="cb19-16" data-line-number="16">  )))</a>
<a class="sourceLine" id="cb19-17" data-line-number="17"></a>
<a class="sourceLine" id="cb19-18" data-line-number="18"><span class="co"># visualize</span></a>
<a class="sourceLine" id="cb19-19" data-line-number="19"><span class="kw">ggplot</span>(data_viz, <span class="kw">aes</span>(<span class="dt">x =</span> date, <span class="dt">y =</span> passenger)) <span class="op">+</span></a>
<a class="sourceLine" id="cb19-20" data-line-number="20"><span class="st">  </span><span class="kw">geom_line</span>(<span class="kw">aes</span>(<span class="dt">colour =</span> series)) <span class="op">+</span></a>
<a class="sourceLine" id="cb19-21" data-line-number="21"><span class="st">  </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="ot">NULL</span>, <span class="dt">y =</span> <span class="ot">NULL</span>, <span class="dt">colour =</span> <span class="ot">NULL</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb19-22" data-line-number="22"><span class="st">  </span><span class="kw">theme_minimal</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb19-23" data-line-number="23"><span class="st">  </span><span class="kw">theme</span>(<span class="dt">legend.position =</span> <span class="st">"top"</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb19-24" data-line-number="24"><span class="st">  </span><span class="kw">scale_colour_manual</span>(<span class="dt">values =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(</a>
<a class="sourceLine" id="cb19-25" data-line-number="25">    <span class="st">"Actual"</span> =<span class="st"> "black"</span>,</a>
<a class="sourceLine" id="cb19-26" data-line-number="26">    <span class="st">"Prediction-Train"</span> =<span class="st"> "blue"</span>,</a>
<a class="sourceLine" id="cb19-27" data-line-number="27">    <span class="st">"Prediction-Validation"</span> =<span class="st"> "green"</span>,</a>
<a class="sourceLine" id="cb19-28" data-line-number="28">    <span class="st">"Prediction-Test"</span> =<span class="st"> "red"</span></a>
<a class="sourceLine" id="cb19-29" data-line-number="29">  ))</a></code></pre></div>
<p><img src="timeseries_files/figure-html/unnamed-chunk-21-1.png" width="85%" style="display: block; margin: auto;"></p>
<!-- in development -->
</div>
</div>
<div id="references" class="section level2 unnumbered">
<h2 class="hasAnchor">
<a href="#references" class="anchor"></a>References</h2>
<div id="refs" class="references">
<div id="ref-chollet_tensorflow_2017">
<p>Chollet, F., &amp; Allaire, J. (2017). TensorFlow for r: Time series forecasting with recurrent neural networks. Retrieved from <a href="https://blogs.rstudio.com/tensorflow/posts/2017-12-20-time-series-forecasting-with-recurrent-neural-networks/">https://blogs.rstudio.com/tensorflow/posts/2017-12-20-time-series-forecasting-with-recurrent-neural-networks/</a></p>
</div>
<div id="ref-dancho_tensorflow_2018">
<p>Dancho, M., &amp; Keydana, S. (2018). TensorFlow for r: Predicting sunspot frequency with keras. Retrieved from <a href="https://blogs.rstudio.com/tensorflow/posts/2018-06-25-sunspots-lstm/">https://blogs.rstudio.com/tensorflow/posts/2018-06-25-sunspots-lstm/</a></p>
</div>
<div id="ref-hochreiter_long_1997">
<p>Hochreiter, S., &amp; Schmidhuber, J. (1997). Long short-term memory. <em>Neural Computation</em>, <em>9</em>(8), 1735–1780.</p>
</div>
<div id="ref-laptev_engineering_2017">
<p>Laptev, N., Smyl, S., &amp; Shanmugam, S. (2017). Engineering Extreme Event Forecasting at Uber with Recurrent Neural Networks. <em>Uber Engineering Blog</em>. Retrieved from <a href="https://eng.uber.com/neural-networks/">https://eng.uber.com/neural-networks/</a></p>
</div>
<div id="ref-van_den_oord_wavenet_2016">
<p>Oord, A. van den, &amp; Dieleman, S. (2016). WaveNet: A Generative Model for Raw Audio. <em>Deepmind</em>. Retrieved from <a href="https://deepmind.com/blog/article/wavenet-generative-model-raw-audio">https://deepmind.com/blog/article/wavenet-generative-model-raw-audio</a></p>
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">

        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#introduction">Introduction</a></li>
      <li><a href="#practical-example">Practical example</a></li>
      <li><a href="#references">References</a></li>
      </ul>
</div>
      </div>

</div>



      <footer><div class="copyright">
  <p>Developed by <a href="https://bagasbgy.com">R. Dimas Bagas Herlambang</a>.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.4.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
