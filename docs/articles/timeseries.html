<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Data Generator for Supervised Time Series • kerasgenerator</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="../bgypkg.css" rel="stylesheet">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/all.min.css" integrity="sha256-nAmazAk6vS34Xqo0BSrTb+abbtFlgsFK7NKSi6o7Y78=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/v4-shims.min.css" integrity="sha256-6qHlizsOWFskGlwVOKuns+D1nB6ssZrHQrNj1wGplHc=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/headroom.min.js" integrity="sha256-DJFC1kqIhelURkuza0AvYal5RxMtpzLjFhsnVIeuk+U=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><link href="../bgypkg-2.css" rel="stylesheet">
<meta property="og:title" content="Data Generator for Supervised Time Series">
<meta property="og:description" content="">
<meta property="og:image" content="https://kerasgenerator.bagasbgy.com/logo.png">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>

      <div class="navbar-brand-container">
        <a class="navbar-brand" href="../index.html">kerasgenerator</a>
        <div class="info">
          <span class="partof">part of <a href="https://bagasbgy.com">bagasbgy's</a></span>
          <span class="version version-danger" data-toggle="tooltip" data-placement="bottom" title="Unreleased version">0.0.0.9000</span>
        </div>
      </div>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav navbar-right">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/timeseries.html">Data Generator for Supervised Time Series</a>
    </li>
  </ul>
</li>
        <li>
  <a href="https://github.com/bagasbgy/kerasgenerator">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Data Generator for Supervised Time Series</h1>
                        <h4 class="author">R. Dimas Bagas Herlambang</h4>
            
            <h4 class="date">October 9, 2019</h4>
      
      
      <div class="hidden name"><code>timeseries.Rmd</code></div>

    </div>

    
    
<div id="introduction" class="section level2">
<h2 class="hasAnchor">
<a href="#introduction" class="anchor"></a>Introduction</h2>
<p>Time series and forecasting using Deep Learning approach is gaining more popularity recently. From classic Recurrent Neural Network (RNN) implementation, like Long Short-Term Memory <span class="citation">(Hochreiter &amp; Schmidhuber, <a href="#ref-hochreiter_long_1997">1997</a>)</span> which adopted by some big names like Uber <span class="citation">(Laptev, Smyl, &amp; Shanmugam, <a href="#ref-laptev_engineering_2017">2017</a>)</span>, to some unorthodox approach like WaveNet <span class="citation">(Oord &amp; Dieleman, <a href="#ref-van_den_oord_wavenet_2016">2016</a>)</span>; all of these huge breakthrough show us that Deep Learning approaches are very promising for solving time series and forecasting problems. Yet, supervised time series data generator is still getting less attention, and many available resources don’t have a clear consensus regarding the standard.</p>
<p>To address this issue, <code>kerasgenerator</code> provided <code><a href="../reference/flow_series_from_dataframe.html">flow_series_from_dataframe()</a></code> function to helps us preparing the data generation process for supervised time series problems. In this article, we will going through some basic supervised time series parameters explanations, which also complemented with an univariate time series data as an example.</p>
<p><strong>Note</strong> that, actually, there are several articles that already addressing similar examples; and highly recommended to read! Some of those articles are including those by Chollet and Allaire <span class="citation">(<a href="#ref-chollet_tensorflow_2017">2017</a>)</span>, and Dancho and Keydana <span class="citation">(<a href="#ref-dancho_tensorflow_2018">2018</a>)</span>. Thus, this article is intended to help us understand more the data generation process through visualizations and animations, which inline with the parameters that would be used inside the <code><a href="../reference/flow_series_from_dataframe.html">flow_series_from_dataframe()</a></code> funciton.</p>
<div id="libraries-used" class="section level3">
<h3 class="hasAnchor">
<a href="#libraries-used" class="anchor"></a>Libraries used</h3>
<p>Throughout, we will going through some implementation example. For demonstration, we will use several libraries:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="co"># import libs</span></a>
<a class="sourceLine" id="cb1-2" data-line-number="2"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(keras)</a>
<a class="sourceLine" id="cb1-3" data-line-number="3"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(kerasgenerator)</a>
<a class="sourceLine" id="cb1-4" data-line-number="4"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(lubridate)</a>
<a class="sourceLine" id="cb1-5" data-line-number="5"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(tidymodels)</a>
<a class="sourceLine" id="cb1-6" data-line-number="6"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(tidyverse)</a></code></pre></div>
</div>
<div id="example-problems" class="section level3">
<h3 class="hasAnchor">
<a href="#example-problems" class="anchor"></a>Example problems</h3>
<p>We will use <strong><code>AirPassengers</code></strong> dataset as an example problem, which already available in every base R installation. This dataset represent an univariate monthly time series and very suitable for basic example: <strong>“Can we predict the number of international airline passengers in the future based on its historical data?”</strong></p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" data-line-number="1"><span class="co"># example data</span></a>
<a class="sourceLine" id="cb2-2" data-line-number="2">airpassenger_df &lt;-<span class="st"> </span><span class="kw">as_tibble</span>(AirPassengers) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb2-3" data-line-number="3"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">date =</span> <span class="kw"><a href="https://rdrr.io/r/base/seq.Date.html">seq.Date</a></span>(<span class="kw"><a href="http://lubridate.tidyverse.org/reference/ymd.html">ymd</a></span>(<span class="st">"1949-01-01"</span>), <span class="dt">by =</span> <span class="st">"1 month"</span>, <span class="dt">length.out =</span> <span class="kw"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(.))) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb2-4" data-line-number="4"><span class="st">  </span><span class="kw">select</span>(date, <span class="dt">passenger =</span> x)</a>
<a class="sourceLine" id="cb2-5" data-line-number="5"></a>
<a class="sourceLine" id="cb2-6" data-line-number="6"><span class="co"># quick check</span></a>
<a class="sourceLine" id="cb2-7" data-line-number="7"><span class="kw">ggplot</span>(airpassenger_df, <span class="kw">aes</span>(<span class="dt">x =</span> date, <span class="dt">y =</span> passenger)) <span class="op">+</span></a>
<a class="sourceLine" id="cb2-8" data-line-number="8"><span class="st">  </span><span class="kw">geom_line</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb2-9" data-line-number="9"><span class="st">  </span><span class="kw">labs</span>(<span class="dt">title =</span> <span class="st">"Number of international airline passengers"</span>, <span class="dt">x =</span> <span class="ot">NULL</span>, <span class="dt">y =</span> <span class="ot">NULL</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb2-10" data-line-number="10"><span class="st">  </span><span class="kw">theme_minimal</span>()</a></code></pre></div>
<p><img src="timeseries_files/figure-html/unnamed-chunk-1-1.png" width="85%" style="display: block; margin: auto;"></p>
</div>
<div id="supervised-time-series" class="section level3">
<h3 class="hasAnchor">
<a href="#supervised-time-series" class="anchor"></a>Supervised time series</h3>
<p>There are a slight differences between our “usual” time series with supervised time series approach. In classical time series models, we are seeking the best fit to the supplied time series, then make those fitted model to create a forecast. For supervised time series, we are going to make a model through supervised approach: <strong>given a set of past values (<code>x</code>), can we make a model to predict the future values (<code>y</code>)?</strong> So instead of just giving the time series, we should also define the <code>x</code> as our past values, and <code>y</code> as our future values from the specified time series.</p>
<p>Let’s start by the <code>x</code>. The <code>x</code> values are intended to be our predictors. Generally speaking, like in every supervised problem, the <code>x</code> could be from one variable–as in univariate time series problems–or from multiple variables–as in multivariate time series problems.</p>
<p>However, there are some important parameters that we need to set to make our <code>x</code> represent a proper “time series predictor” in our supervised time series problems. These parameters are <code>lookback</code> and <code>timesteps</code>:</p>
<ul>
<li>
<strong><code>lookback</code></strong>: How much we should lookback for our last <code>x</code> value to predict the <code>y</code>?</li>
<li>
<strong><code>timesteps</code></strong>: How many <code>x</code> we will consider to predict the <code>y</code>?</li>
</ul>
<p>To put it simply, let’s say for our monthly <code>airpassenger_df</code> data we want to predict the value of <code>passenger</code> in January 1951 using last 24 historical data–January 1949 to December 1950–then we will use <code>lookback = 1</code> and <code>timesteps = 24</code>. For another example, we want to predict the value in January 1951 using only the data from January 1950–the exact same month but in the previous year–then we will use <code>lookback = 12</code> and <code>timesteps = 1</code>.</p>
<p>We will see some example animation for these settings, but we need to understand the parameters regarding our <code>y</code> values first. In supervised time series, the <code>y</code> parameters could help us determine the forecast horizon, as in <code>h</code> parameter inside <a href="http://pkg.robjhyndman.com/forecast/reference/forecast.html"><code>forecast()</code></a> function. These parameters are <code>length_out</code> and <code>stride</code>:</p>
<ul>
<li>
<strong><code>length_out</code></strong>: How many time ahead that we will predict?</li>
<li>
<strong><code>stride</code></strong>: How much is the sampling rate between consecutive <code>y</code> values?</li>
</ul>
<p>If we combine the <code>x</code> and <code>y</code> parameters, we generalized a supervised time series scenario into: “Given <strong>(<code>timesteps</code> number)</strong> of our <strong>(<code>x</code> variable(s))</strong> in the past, can we predict the value of <strong>(<code>y</code> variable(s))</strong> in the next <strong>(<code>length_out</code>)</strong>?”</p>
<p>Finally, to helps us understand, we will going through several type of supervised time series problems in the following sections.</p>
<div id="many-to-one" class="section level4">
<h4 class="hasAnchor">
<a href="#many-to-one" class="anchor"></a>Many-to-one</h4>
<p><strong>Many-to-one</strong> the most common scenario in supervised time series problem. This scenario requires us to set the number of <code>timesteps &gt; 1</code>, and set the <code>length_out == 1</code>.</p>
<p>For example, in our case, we could set the problem into: “Given <strong>24 month</strong> of our <strong>passenger number</strong> in the past, can we predict the value of <strong>passenger number</strong> in the next <strong>one month?</strong>”. Here is the implementation of this example scenario using <code><a href="../reference/flow_series_from_dataframe.html">flow_series_from_dataframe()</a></code>:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" data-line-number="1"><span class="co"># an example generator settings: many-to-one with stride = 1</span></a>
<a class="sourceLine" id="cb3-2" data-line-number="2">x &lt;-<span class="st"> "passenger"</span></a>
<a class="sourceLine" id="cb3-3" data-line-number="3">y &lt;-<span class="st"> "passenger"</span></a>
<a class="sourceLine" id="cb3-4" data-line-number="4">length_out &lt;-<span class="st"> </span><span class="dv">1</span></a>
<a class="sourceLine" id="cb3-5" data-line-number="5">stride &lt;-<span class="st"> </span><span class="dv">1</span></a>
<a class="sourceLine" id="cb3-6" data-line-number="6">lookback &lt;-<span class="st"> </span><span class="dv">1</span></a>
<a class="sourceLine" id="cb3-7" data-line-number="7">timesteps &lt;-<span class="st"> </span><span class="dv">24</span></a>
<a class="sourceLine" id="cb3-8" data-line-number="8">batch_size &lt;-<span class="st"> </span><span class="dv">12</span></a>
<a class="sourceLine" id="cb3-9" data-line-number="9"></a>
<a class="sourceLine" id="cb3-10" data-line-number="10"><span class="co"># an example generator: many-to-one</span></a>
<a class="sourceLine" id="cb3-11" data-line-number="11">data_gen &lt;-<span class="st"> </span><span class="kw"><a href="../reference/flow_series_from_dataframe.html">flow_series_from_dataframe</a></span>(</a>
<a class="sourceLine" id="cb3-12" data-line-number="12">  <span class="dt">data =</span> airpassenger_df,</a>
<a class="sourceLine" id="cb3-13" data-line-number="13">  <span class="dt">x =</span> x,</a>
<a class="sourceLine" id="cb3-14" data-line-number="14">  <span class="dt">y =</span> y,</a>
<a class="sourceLine" id="cb3-15" data-line-number="15">  <span class="dt">length_out =</span> length_out,</a>
<a class="sourceLine" id="cb3-16" data-line-number="16">  <span class="dt">stride =</span> stride,</a>
<a class="sourceLine" id="cb3-17" data-line-number="17">  <span class="dt">lookback =</span> lookback,</a>
<a class="sourceLine" id="cb3-18" data-line-number="18">  <span class="dt">timesteps =</span> timesteps,</a>
<a class="sourceLine" id="cb3-19" data-line-number="19">  <span class="dt">batch_size =</span> batch_size,</a>
<a class="sourceLine" id="cb3-20" data-line-number="20">  <span class="dt">mode =</span> <span class="st">"training"</span></a>
<a class="sourceLine" id="cb3-21" data-line-number="21">)</a>
<a class="sourceLine" id="cb3-22" data-line-number="22"></a>
<a class="sourceLine" id="cb3-23" data-line-number="23"><span class="co"># quick check</span></a>
<a class="sourceLine" id="cb3-24" data-line-number="24"><span class="kw"><a href="https://rdrr.io/r/utils/str.html">str</a></span>(<span class="kw">data_gen</span>())</a>
<a class="sourceLine" id="cb3-25" data-line-number="25"><span class="co">#&gt; List of 2</span></a>
<a class="sourceLine" id="cb3-26" data-line-number="26"><span class="co">#&gt;  $ : num [1:12, 1:24, 1] 112 118 132 129 121 135 148 148 136 119 ...</span></a>
<a class="sourceLine" id="cb3-27" data-line-number="27"><span class="co">#&gt;  $ : num [1:12, 1, 1] 145 150 178 163 172 178 199 199 184 162 ...</span></a></code></pre></div>
<p>With this scenario, the data generator would convert our data into batches and samples like animation below:</p>
<p><img src="timeseries_files/figure-html/unnamed-chunk-3-1.gif" width="85%" style="display: block; margin: auto;"></p>
</div>
<div id="many-to-many" class="section level4">
<h4 class="hasAnchor">
<a href="#many-to-many" class="anchor"></a>Many-to-many</h4>
<p><strong>Many-to-many</strong> is another common scenario in supervised time series problem. This scenario requires us to set the number of <code>timesteps &gt; 1</code>, and set the <code>length_out &gt; 1</code>.</p>
<p>For example, in our case, we could set the problem into: “Given <strong>24 month</strong> of our <strong>passenger number</strong> in the past, can we predict the value of <strong>passenger number</strong> in the next <strong>12 months?</strong>”. However, note that the sampling rate for our <code>y</code> is still controlled by the <code>stride</code> parameter. So the common options for the sampling rate are either to train by <code>stride = 1</code>, which is one month sliding window in our case, or <code>stride &gt; 1</code>, which, for example, could be 12 months sliding window.</p>
<p>Here is the implementation of this example scenario using <code><a href="../reference/flow_series_from_dataframe.html">flow_series_from_dataframe()</a></code>, with <code>stride = 1</code>:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" data-line-number="1"><span class="co"># an example generator settings: many-to-many with stride = 1</span></a>
<a class="sourceLine" id="cb4-2" data-line-number="2">x &lt;-<span class="st"> "passenger"</span></a>
<a class="sourceLine" id="cb4-3" data-line-number="3">y &lt;-<span class="st"> "passenger"</span></a>
<a class="sourceLine" id="cb4-4" data-line-number="4">length_out &lt;-<span class="st"> </span><span class="dv">12</span></a>
<a class="sourceLine" id="cb4-5" data-line-number="5">stride &lt;-<span class="st"> </span><span class="dv">1</span></a>
<a class="sourceLine" id="cb4-6" data-line-number="6">lookback &lt;-<span class="st"> </span><span class="dv">1</span></a>
<a class="sourceLine" id="cb4-7" data-line-number="7">timesteps &lt;-<span class="st"> </span><span class="dv">24</span></a>
<a class="sourceLine" id="cb4-8" data-line-number="8">batch_size &lt;-<span class="st"> </span><span class="dv">12</span></a>
<a class="sourceLine" id="cb4-9" data-line-number="9"></a>
<a class="sourceLine" id="cb4-10" data-line-number="10"><span class="co"># an example generator: many-to-many, stride = 1</span></a>
<a class="sourceLine" id="cb4-11" data-line-number="11">data_gen &lt;-<span class="st"> </span><span class="kw"><a href="../reference/flow_series_from_dataframe.html">flow_series_from_dataframe</a></span>(</a>
<a class="sourceLine" id="cb4-12" data-line-number="12">  <span class="dt">data =</span> airpassenger_df,</a>
<a class="sourceLine" id="cb4-13" data-line-number="13">  <span class="dt">x =</span> x,</a>
<a class="sourceLine" id="cb4-14" data-line-number="14">  <span class="dt">y =</span> y,</a>
<a class="sourceLine" id="cb4-15" data-line-number="15">  <span class="dt">length_out =</span> length_out,</a>
<a class="sourceLine" id="cb4-16" data-line-number="16">  <span class="dt">stride =</span> stride,</a>
<a class="sourceLine" id="cb4-17" data-line-number="17">  <span class="dt">lookback =</span> lookback,</a>
<a class="sourceLine" id="cb4-18" data-line-number="18">  <span class="dt">timesteps =</span> timesteps,</a>
<a class="sourceLine" id="cb4-19" data-line-number="19">  <span class="dt">batch_size =</span> batch_size,</a>
<a class="sourceLine" id="cb4-20" data-line-number="20">  <span class="dt">mode =</span> <span class="st">"training"</span></a>
<a class="sourceLine" id="cb4-21" data-line-number="21">)</a>
<a class="sourceLine" id="cb4-22" data-line-number="22"></a>
<a class="sourceLine" id="cb4-23" data-line-number="23"><span class="co"># quick check</span></a>
<a class="sourceLine" id="cb4-24" data-line-number="24"><span class="kw"><a href="https://rdrr.io/r/utils/str.html">str</a></span>(<span class="kw">data_gen</span>())</a>
<a class="sourceLine" id="cb4-25" data-line-number="25"><span class="co">#&gt; List of 2</span></a>
<a class="sourceLine" id="cb4-26" data-line-number="26"><span class="co">#&gt;  $ : num [1:12, 1:24, 1] 112 118 132 129 121 135 148 148 136 119 ...</span></a>
<a class="sourceLine" id="cb4-27" data-line-number="27"><span class="co">#&gt;  $ : num [1:12, 1:12, 1] 145 150 178 163 172 178 199 199 184 162 ...</span></a></code></pre></div>
<p>With this scenario, the data generator would convert our data into batches and samples like animation below:</p>
<p><img src="timeseries_files/figure-html/unnamed-chunk-5-1.gif" width="85%" style="display: block; margin: auto;"></p>
<p>And for <code>stride = 12</code>, here is the implementation:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" data-line-number="1"><span class="co"># an example generator settings: many-to-many with stride = 12</span></a>
<a class="sourceLine" id="cb5-2" data-line-number="2">x &lt;-<span class="st"> "passenger"</span></a>
<a class="sourceLine" id="cb5-3" data-line-number="3">y &lt;-<span class="st"> "passenger"</span></a>
<a class="sourceLine" id="cb5-4" data-line-number="4">length_out &lt;-<span class="st"> </span><span class="dv">12</span></a>
<a class="sourceLine" id="cb5-5" data-line-number="5">stride &lt;-<span class="st"> </span><span class="dv">12</span></a>
<a class="sourceLine" id="cb5-6" data-line-number="6">lookback &lt;-<span class="st"> </span><span class="dv">1</span></a>
<a class="sourceLine" id="cb5-7" data-line-number="7">timesteps &lt;-<span class="st"> </span><span class="dv">24</span></a>
<a class="sourceLine" id="cb5-8" data-line-number="8">batch_size &lt;-<span class="st"> </span><span class="dv">2</span></a>
<a class="sourceLine" id="cb5-9" data-line-number="9"></a>
<a class="sourceLine" id="cb5-10" data-line-number="10"><span class="co"># an example generator: many-to-many, stride = 12</span></a>
<a class="sourceLine" id="cb5-11" data-line-number="11">data_gen &lt;-<span class="st"> </span><span class="kw"><a href="../reference/flow_series_from_dataframe.html">flow_series_from_dataframe</a></span>(</a>
<a class="sourceLine" id="cb5-12" data-line-number="12">  <span class="dt">data =</span> airpassenger_df,</a>
<a class="sourceLine" id="cb5-13" data-line-number="13">  <span class="dt">x =</span> x,</a>
<a class="sourceLine" id="cb5-14" data-line-number="14">  <span class="dt">y =</span> y,</a>
<a class="sourceLine" id="cb5-15" data-line-number="15">  <span class="dt">length_out =</span> length_out,</a>
<a class="sourceLine" id="cb5-16" data-line-number="16">  <span class="dt">stride =</span> stride,</a>
<a class="sourceLine" id="cb5-17" data-line-number="17">  <span class="dt">lookback =</span> lookback,</a>
<a class="sourceLine" id="cb5-18" data-line-number="18">  <span class="dt">timesteps =</span> timesteps,</a>
<a class="sourceLine" id="cb5-19" data-line-number="19">  <span class="dt">batch_size =</span> batch_size,</a>
<a class="sourceLine" id="cb5-20" data-line-number="20">  <span class="dt">mode =</span> <span class="st">"training"</span></a>
<a class="sourceLine" id="cb5-21" data-line-number="21">)</a>
<a class="sourceLine" id="cb5-22" data-line-number="22"></a>
<a class="sourceLine" id="cb5-23" data-line-number="23"><span class="co"># quick check</span></a>
<a class="sourceLine" id="cb5-24" data-line-number="24"><span class="kw"><a href="https://rdrr.io/r/utils/str.html">str</a></span>(<span class="kw">data_gen</span>())</a>
<a class="sourceLine" id="cb5-25" data-line-number="25"><span class="co">#&gt; List of 2</span></a>
<a class="sourceLine" id="cb5-26" data-line-number="26"><span class="co">#&gt;  $ : num [1:2, 1:24, 1] 112 115 118 126 132 141 129 135 121 125 ...</span></a>
<a class="sourceLine" id="cb5-27" data-line-number="27"><span class="co">#&gt;  $ : num [1:2, 1:12, 1] 145 171 150 180 178 193 163 181 172 183 ...</span></a></code></pre></div>
<p>This setting would resulting a similar behaviour to previous example, but notice the different sampling rate in animation below:</p>
<p><img src="timeseries_files/figure-html/unnamed-chunk-7-1.gif" width="85%" style="display: block; margin: auto;"></p>
</div>
</div>
</div>
<div id="practical-example" class="section level2">
<h2 class="hasAnchor">
<a href="#practical-example" class="anchor"></a>Practical example</h2>
<p>For the sake of clarity, we will going through some implementation examples. The examples will cover two topics: <strong>many-to-one</strong> and <strong>many-to-many</strong> models using <code>keras</code>.</p>
<div id="many-to-one-1" class="section level3">
<h3 class="hasAnchor">
<a href="#many-to-one-1" class="anchor"></a>Many-to-one</h3>
<p>In this section, let’s try the implementation of using <code><a href="../reference/flow_series_from_dataframe.html">flow_series_from_dataframe()</a></code> for <strong>many-to-one</strong> model.</p>
<p>First of all, it’s highly recommended to setup the supervised parameters first:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" data-line-number="1"><span class="co"># supervised time series settings</span></a>
<a class="sourceLine" id="cb6-2" data-line-number="2">x &lt;-<span class="st"> "passenger"</span></a>
<a class="sourceLine" id="cb6-3" data-line-number="3">y &lt;-<span class="st"> "passenger"</span></a>
<a class="sourceLine" id="cb6-4" data-line-number="4">length_out &lt;-<span class="st"> </span><span class="dv">1</span></a>
<a class="sourceLine" id="cb6-5" data-line-number="5">stride &lt;-<span class="st"> </span><span class="dv">1</span></a>
<a class="sourceLine" id="cb6-6" data-line-number="6">lookback &lt;-<span class="st"> </span><span class="dv">1</span></a>
<a class="sourceLine" id="cb6-7" data-line-number="7">timesteps &lt;-<span class="st"> </span><span class="dv">24</span></a></code></pre></div>
<p>As in usual deep learning routines, we need to prepare some datasets: <strong>train</strong>, <strong>validation</strong>, and <strong>test</strong>. The sample splitting process is quite tricky for supervised time series model. As a reference, for 12 months sample for both validation and test dataset, you can refer to this process:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb7-1" data-line-number="1"><span class="co"># validation and test sample size</span></a>
<a class="sourceLine" id="cb7-2" data-line-number="2">val_size &lt;-<span class="st"> </span><span class="dv">12</span> <span class="op">*</span><span class="st"> </span>length_out</a>
<a class="sourceLine" id="cb7-3" data-line-number="3">test_size &lt;-<span class="st"> </span><span class="dv">12</span> <span class="op">*</span><span class="st"> </span>length_out</a>
<a class="sourceLine" id="cb7-4" data-line-number="4"></a>
<a class="sourceLine" id="cb7-5" data-line-number="5"><span class="co"># test split</span></a>
<a class="sourceLine" id="cb7-6" data-line-number="6">data_test &lt;-<span class="st"> </span>airpassenger_df <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb7-7" data-line-number="7"><span class="st">  </span><span class="kw"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(<span class="kw">row_number</span>() <span class="op">&gt;</span><span class="st"> </span><span class="kw">n</span>() <span class="op">-</span><span class="st"> </span>test_size <span class="op">-</span><span class="st"> </span>lookback <span class="op">-</span><span class="st"> </span>timesteps <span class="op">+</span><span class="st"> </span><span class="dv">1</span>)</a>
<a class="sourceLine" id="cb7-8" data-line-number="8"></a>
<a class="sourceLine" id="cb7-9" data-line-number="9"><span class="co"># initial train after test-split</span></a>
<a class="sourceLine" id="cb7-10" data-line-number="10">data_train &lt;-<span class="st"> </span>airpassenger_df <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb7-11" data-line-number="11"><span class="st">  </span><span class="kw"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(<span class="kw">row_number</span>() <span class="op">&lt;=</span><span class="st"> </span><span class="kw">n</span>() <span class="op">-</span><span class="st"> </span>test_size)</a>
<a class="sourceLine" id="cb7-12" data-line-number="12"></a>
<a class="sourceLine" id="cb7-13" data-line-number="13"><span class="co"># validation split</span></a>
<a class="sourceLine" id="cb7-14" data-line-number="14">data_val &lt;-<span class="st"> </span>data_train <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb7-15" data-line-number="15"><span class="st">  </span><span class="kw"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(<span class="kw">row_number</span>() <span class="op">&gt;</span><span class="st"> </span><span class="kw">n</span>() <span class="op">-</span><span class="st"> </span>val_size <span class="op">-</span><span class="st"> </span>lookback <span class="op">-</span><span class="st"> </span>timesteps <span class="op">+</span><span class="st"> </span><span class="dv">1</span>)</a>
<a class="sourceLine" id="cb7-16" data-line-number="16"></a>
<a class="sourceLine" id="cb7-17" data-line-number="17"><span class="co"># final train after validation-split</span></a>
<a class="sourceLine" id="cb7-18" data-line-number="18">data_train &lt;-<span class="st"> </span>data_train <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb7-19" data-line-number="19"><span class="st">  </span><span class="kw"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(<span class="kw">row_number</span>() <span class="op">&lt;=</span><span class="st"> </span><span class="kw">n</span>() <span class="op">-</span><span class="st"> </span>val_size)</a></code></pre></div>
<p>Before we pass the datasets, let’s do a quick preprocess using <a href="https://tidymodels.github.io/recipes/"><code>recipes</code></a>:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb8-1" data-line-number="1"><span class="co"># create preprocess recipe</span></a>
<a class="sourceLine" id="cb8-2" data-line-number="2">rec &lt;-<span class="st"> </span><span class="kw">recipe</span>(passenger <span class="op">~</span><span class="st"> </span>., <span class="dt">data =</span> data_train) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb8-3" data-line-number="3"><span class="st">  </span><span class="kw">step_rm</span>(date) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb8-4" data-line-number="4"><span class="st">  </span><span class="kw">step_log</span>(passenger) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb8-5" data-line-number="5"><span class="st">  </span><span class="kw">step_normalize</span>(passenger) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb8-6" data-line-number="6"><span class="st">  </span><span class="kw">prep</span>()</a>
<a class="sourceLine" id="cb8-7" data-line-number="7"></a>
<a class="sourceLine" id="cb8-8" data-line-number="8"><span class="co"># prepare recipes-revert functions</span></a>
<a class="sourceLine" id="cb8-9" data-line-number="9">rec_rev &lt;-<span class="st"> </span><span class="cf">function</span>(x, rec) {</a>
<a class="sourceLine" id="cb8-10" data-line-number="10"></a>
<a class="sourceLine" id="cb8-11" data-line-number="11">  means &lt;-<span class="st"> </span>rec<span class="op">$</span>steps[[<span class="dv">3</span>]]<span class="op">$</span>means[[<span class="st">"passenger"</span>]]</a>
<a class="sourceLine" id="cb8-12" data-line-number="12">  sds &lt;-<span class="st"> </span>rec<span class="op">$</span>steps[[<span class="dv">3</span>]]<span class="op">$</span>sds[[<span class="st">"passenger"</span>]]</a>
<a class="sourceLine" id="cb8-13" data-line-number="13"></a>
<a class="sourceLine" id="cb8-14" data-line-number="14">  x &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/Log.html">exp</a></span>(x <span class="op">*</span><span class="st"> </span>sds <span class="op">+</span><span class="st"> </span>means)</a>
<a class="sourceLine" id="cb8-15" data-line-number="15">  x &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/Round.html">round</a></span>(x)</a>
<a class="sourceLine" id="cb8-16" data-line-number="16">  x &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span>(x <span class="op">&lt;</span><span class="st"> </span><span class="dv">0</span>, <span class="dv">0</span>, x)</a>
<a class="sourceLine" id="cb8-17" data-line-number="17"></a>
<a class="sourceLine" id="cb8-18" data-line-number="18">  x</a>
<a class="sourceLine" id="cb8-19" data-line-number="19"></a>
<a class="sourceLine" id="cb8-20" data-line-number="20">}</a>
<a class="sourceLine" id="cb8-21" data-line-number="21"></a>
<a class="sourceLine" id="cb8-22" data-line-number="22"><span class="co"># get all preprocessed data</span></a>
<a class="sourceLine" id="cb8-23" data-line-number="23">data_train_prep &lt;-<span class="st"> </span><span class="kw">juice</span>(rec)</a>
<a class="sourceLine" id="cb8-24" data-line-number="24">data_val_prep &lt;-<span class="st"> </span><span class="kw">bake</span>(rec, data_val)</a>
<a class="sourceLine" id="cb8-25" data-line-number="25">data_test_prep &lt;-<span class="st"> </span><span class="kw">bake</span>(rec, data_test)</a></code></pre></div>
<p>Now we can pass all of specified parameters into the generator for each datasets:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb9-1" data-line-number="1"><span class="co"># generator settings</span></a>
<a class="sourceLine" id="cb9-2" data-line-number="2">batch_size &lt;-<span class="st"> </span><span class="dv">12</span></a>
<a class="sourceLine" id="cb9-3" data-line-number="3"></a>
<a class="sourceLine" id="cb9-4" data-line-number="4"><span class="co"># train-val-test generator</span></a>
<a class="sourceLine" id="cb9-5" data-line-number="5">data_train_gen &lt;-<span class="st"> </span><span class="kw"><a href="../reference/flow_series_from_dataframe.html">flow_series_from_dataframe</a></span>(</a>
<a class="sourceLine" id="cb9-6" data-line-number="6">  <span class="dt">data =</span> data_train_prep,</a>
<a class="sourceLine" id="cb9-7" data-line-number="7">  <span class="dt">x =</span> x,</a>
<a class="sourceLine" id="cb9-8" data-line-number="8">  <span class="dt">y =</span> y,</a>
<a class="sourceLine" id="cb9-9" data-line-number="9">  <span class="dt">length_out =</span> length_out,</a>
<a class="sourceLine" id="cb9-10" data-line-number="10">  <span class="dt">stride =</span> stride,</a>
<a class="sourceLine" id="cb9-11" data-line-number="11">  <span class="dt">lookback =</span> lookback,</a>
<a class="sourceLine" id="cb9-12" data-line-number="12">  <span class="dt">timesteps =</span> timesteps,</a>
<a class="sourceLine" id="cb9-13" data-line-number="13">  <span class="dt">batch_size =</span> batch_size,</a>
<a class="sourceLine" id="cb9-14" data-line-number="14">  <span class="dt">mode =</span> <span class="st">"training"</span></a>
<a class="sourceLine" id="cb9-15" data-line-number="15">)</a>
<a class="sourceLine" id="cb9-16" data-line-number="16"></a>
<a class="sourceLine" id="cb9-17" data-line-number="17">data_val_gen &lt;-<span class="st"> </span><span class="kw"><a href="../reference/flow_series_from_dataframe.html">flow_series_from_dataframe</a></span>(</a>
<a class="sourceLine" id="cb9-18" data-line-number="18">  <span class="dt">data =</span> data_val_prep,</a>
<a class="sourceLine" id="cb9-19" data-line-number="19">  <span class="dt">x =</span> x,</a>
<a class="sourceLine" id="cb9-20" data-line-number="20">  <span class="dt">y =</span> y,</a>
<a class="sourceLine" id="cb9-21" data-line-number="21">  <span class="dt">length_out =</span> length_out,</a>
<a class="sourceLine" id="cb9-22" data-line-number="22">  <span class="dt">stride =</span> stride,</a>
<a class="sourceLine" id="cb9-23" data-line-number="23">  <span class="dt">lookback =</span> lookback,</a>
<a class="sourceLine" id="cb9-24" data-line-number="24">  <span class="dt">timesteps =</span> timesteps,</a>
<a class="sourceLine" id="cb9-25" data-line-number="25">  <span class="dt">batch_size =</span> batch_size,</a>
<a class="sourceLine" id="cb9-26" data-line-number="26">  <span class="dt">mode =</span> <span class="st">"training"</span></a>
<a class="sourceLine" id="cb9-27" data-line-number="27">)</a>
<a class="sourceLine" id="cb9-28" data-line-number="28"></a>
<a class="sourceLine" id="cb9-29" data-line-number="29">data_test_gen &lt;-<span class="st"> </span><span class="kw"><a href="../reference/flow_series_from_dataframe.html">flow_series_from_dataframe</a></span>(</a>
<a class="sourceLine" id="cb9-30" data-line-number="30">  <span class="dt">data =</span> data_test_prep,</a>
<a class="sourceLine" id="cb9-31" data-line-number="31">  <span class="dt">x =</span> x,</a>
<a class="sourceLine" id="cb9-32" data-line-number="32">  <span class="dt">y =</span> y,</a>
<a class="sourceLine" id="cb9-33" data-line-number="33">  <span class="dt">length_out =</span> length_out,</a>
<a class="sourceLine" id="cb9-34" data-line-number="34">  <span class="dt">stride =</span> stride,</a>
<a class="sourceLine" id="cb9-35" data-line-number="35">  <span class="dt">lookback =</span> lookback,</a>
<a class="sourceLine" id="cb9-36" data-line-number="36">  <span class="dt">timesteps =</span> timesteps,</a>
<a class="sourceLine" id="cb9-37" data-line-number="37">  <span class="dt">batch_size =</span> batch_size,</a>
<a class="sourceLine" id="cb9-38" data-line-number="38">  <span class="dt">mode =</span> <span class="st">"training"</span></a>
<a class="sourceLine" id="cb9-39" data-line-number="39">)</a></code></pre></div>
<p>For demonstration purpose, we will use a CNN (Convolutional Neural Networks) -based architecture. Notice how the shapes in input and output layers related to our supervised time series parameters:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb10-1" data-line-number="1"><span class="co"># define input layer</span></a>
<a class="sourceLine" id="cb10-2" data-line-number="2">input &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/pkg/keras/man/layer_input.html">layer_input</a></span>(<span class="dt">name =</span> <span class="st">"input"</span>, <span class="dt">shape =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(timesteps, <span class="kw"><a href="https://rdrr.io/r/base/length.html">length</a></span>(x)))</a>
<a class="sourceLine" id="cb10-3" data-line-number="3"></a>
<a class="sourceLine" id="cb10-4" data-line-number="4"><span class="co"># define hidden layers</span></a>
<a class="sourceLine" id="cb10-5" data-line-number="5">cnn1 &lt;-<span class="st"> </span>input <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb10-6" data-line-number="6"><span class="st">  </span><span class="kw"><a href="https://rdrr.io/pkg/keras/man/layer_conv_1d.html">layer_conv_1d</a></span>(<span class="dt">name =</span> <span class="st">"cnn_1_1"</span>, <span class="dt">filters =</span> <span class="dv">16</span>, <span class="dt">kernel_size =</span> <span class="dv">12</span>, <span class="dt">padding =</span> <span class="st">"same"</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb10-7" data-line-number="7"><span class="st">  </span><span class="kw"><a href="https://rdrr.io/pkg/keras/man/layer_activation_leaky_relu.html">layer_activation_leaky_relu</a></span>(<span class="dt">name =</span> <span class="st">"cnn_1_1_act"</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb10-8" data-line-number="8"><span class="st">  </span><span class="kw"><a href="https://rdrr.io/pkg/keras/man/layer_flatten.html">layer_flatten</a></span>(<span class="dt">name =</span> <span class="st">"cnn_1_1_flat"</span>)</a>
<a class="sourceLine" id="cb10-9" data-line-number="9"></a>
<a class="sourceLine" id="cb10-10" data-line-number="10">cnn2 &lt;-<span class="st"> </span>input <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb10-11" data-line-number="11"><span class="st">  </span><span class="kw"><a href="https://rdrr.io/pkg/keras/man/layer_conv_1d.html">layer_conv_1d</a></span>(<span class="dt">name =</span> <span class="st">"cnn_2_1"</span>, <span class="dt">filters =</span> <span class="dv">16</span>, <span class="dt">kernel_size =</span> <span class="dv">3</span>, <span class="dt">padding =</span> <span class="st">"same"</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb10-12" data-line-number="12"><span class="st">  </span><span class="kw"><a href="https://rdrr.io/pkg/keras/man/layer_activation_leaky_relu.html">layer_activation_leaky_relu</a></span>(<span class="dt">name =</span> <span class="st">"cnn_2_1_act"</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb10-13" data-line-number="13"><span class="st">  </span><span class="kw"><a href="https://rdrr.io/pkg/keras/man/layer_flatten.html">layer_flatten</a></span>(<span class="dt">name =</span> <span class="st">"cnn_2_1_flat"</span>)</a>
<a class="sourceLine" id="cb10-14" data-line-number="14"></a>
<a class="sourceLine" id="cb10-15" data-line-number="15">cnn &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(cnn1, cnn2) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb10-16" data-line-number="16"><span class="st">  </span><span class="kw"><a href="https://rdrr.io/pkg/keras/man/layer_concatenate.html">layer_concatenate</a></span>(<span class="dt">name =</span> <span class="st">"cnn_concat"</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb10-17" data-line-number="17"><span class="st">  </span><span class="kw"><a href="https://rdrr.io/pkg/keras/man/layer_dropout.html">layer_dropout</a></span>(<span class="dt">name =</span> <span class="st">"cnn_dp"</span>, <span class="dt">rate =</span> <span class="fl">0.1</span>)</a>
<a class="sourceLine" id="cb10-18" data-line-number="18"></a>
<a class="sourceLine" id="cb10-19" data-line-number="19">fc &lt;-<span class="st"> </span>cnn <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb10-20" data-line-number="20"><span class="st">  </span><span class="kw"><a href="https://rdrr.io/pkg/keras/man/layer_dense.html">layer_dense</a></span>(<span class="dt">name =</span> <span class="st">"dense_1"</span>, <span class="dt">units =</span> <span class="dv">32</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb10-21" data-line-number="21"><span class="st">  </span><span class="kw"><a href="https://rdrr.io/pkg/keras/man/layer_activation_leaky_relu.html">layer_activation_leaky_relu</a></span>(<span class="dt">name =</span> <span class="st">"dense_1_act"</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb10-22" data-line-number="22"><span class="st">  </span><span class="kw"><a href="https://rdrr.io/pkg/keras/man/layer_dropout.html">layer_dropout</a></span>(<span class="dt">name =</span> <span class="st">"dense_1_dp"</span>, <span class="dt">rate =</span> <span class="fl">0.1</span>)</a>
<a class="sourceLine" id="cb10-23" data-line-number="23"></a>
<a class="sourceLine" id="cb10-24" data-line-number="24"><span class="co"># define output layers</span></a>
<a class="sourceLine" id="cb10-25" data-line-number="25">output &lt;-<span class="st"> </span>fc <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb10-26" data-line-number="26"><span class="st">  </span><span class="kw"><a href="https://rdrr.io/pkg/keras/man/layer_dense.html">layer_dense</a></span>(<span class="dt">name =</span> <span class="st">"output"</span>, <span class="dt">units =</span> <span class="kw"><a href="https://rdrr.io/r/base/length.html">length</a></span>(y) <span class="op">*</span><span class="st"> </span>length_out) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb10-27" data-line-number="27"><span class="st">  </span><span class="kw"><a href="https://rdrr.io/pkg/keras/man/layer_reshape.html">layer_reshape</a></span>(<span class="dt">name =</span> <span class="st">"output_reshape"</span>, <span class="dt">target_shape =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(length_out, <span class="kw"><a href="https://rdrr.io/r/base/length.html">length</a></span>(y)))</a>
<a class="sourceLine" id="cb10-28" data-line-number="28"></a>
<a class="sourceLine" id="cb10-29" data-line-number="29"><span class="co"># wrap-up to full model</span></a>
<a class="sourceLine" id="cb10-30" data-line-number="30">model &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/pkg/keras/man/keras_model.html">keras_model</a></span>(<span class="dt">inputs =</span> input, <span class="dt">outputs =</span> output)</a>
<a class="sourceLine" id="cb10-31" data-line-number="31"></a>
<a class="sourceLine" id="cb10-32" data-line-number="32"><span class="co"># compile the model</span></a>
<a class="sourceLine" id="cb10-33" data-line-number="33">model <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/pkg/keras/man/reexports.html">compile</a></span>(</a>
<a class="sourceLine" id="cb10-34" data-line-number="34">  <span class="dt">optimizer =</span> <span class="kw"><a href="https://rdrr.io/pkg/keras/man/optimizer_adam.html">optimizer_adam</a></span>(<span class="dt">lr =</span> <span class="fl">0.0001</span>),</a>
<a class="sourceLine" id="cb10-35" data-line-number="35">  <span class="dt">loss =</span> <span class="st">"mean_absolute_error"</span></a>
<a class="sourceLine" id="cb10-36" data-line-number="36">)</a>
<a class="sourceLine" id="cb10-37" data-line-number="37"></a>
<a class="sourceLine" id="cb10-38" data-line-number="38"><span class="co"># model summary</span></a>
<a class="sourceLine" id="cb10-39" data-line-number="39"><span class="kw"><a href="https://rdrr.io/r/base/summary.html">summary</a></span>(model)</a>
<a class="sourceLine" id="cb10-40" data-line-number="40"><span class="co">#&gt; ___________________________________________________________________________</span></a>
<a class="sourceLine" id="cb10-41" data-line-number="41"><span class="co">#&gt; Layer (type)            Output Shape     Param #  Connected to             </span></a>
<a class="sourceLine" id="cb10-42" data-line-number="42"><span class="co">#&gt; ===========================================================================</span></a>
<a class="sourceLine" id="cb10-43" data-line-number="43"><span class="co">#&gt; input (InputLayer)      (None, 24, 1)    0                                 </span></a>
<a class="sourceLine" id="cb10-44" data-line-number="44"><span class="co">#&gt; ___________________________________________________________________________</span></a>
<a class="sourceLine" id="cb10-45" data-line-number="45"><span class="co">#&gt; cnn_1_1 (Conv1D)        (None, 24, 16)   208      input[0][0]              </span></a>
<a class="sourceLine" id="cb10-46" data-line-number="46"><span class="co">#&gt; ___________________________________________________________________________</span></a>
<a class="sourceLine" id="cb10-47" data-line-number="47"><span class="co">#&gt; cnn_2_1 (Conv1D)        (None, 24, 16)   64       input[0][0]              </span></a>
<a class="sourceLine" id="cb10-48" data-line-number="48"><span class="co">#&gt; ___________________________________________________________________________</span></a>
<a class="sourceLine" id="cb10-49" data-line-number="49"><span class="co">#&gt; cnn_1_1_act (LeakyReLU) (None, 24, 16)   0        cnn_1_1[0][0]            </span></a>
<a class="sourceLine" id="cb10-50" data-line-number="50"><span class="co">#&gt; ___________________________________________________________________________</span></a>
<a class="sourceLine" id="cb10-51" data-line-number="51"><span class="co">#&gt; cnn_2_1_act (LeakyReLU) (None, 24, 16)   0        cnn_2_1[0][0]            </span></a>
<a class="sourceLine" id="cb10-52" data-line-number="52"><span class="co">#&gt; ___________________________________________________________________________</span></a>
<a class="sourceLine" id="cb10-53" data-line-number="53"><span class="co">#&gt; cnn_1_1_flat (Flatten)  (None, 384)      0        cnn_1_1_act[0][0]        </span></a>
<a class="sourceLine" id="cb10-54" data-line-number="54"><span class="co">#&gt; ___________________________________________________________________________</span></a>
<a class="sourceLine" id="cb10-55" data-line-number="55"><span class="co">#&gt; cnn_2_1_flat (Flatten)  (None, 384)      0        cnn_2_1_act[0][0]        </span></a>
<a class="sourceLine" id="cb10-56" data-line-number="56"><span class="co">#&gt; ___________________________________________________________________________</span></a>
<a class="sourceLine" id="cb10-57" data-line-number="57"><span class="co">#&gt; cnn_concat (Concatenate (None, 768)      0        cnn_1_1_flat[0][0]       </span></a>
<a class="sourceLine" id="cb10-58" data-line-number="58"><span class="co">#&gt;                                                   cnn_2_1_flat[0][0]       </span></a>
<a class="sourceLine" id="cb10-59" data-line-number="59"><span class="co">#&gt; ___________________________________________________________________________</span></a>
<a class="sourceLine" id="cb10-60" data-line-number="60"><span class="co">#&gt; cnn_dp (Dropout)        (None, 768)      0        cnn_concat[0][0]         </span></a>
<a class="sourceLine" id="cb10-61" data-line-number="61"><span class="co">#&gt; ___________________________________________________________________________</span></a>
<a class="sourceLine" id="cb10-62" data-line-number="62"><span class="co">#&gt; dense_1 (Dense)         (None, 32)       24608    cnn_dp[0][0]             </span></a>
<a class="sourceLine" id="cb10-63" data-line-number="63"><span class="co">#&gt; ___________________________________________________________________________</span></a>
<a class="sourceLine" id="cb10-64" data-line-number="64"><span class="co">#&gt; dense_1_act (LeakyReLU) (None, 32)       0        dense_1[0][0]            </span></a>
<a class="sourceLine" id="cb10-65" data-line-number="65"><span class="co">#&gt; ___________________________________________________________________________</span></a>
<a class="sourceLine" id="cb10-66" data-line-number="66"><span class="co">#&gt; dense_1_dp (Dropout)    (None, 32)       0        dense_1_act[0][0]        </span></a>
<a class="sourceLine" id="cb10-67" data-line-number="67"><span class="co">#&gt; ___________________________________________________________________________</span></a>
<a class="sourceLine" id="cb10-68" data-line-number="68"><span class="co">#&gt; output (Dense)          (None, 1)        33       dense_1_dp[0][0]         </span></a>
<a class="sourceLine" id="cb10-69" data-line-number="69"><span class="co">#&gt; ___________________________________________________________________________</span></a>
<a class="sourceLine" id="cb10-70" data-line-number="70"><span class="co">#&gt; output_reshape (Reshape (None, 1, 1)     0        output[0][0]             </span></a>
<a class="sourceLine" id="cb10-71" data-line-number="71"><span class="co">#&gt; ===========================================================================</span></a>
<a class="sourceLine" id="cb10-72" data-line-number="72"><span class="co">#&gt; Total params: 24,913</span></a>
<a class="sourceLine" id="cb10-73" data-line-number="73"><span class="co">#&gt; Trainable params: 24,913</span></a>
<a class="sourceLine" id="cb10-74" data-line-number="74"><span class="co">#&gt; Non-trainable params: 0</span></a>
<a class="sourceLine" id="cb10-75" data-line-number="75"><span class="co">#&gt; ___________________________________________________________________________</span></a></code></pre></div>
<p>Now let’s fit the model:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb11-1" data-line-number="1"><span class="co"># get generator meta</span></a>
<a class="sourceLine" id="cb11-2" data-line-number="2">steps_per_epoch &lt;-<span class="st"> </span><span class="kw"><a href="../reference/generator_meta.html">generator_meta</a></span>(data_train_gen, <span class="st">"steps_to_all"</span>)</a>
<a class="sourceLine" id="cb11-3" data-line-number="3">validation_steps &lt;-<span class="st"> </span><span class="kw"><a href="../reference/generator_meta.html">generator_meta</a></span>(data_val_gen, <span class="st">"steps_to_all"</span>)</a>
<a class="sourceLine" id="cb11-4" data-line-number="4"></a>
<a class="sourceLine" id="cb11-5" data-line-number="5"><span class="co"># fit the model</span></a>
<a class="sourceLine" id="cb11-6" data-line-number="6">history &lt;-<span class="st"> </span>model <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/pkg/keras/man/fit_generator.html">fit_generator</a></span>(</a>
<a class="sourceLine" id="cb11-7" data-line-number="7">  <span class="dt">generator =</span> data_train_gen,</a>
<a class="sourceLine" id="cb11-8" data-line-number="8">  <span class="dt">steps_per_epoch =</span> steps_per_epoch,</a>
<a class="sourceLine" id="cb11-9" data-line-number="9">  <span class="dt">epochs =</span> <span class="dv">100</span>,</a>
<a class="sourceLine" id="cb11-10" data-line-number="10">  <span class="dt">validation_data =</span> data_val_gen,</a>
<a class="sourceLine" id="cb11-11" data-line-number="11">  <span class="dt">validation_steps =</span> validation_steps</a>
<a class="sourceLine" id="cb11-12" data-line-number="12">)</a>
<a class="sourceLine" id="cb11-13" data-line-number="13"></a>
<a class="sourceLine" id="cb11-14" data-line-number="14"><span class="co"># visualize training results</span></a>
<a class="sourceLine" id="cb11-15" data-line-number="15"><span class="kw"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span>(history)</a></code></pre></div>
<p><img src="timeseries_files/figure-html/unnamed-chunk-13-1.png" width="85%" style="display: block; margin: auto;"></p>
<p>For preparing the prediction results, <code><a href="../reference/flow_series_from_dataframe.html">flow_series_from_dataframe()</a></code> has a method for <code>tidy_prediction</code>:</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb12-1" data-line-number="1"><span class="co"># get prediction on train</span></a>
<a class="sourceLine" id="cb12-2" data-line-number="2">pred_train &lt;-<span class="st"> </span>model <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb12-3" data-line-number="3"><span class="st">  </span><span class="kw"><a href="https://rdrr.io/pkg/keras/man/predict_generator.html">predict_generator</a></span>(</a>
<a class="sourceLine" id="cb12-4" data-line-number="4">    <span class="dt">generator =</span> <span class="kw"><a href="../reference/generator_mode.html">generator_mode</a></span>(data_train_gen, <span class="st">"prediction"</span>),</a>
<a class="sourceLine" id="cb12-5" data-line-number="5">    <span class="dt">steps =</span> <span class="kw"><a href="../reference/generator_meta.html">generator_meta</a></span>(data_train_gen, <span class="st">"steps_to_all"</span>)</a>
<a class="sourceLine" id="cb12-6" data-line-number="6">  )</a>
<a class="sourceLine" id="cb12-7" data-line-number="7"></a>
<a class="sourceLine" id="cb12-8" data-line-number="8"><span class="co"># an example for tidy_prediction</span></a>
<a class="sourceLine" id="cb12-9" data-line-number="9">data_train_gen <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb12-10" data-line-number="10"><span class="st">  </span><span class="kw"><a href="../reference/tidy_prediction.html">tidy_prediction</a></span>(pred_train)</a>
<a class="sourceLine" id="cb12-11" data-line-number="11"><span class="co">#&gt; # A tibble: 96 x 3</span></a>
<a class="sourceLine" id="cb12-12" data-line-number="12"><span class="co">#&gt;    sample steps passenger</span></a>
<a class="sourceLine" id="cb12-13" data-line-number="13"><span class="co">#&gt;     &lt;int&gt; &lt;int&gt;     &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb12-14" data-line-number="14"><span class="co">#&gt;  1      1     1    -1.05 </span></a>
<a class="sourceLine" id="cb12-15" data-line-number="15"><span class="co">#&gt;  2      2     1    -0.903</span></a>
<a class="sourceLine" id="cb12-16" data-line-number="16"><span class="co">#&gt;  3      3     1    -0.684</span></a>
<a class="sourceLine" id="cb12-17" data-line-number="17"><span class="co">#&gt;  4      4     1    -0.790</span></a>
<a class="sourceLine" id="cb12-18" data-line-number="18"><span class="co">#&gt;  5      5     1    -0.776</span></a>
<a class="sourceLine" id="cb12-19" data-line-number="19"><span class="co">#&gt;  6      6     1    -0.457</span></a>
<a class="sourceLine" id="cb12-20" data-line-number="20"><span class="co">#&gt;  7      7     1    -0.297</span></a>
<a class="sourceLine" id="cb12-21" data-line-number="21"><span class="co">#&gt;  8      8     1    -0.340</span></a>
<a class="sourceLine" id="cb12-22" data-line-number="22"><span class="co">#&gt;  9      9     1    -0.485</span></a>
<a class="sourceLine" id="cb12-23" data-line-number="23"><span class="co">#&gt; 10     10     1    -0.786</span></a>
<a class="sourceLine" id="cb12-24" data-line-number="24"><span class="co">#&gt; # … with 86 more rows</span></a></code></pre></div>
<p>So, if we want to visualize the results, we can use <code><a href="../reference/tidy_prediction.html">tidy_prediction()</a></code> to prepare the prediction <code>array</code> into a tidied <code>tibble</code>, and continue with further data post-processing parts:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb13-1" data-line-number="1"><span class="co"># get prediction on train</span></a>
<a class="sourceLine" id="cb13-2" data-line-number="2">pred_train &lt;-<span class="st"> </span>model <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb13-3" data-line-number="3"><span class="st">  </span><span class="kw"><a href="https://rdrr.io/pkg/keras/man/predict_generator.html">predict_generator</a></span>(</a>
<a class="sourceLine" id="cb13-4" data-line-number="4">    <span class="dt">generator =</span> <span class="kw"><a href="../reference/generator_mode.html">generator_mode</a></span>(data_train_gen, <span class="st">"prediction"</span>),</a>
<a class="sourceLine" id="cb13-5" data-line-number="5">    <span class="dt">steps =</span> <span class="kw"><a href="../reference/generator_meta.html">generator_meta</a></span>(data_train_gen, <span class="st">"steps_to_all"</span>)</a>
<a class="sourceLine" id="cb13-6" data-line-number="6">  )</a>
<a class="sourceLine" id="cb13-7" data-line-number="7"></a>
<a class="sourceLine" id="cb13-8" data-line-number="8">pred_train &lt;-<span class="st"> </span>data_train_gen <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb13-9" data-line-number="9"><span class="st">  </span><span class="kw"><a href="../reference/tidy_prediction.html">tidy_prediction</a></span>(pred_train) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb13-10" data-line-number="10"><span class="st">  </span><span class="kw">mutate</span>(</a>
<a class="sourceLine" id="cb13-11" data-line-number="11">    <span class="dt">date =</span> <span class="kw"><a href="https://rdrr.io/r/utils/head.html">tail</a></span>(data_train<span class="op">$</span>date, <span class="kw"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(.)),</a>
<a class="sourceLine" id="cb13-12" data-line-number="12">    <span class="dt">passenger =</span> <span class="kw">rec_rev</span>(passenger, rec)</a>
<a class="sourceLine" id="cb13-13" data-line-number="13">  )</a>
<a class="sourceLine" id="cb13-14" data-line-number="14"></a>
<a class="sourceLine" id="cb13-15" data-line-number="15"><span class="co"># get prediction on validation</span></a>
<a class="sourceLine" id="cb13-16" data-line-number="16">pred_val &lt;-<span class="st"> </span>model <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb13-17" data-line-number="17"><span class="st">  </span><span class="kw"><a href="https://rdrr.io/pkg/keras/man/predict_generator.html">predict_generator</a></span>(</a>
<a class="sourceLine" id="cb13-18" data-line-number="18">    <span class="dt">generator =</span> <span class="kw"><a href="../reference/generator_mode.html">generator_mode</a></span>(data_val_gen, <span class="st">"prediction"</span>),</a>
<a class="sourceLine" id="cb13-19" data-line-number="19">    <span class="dt">steps =</span> <span class="kw"><a href="../reference/generator_meta.html">generator_meta</a></span>(data_val_gen, <span class="st">"steps_to_all"</span>)</a>
<a class="sourceLine" id="cb13-20" data-line-number="20">  )</a>
<a class="sourceLine" id="cb13-21" data-line-number="21"></a>
<a class="sourceLine" id="cb13-22" data-line-number="22">pred_val &lt;-<span class="st"> </span>data_val_gen <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb13-23" data-line-number="23"><span class="st">  </span><span class="kw"><a href="../reference/tidy_prediction.html">tidy_prediction</a></span>(pred_val) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb13-24" data-line-number="24"><span class="st">  </span><span class="kw">mutate</span>(</a>
<a class="sourceLine" id="cb13-25" data-line-number="25">    <span class="dt">date =</span> <span class="kw"><a href="https://rdrr.io/r/utils/head.html">tail</a></span>(data_val<span class="op">$</span>date, <span class="kw"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(.)),</a>
<a class="sourceLine" id="cb13-26" data-line-number="26">    <span class="dt">passenger =</span> <span class="kw">rec_rev</span>(passenger, rec)</a>
<a class="sourceLine" id="cb13-27" data-line-number="27">  )</a>
<a class="sourceLine" id="cb13-28" data-line-number="28"></a>
<a class="sourceLine" id="cb13-29" data-line-number="29"><span class="co"># get prediction on test</span></a>
<a class="sourceLine" id="cb13-30" data-line-number="30">pred_test &lt;-<span class="st"> </span>model <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb13-31" data-line-number="31"><span class="st">  </span><span class="kw"><a href="https://rdrr.io/pkg/keras/man/predict_generator.html">predict_generator</a></span>(</a>
<a class="sourceLine" id="cb13-32" data-line-number="32">    <span class="dt">generator =</span> <span class="kw"><a href="../reference/generator_mode.html">generator_mode</a></span>(data_test_gen, <span class="st">"prediction"</span>),</a>
<a class="sourceLine" id="cb13-33" data-line-number="33">    <span class="dt">steps =</span> <span class="kw"><a href="../reference/generator_meta.html">generator_meta</a></span>(data_test_gen, <span class="st">"steps_to_all"</span>)</a>
<a class="sourceLine" id="cb13-34" data-line-number="34">  )</a>
<a class="sourceLine" id="cb13-35" data-line-number="35"></a>
<a class="sourceLine" id="cb13-36" data-line-number="36">pred_test &lt;-<span class="st"> </span>data_test_gen <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb13-37" data-line-number="37"><span class="st">  </span><span class="kw"><a href="../reference/tidy_prediction.html">tidy_prediction</a></span>(pred_test) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb13-38" data-line-number="38"><span class="st">  </span><span class="kw">mutate</span>(</a>
<a class="sourceLine" id="cb13-39" data-line-number="39">    <span class="dt">date =</span> <span class="kw"><a href="https://rdrr.io/r/utils/head.html">tail</a></span>(data_test<span class="op">$</span>date, <span class="kw"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(.)),</a>
<a class="sourceLine" id="cb13-40" data-line-number="40">    <span class="dt">passenger =</span> <span class="kw">rec_rev</span>(passenger, rec)</a>
<a class="sourceLine" id="cb13-41" data-line-number="41">  )</a>
<a class="sourceLine" id="cb13-42" data-line-number="42"></a>
<a class="sourceLine" id="cb13-43" data-line-number="43"><span class="co"># quick check</span></a>
<a class="sourceLine" id="cb13-44" data-line-number="44"><span class="kw"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(pred_train, <span class="dv">10</span>)</a>
<a class="sourceLine" id="cb13-45" data-line-number="45"><span class="co">#&gt; # A tibble: 10 x 4</span></a>
<a class="sourceLine" id="cb13-46" data-line-number="46"><span class="co">#&gt;    sample steps passenger date      </span></a>
<a class="sourceLine" id="cb13-47" data-line-number="47"><span class="co">#&gt;     &lt;int&gt; &lt;int&gt;     &lt;dbl&gt; &lt;date&gt;    </span></a>
<a class="sourceLine" id="cb13-48" data-line-number="48"><span class="co">#&gt;  1      1     1       151 1951-01-01</span></a>
<a class="sourceLine" id="cb13-49" data-line-number="49"><span class="co">#&gt;  2      2     1       160 1951-02-01</span></a>
<a class="sourceLine" id="cb13-50" data-line-number="50"><span class="co">#&gt;  3      3     1       175 1951-03-01</span></a>
<a class="sourceLine" id="cb13-51" data-line-number="51"><span class="co">#&gt;  4      4     1       167 1951-04-01</span></a>
<a class="sourceLine" id="cb13-52" data-line-number="52"><span class="co">#&gt;  5      5     1       168 1951-05-01</span></a>
<a class="sourceLine" id="cb13-53" data-line-number="53"><span class="co">#&gt;  6      6     1       191 1951-06-01</span></a>
<a class="sourceLine" id="cb13-54" data-line-number="54"><span class="co">#&gt;  7      7     1       203 1951-07-01</span></a>
<a class="sourceLine" id="cb13-55" data-line-number="55"><span class="co">#&gt;  8      8     1       200 1951-08-01</span></a>
<a class="sourceLine" id="cb13-56" data-line-number="56"><span class="co">#&gt;  9      9     1       189 1951-09-01</span></a>
<a class="sourceLine" id="cb13-57" data-line-number="57"><span class="co">#&gt; 10     10     1       168 1951-10-01</span></a></code></pre></div>
<p>With all tidied data, we can visualize the actual and prediction results:</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb14-1" data-line-number="1"><span class="co"># wrap-up all data</span></a>
<a class="sourceLine" id="cb14-2" data-line-number="2">data_list &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(</a>
<a class="sourceLine" id="cb14-3" data-line-number="3">  <span class="st">"Actual"</span> =<span class="st"> </span>airpassenger_df,</a>
<a class="sourceLine" id="cb14-4" data-line-number="4">  <span class="st">"Prediction-Train"</span> =<span class="st"> </span>pred_train,</a>
<a class="sourceLine" id="cb14-5" data-line-number="5">  <span class="st">"Prediction-Validation"</span> =<span class="st"> </span><span class="kw">bind_rows</span>(<span class="kw"><a href="https://rdrr.io/r/utils/head.html">tail</a></span>(pred_train, <span class="dv">1</span>), pred_val),</a>
<a class="sourceLine" id="cb14-6" data-line-number="6">  <span class="st">"Prediction-Test"</span> =<span class="st"> </span><span class="kw">bind_rows</span>(<span class="kw"><a href="https://rdrr.io/r/utils/head.html">tail</a></span>(pred_val, <span class="dv">1</span>), pred_test)</a>
<a class="sourceLine" id="cb14-7" data-line-number="7">)</a>
<a class="sourceLine" id="cb14-8" data-line-number="8"></a>
<a class="sourceLine" id="cb14-9" data-line-number="9"><span class="co"># prepare visualization data</span></a>
<a class="sourceLine" id="cb14-10" data-line-number="10">data_viz &lt;-<span class="st"> </span><span class="kw">bind_rows</span>(data_list, <span class="dt">.id =</span> <span class="st">"series"</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb14-11" data-line-number="11"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">series =</span> <span class="kw"><a href="https://rdrr.io/r/base/factor.html">factor</a></span>(series, <span class="dt">levels =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(</a>
<a class="sourceLine" id="cb14-12" data-line-number="12">    <span class="st">"Actual"</span>,</a>
<a class="sourceLine" id="cb14-13" data-line-number="13">    <span class="st">"Prediction-Train"</span>,</a>
<a class="sourceLine" id="cb14-14" data-line-number="14">    <span class="st">"Prediction-Validation"</span>,</a>
<a class="sourceLine" id="cb14-15" data-line-number="15">    <span class="st">"Prediction-Test"</span></a>
<a class="sourceLine" id="cb14-16" data-line-number="16">  )))</a>
<a class="sourceLine" id="cb14-17" data-line-number="17"></a>
<a class="sourceLine" id="cb14-18" data-line-number="18"><span class="co"># visualize</span></a>
<a class="sourceLine" id="cb14-19" data-line-number="19"><span class="kw">ggplot</span>(data_viz, <span class="kw">aes</span>(<span class="dt">x =</span> date, <span class="dt">y =</span> passenger)) <span class="op">+</span></a>
<a class="sourceLine" id="cb14-20" data-line-number="20"><span class="st">  </span><span class="kw">geom_line</span>(<span class="kw">aes</span>(<span class="dt">colour =</span> series)) <span class="op">+</span></a>
<a class="sourceLine" id="cb14-21" data-line-number="21"><span class="st">  </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="ot">NULL</span>, <span class="dt">y =</span> <span class="ot">NULL</span>, <span class="dt">colour =</span> <span class="ot">NULL</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb14-22" data-line-number="22"><span class="st">  </span><span class="kw">theme_minimal</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb14-23" data-line-number="23"><span class="st">  </span><span class="kw">theme</span>(<span class="dt">legend.position =</span> <span class="st">"top"</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb14-24" data-line-number="24"><span class="st">  </span><span class="kw">scale_colour_manual</span>(<span class="dt">values =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(</a>
<a class="sourceLine" id="cb14-25" data-line-number="25">    <span class="st">"Actual"</span> =<span class="st"> "black"</span>,</a>
<a class="sourceLine" id="cb14-26" data-line-number="26">    <span class="st">"Prediction-Train"</span> =<span class="st"> "blue"</span>,</a>
<a class="sourceLine" id="cb14-27" data-line-number="27">    <span class="st">"Prediction-Validation"</span> =<span class="st"> "green"</span>,</a>
<a class="sourceLine" id="cb14-28" data-line-number="28">    <span class="st">"Prediction-Test"</span> =<span class="st"> "red"</span></a>
<a class="sourceLine" id="cb14-29" data-line-number="29">  ))</a></code></pre></div>
<p><img src="timeseries_files/figure-html/unnamed-chunk-16-1.png" width="85%" style="display: block; margin: auto;"></p>
</div>
<div id="many-to-many-1" class="section level3">
<h3 class="hasAnchor">
<a href="#many-to-many-1" class="anchor"></a>Many-to-many</h3>
<p>For <strong>many-to-many</strong> example, we will going through the same process as in previous example; except, now we will settings the parameter into a proper many-to-many problems. In our case, let’s set the <code>length_out</code> into <code>12</code> months, and the <code>stride</code> into <code>12</code> months too; so we will train the model to predict 12 months ahead, with sampling rate every 12 months–1 whole year for 1 sample. Here is the settings:</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb15-1" data-line-number="1"><span class="co"># supervised time series settings</span></a>
<a class="sourceLine" id="cb15-2" data-line-number="2">x &lt;-<span class="st"> "passenger"</span></a>
<a class="sourceLine" id="cb15-3" data-line-number="3">y &lt;-<span class="st"> "passenger"</span></a>
<a class="sourceLine" id="cb15-4" data-line-number="4">length_out &lt;-<span class="st"> </span><span class="dv">12</span></a>
<a class="sourceLine" id="cb15-5" data-line-number="5">stride &lt;-<span class="st"> </span><span class="dv">12</span></a>
<a class="sourceLine" id="cb15-6" data-line-number="6">lookback &lt;-<span class="st"> </span><span class="dv">1</span></a>
<a class="sourceLine" id="cb15-7" data-line-number="7">timesteps &lt;-<span class="st"> </span><span class="dv">24</span></a></code></pre></div>
<p>Now we could apply the same process as in previous example. Here is the wrap-up for the rest of the process:</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb16-1" data-line-number="1"><span class="co"># validation and test sample size</span></a>
<a class="sourceLine" id="cb16-2" data-line-number="2">val_size &lt;-<span class="st"> </span>length_out <span class="op">*</span><span class="st"> </span><span class="dv">1</span></a>
<a class="sourceLine" id="cb16-3" data-line-number="3">test_size &lt;-<span class="st"> </span>length_out <span class="op">*</span><span class="st"> </span><span class="dv">1</span></a>
<a class="sourceLine" id="cb16-4" data-line-number="4"></a>
<a class="sourceLine" id="cb16-5" data-line-number="5"><span class="co"># test split</span></a>
<a class="sourceLine" id="cb16-6" data-line-number="6">data_test &lt;-<span class="st"> </span>airpassenger_df <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb16-7" data-line-number="7"><span class="st">  </span><span class="kw"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(<span class="kw">row_number</span>() <span class="op">&gt;</span><span class="st"> </span><span class="kw">n</span>() <span class="op">-</span><span class="st"> </span>test_size <span class="op">-</span><span class="st"> </span>lookback <span class="op">-</span><span class="st"> </span>timesteps <span class="op">+</span><span class="st"> </span><span class="dv">1</span>)</a>
<a class="sourceLine" id="cb16-8" data-line-number="8"></a>
<a class="sourceLine" id="cb16-9" data-line-number="9"><span class="co"># initial train after test-split</span></a>
<a class="sourceLine" id="cb16-10" data-line-number="10">data_train &lt;-<span class="st"> </span>airpassenger_df <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb16-11" data-line-number="11"><span class="st">  </span><span class="kw"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(<span class="kw">row_number</span>() <span class="op">&lt;=</span><span class="st"> </span><span class="kw">n</span>() <span class="op">-</span><span class="st"> </span>test_size)</a>
<a class="sourceLine" id="cb16-12" data-line-number="12"></a>
<a class="sourceLine" id="cb16-13" data-line-number="13"><span class="co"># validation split</span></a>
<a class="sourceLine" id="cb16-14" data-line-number="14">data_val &lt;-<span class="st"> </span>data_train <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb16-15" data-line-number="15"><span class="st">  </span><span class="kw"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(<span class="kw">row_number</span>() <span class="op">&gt;</span><span class="st"> </span><span class="kw">n</span>() <span class="op">-</span><span class="st"> </span>val_size <span class="op">-</span><span class="st"> </span>lookback <span class="op">-</span><span class="st"> </span>timesteps <span class="op">+</span><span class="st"> </span><span class="dv">1</span>)</a>
<a class="sourceLine" id="cb16-16" data-line-number="16"></a>
<a class="sourceLine" id="cb16-17" data-line-number="17"><span class="co"># final train after validation-split</span></a>
<a class="sourceLine" id="cb16-18" data-line-number="18">data_train &lt;-<span class="st"> </span>data_train <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb16-19" data-line-number="19"><span class="st">  </span><span class="kw"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(<span class="kw">row_number</span>() <span class="op">&lt;=</span><span class="st"> </span><span class="kw">n</span>() <span class="op">-</span><span class="st"> </span>val_size)</a>
<a class="sourceLine" id="cb16-20" data-line-number="20"></a>
<a class="sourceLine" id="cb16-21" data-line-number="21"><span class="co"># create preprocess recipe</span></a>
<a class="sourceLine" id="cb16-22" data-line-number="22">rec &lt;-<span class="st"> </span><span class="kw">recipe</span>(passenger <span class="op">~</span><span class="st"> </span>., <span class="dt">data =</span> data_train) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb16-23" data-line-number="23"><span class="st">  </span><span class="kw">step_rm</span>(date) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb16-24" data-line-number="24"><span class="st">  </span><span class="kw">step_log</span>(passenger) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb16-25" data-line-number="25"><span class="st">  </span><span class="kw">step_normalize</span>(passenger) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb16-26" data-line-number="26"><span class="st">  </span><span class="kw">prep</span>()</a>
<a class="sourceLine" id="cb16-27" data-line-number="27"></a>
<a class="sourceLine" id="cb16-28" data-line-number="28"><span class="co"># prepare recipes-revert functions</span></a>
<a class="sourceLine" id="cb16-29" data-line-number="29">rec_rev &lt;-<span class="st"> </span><span class="cf">function</span>(x, rec) {</a>
<a class="sourceLine" id="cb16-30" data-line-number="30"></a>
<a class="sourceLine" id="cb16-31" data-line-number="31">  means &lt;-<span class="st"> </span>rec<span class="op">$</span>steps[[<span class="dv">3</span>]]<span class="op">$</span>means[[<span class="st">"passenger"</span>]]</a>
<a class="sourceLine" id="cb16-32" data-line-number="32">  sds &lt;-<span class="st"> </span>rec<span class="op">$</span>steps[[<span class="dv">3</span>]]<span class="op">$</span>sds[[<span class="st">"passenger"</span>]]</a>
<a class="sourceLine" id="cb16-33" data-line-number="33"></a>
<a class="sourceLine" id="cb16-34" data-line-number="34">  x &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/Log.html">exp</a></span>(x <span class="op">*</span><span class="st"> </span>sds <span class="op">+</span><span class="st"> </span>means)</a>
<a class="sourceLine" id="cb16-35" data-line-number="35">  x &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/Round.html">round</a></span>(x)</a>
<a class="sourceLine" id="cb16-36" data-line-number="36">  x &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span>(x <span class="op">&lt;</span><span class="st"> </span><span class="dv">0</span>, <span class="dv">0</span>, x)</a>
<a class="sourceLine" id="cb16-37" data-line-number="37"></a>
<a class="sourceLine" id="cb16-38" data-line-number="38">  x</a>
<a class="sourceLine" id="cb16-39" data-line-number="39"></a>
<a class="sourceLine" id="cb16-40" data-line-number="40">}</a>
<a class="sourceLine" id="cb16-41" data-line-number="41"></a>
<a class="sourceLine" id="cb16-42" data-line-number="42"><span class="co"># get all preprocessed data</span></a>
<a class="sourceLine" id="cb16-43" data-line-number="43">data_train_prep &lt;-<span class="st"> </span><span class="kw">juice</span>(rec)</a>
<a class="sourceLine" id="cb16-44" data-line-number="44">data_val_prep &lt;-<span class="st"> </span><span class="kw">bake</span>(rec, data_val)</a>
<a class="sourceLine" id="cb16-45" data-line-number="45">data_test_prep &lt;-<span class="st"> </span><span class="kw">bake</span>(rec, data_test)</a>
<a class="sourceLine" id="cb16-46" data-line-number="46"></a>
<a class="sourceLine" id="cb16-47" data-line-number="47"><span class="co"># generator settings</span></a>
<a class="sourceLine" id="cb16-48" data-line-number="48">batch_size &lt;-<span class="st"> </span><span class="dv">2</span></a>
<a class="sourceLine" id="cb16-49" data-line-number="49"></a>
<a class="sourceLine" id="cb16-50" data-line-number="50"><span class="co"># train-val-test generator</span></a>
<a class="sourceLine" id="cb16-51" data-line-number="51">data_train_gen &lt;-<span class="st"> </span><span class="kw"><a href="../reference/flow_series_from_dataframe.html">flow_series_from_dataframe</a></span>(</a>
<a class="sourceLine" id="cb16-52" data-line-number="52">  <span class="dt">data =</span> data_train_prep,</a>
<a class="sourceLine" id="cb16-53" data-line-number="53">  <span class="dt">x =</span> x,</a>
<a class="sourceLine" id="cb16-54" data-line-number="54">  <span class="dt">y =</span> y,</a>
<a class="sourceLine" id="cb16-55" data-line-number="55">  <span class="dt">length_out =</span> length_out,</a>
<a class="sourceLine" id="cb16-56" data-line-number="56">  <span class="dt">stride =</span> stride,</a>
<a class="sourceLine" id="cb16-57" data-line-number="57">  <span class="dt">lookback =</span> lookback,</a>
<a class="sourceLine" id="cb16-58" data-line-number="58">  <span class="dt">timesteps =</span> timesteps,</a>
<a class="sourceLine" id="cb16-59" data-line-number="59">  <span class="dt">batch_size =</span> batch_size,</a>
<a class="sourceLine" id="cb16-60" data-line-number="60">  <span class="dt">mode =</span> <span class="st">"training"</span></a>
<a class="sourceLine" id="cb16-61" data-line-number="61">)</a>
<a class="sourceLine" id="cb16-62" data-line-number="62"></a>
<a class="sourceLine" id="cb16-63" data-line-number="63">data_val_gen &lt;-<span class="st"> </span><span class="kw"><a href="../reference/flow_series_from_dataframe.html">flow_series_from_dataframe</a></span>(</a>
<a class="sourceLine" id="cb16-64" data-line-number="64">  <span class="dt">data =</span> data_val_prep,</a>
<a class="sourceLine" id="cb16-65" data-line-number="65">  <span class="dt">x =</span> x,</a>
<a class="sourceLine" id="cb16-66" data-line-number="66">  <span class="dt">y =</span> y,</a>
<a class="sourceLine" id="cb16-67" data-line-number="67">  <span class="dt">length_out =</span> length_out,</a>
<a class="sourceLine" id="cb16-68" data-line-number="68">  <span class="dt">stride =</span> stride,</a>
<a class="sourceLine" id="cb16-69" data-line-number="69">  <span class="dt">lookback =</span> lookback,</a>
<a class="sourceLine" id="cb16-70" data-line-number="70">  <span class="dt">timesteps =</span> timesteps,</a>
<a class="sourceLine" id="cb16-71" data-line-number="71">  <span class="dt">batch_size =</span> batch_size,</a>
<a class="sourceLine" id="cb16-72" data-line-number="72">  <span class="dt">mode =</span> <span class="st">"training"</span></a>
<a class="sourceLine" id="cb16-73" data-line-number="73">)</a>
<a class="sourceLine" id="cb16-74" data-line-number="74"></a>
<a class="sourceLine" id="cb16-75" data-line-number="75">data_test_gen &lt;-<span class="st"> </span><span class="kw"><a href="../reference/flow_series_from_dataframe.html">flow_series_from_dataframe</a></span>(</a>
<a class="sourceLine" id="cb16-76" data-line-number="76">  <span class="dt">data =</span> data_test_prep,</a>
<a class="sourceLine" id="cb16-77" data-line-number="77">  <span class="dt">x =</span> x,</a>
<a class="sourceLine" id="cb16-78" data-line-number="78">  <span class="dt">y =</span> y,</a>
<a class="sourceLine" id="cb16-79" data-line-number="79">  <span class="dt">length_out =</span> length_out,</a>
<a class="sourceLine" id="cb16-80" data-line-number="80">  <span class="dt">stride =</span> stride,</a>
<a class="sourceLine" id="cb16-81" data-line-number="81">  <span class="dt">lookback =</span> lookback,</a>
<a class="sourceLine" id="cb16-82" data-line-number="82">  <span class="dt">timesteps =</span> timesteps,</a>
<a class="sourceLine" id="cb16-83" data-line-number="83">  <span class="dt">batch_size =</span> batch_size,</a>
<a class="sourceLine" id="cb16-84" data-line-number="84">  <span class="dt">mode =</span> <span class="st">"training"</span></a>
<a class="sourceLine" id="cb16-85" data-line-number="85">)</a>
<a class="sourceLine" id="cb16-86" data-line-number="86"></a>
<a class="sourceLine" id="cb16-87" data-line-number="87"><span class="co"># define input layer</span></a>
<a class="sourceLine" id="cb16-88" data-line-number="88">input &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/pkg/keras/man/layer_input.html">layer_input</a></span>(<span class="dt">name =</span> <span class="st">"input"</span>, <span class="dt">shape =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(timesteps, <span class="kw"><a href="https://rdrr.io/r/base/length.html">length</a></span>(x)))</a>
<a class="sourceLine" id="cb16-89" data-line-number="89"></a>
<a class="sourceLine" id="cb16-90" data-line-number="90"><span class="co"># define hidden layers</span></a>
<a class="sourceLine" id="cb16-91" data-line-number="91">cnn1 &lt;-<span class="st"> </span>input <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb16-92" data-line-number="92"><span class="st">  </span><span class="kw"><a href="https://rdrr.io/pkg/keras/man/layer_conv_1d.html">layer_conv_1d</a></span>(<span class="dt">name =</span> <span class="st">"cnn_1_1"</span>, <span class="dt">filters =</span> <span class="dv">16</span>, <span class="dt">kernel_size =</span> <span class="dv">12</span>, <span class="dt">padding =</span> <span class="st">"same"</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb16-93" data-line-number="93"><span class="st">  </span><span class="kw"><a href="https://rdrr.io/pkg/keras/man/layer_activation_leaky_relu.html">layer_activation_leaky_relu</a></span>(<span class="dt">name =</span> <span class="st">"cnn_1_1_act"</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb16-94" data-line-number="94"><span class="st">  </span><span class="kw"><a href="https://rdrr.io/pkg/keras/man/layer_flatten.html">layer_flatten</a></span>(<span class="dt">name =</span> <span class="st">"cnn_1_1_flat"</span>)</a>
<a class="sourceLine" id="cb16-95" data-line-number="95"></a>
<a class="sourceLine" id="cb16-96" data-line-number="96">cnn2 &lt;-<span class="st"> </span>input <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb16-97" data-line-number="97"><span class="st">  </span><span class="kw"><a href="https://rdrr.io/pkg/keras/man/layer_conv_1d.html">layer_conv_1d</a></span>(<span class="dt">name =</span> <span class="st">"cnn_2_1"</span>, <span class="dt">filters =</span> <span class="dv">16</span>, <span class="dt">kernel_size =</span> <span class="dv">3</span>, <span class="dt">padding =</span> <span class="st">"same"</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb16-98" data-line-number="98"><span class="st">  </span><span class="kw"><a href="https://rdrr.io/pkg/keras/man/layer_activation_leaky_relu.html">layer_activation_leaky_relu</a></span>(<span class="dt">name =</span> <span class="st">"cnn_2_1_act"</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb16-99" data-line-number="99"><span class="st">  </span><span class="kw"><a href="https://rdrr.io/pkg/keras/man/layer_flatten.html">layer_flatten</a></span>(<span class="dt">name =</span> <span class="st">"cnn_2_1_flat"</span>)</a>
<a class="sourceLine" id="cb16-100" data-line-number="100"></a>
<a class="sourceLine" id="cb16-101" data-line-number="101">cnn &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(cnn1, cnn2) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb16-102" data-line-number="102"><span class="st">  </span><span class="kw"><a href="https://rdrr.io/pkg/keras/man/layer_concatenate.html">layer_concatenate</a></span>(<span class="dt">name =</span> <span class="st">"cnn_concat"</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb16-103" data-line-number="103"><span class="st">  </span><span class="kw"><a href="https://rdrr.io/pkg/keras/man/layer_dropout.html">layer_dropout</a></span>(<span class="dt">name =</span> <span class="st">"cnn_dp"</span>, <span class="dt">rate =</span> <span class="fl">0.1</span>)</a>
<a class="sourceLine" id="cb16-104" data-line-number="104"></a>
<a class="sourceLine" id="cb16-105" data-line-number="105">fc &lt;-<span class="st"> </span>cnn <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb16-106" data-line-number="106"><span class="st">  </span><span class="kw"><a href="https://rdrr.io/pkg/keras/man/layer_dense.html">layer_dense</a></span>(<span class="dt">name =</span> <span class="st">"dense_1"</span>, <span class="dt">units =</span> <span class="dv">32</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb16-107" data-line-number="107"><span class="st">  </span><span class="kw"><a href="https://rdrr.io/pkg/keras/man/layer_activation_leaky_relu.html">layer_activation_leaky_relu</a></span>(<span class="dt">name =</span> <span class="st">"dense_1_act"</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb16-108" data-line-number="108"><span class="st">  </span><span class="kw"><a href="https://rdrr.io/pkg/keras/man/layer_dropout.html">layer_dropout</a></span>(<span class="dt">name =</span> <span class="st">"dense_1_dp"</span>, <span class="dt">rate =</span> <span class="fl">0.1</span>)</a>
<a class="sourceLine" id="cb16-109" data-line-number="109"></a>
<a class="sourceLine" id="cb16-110" data-line-number="110"><span class="co"># define output layers</span></a>
<a class="sourceLine" id="cb16-111" data-line-number="111">output &lt;-<span class="st"> </span>fc <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb16-112" data-line-number="112"><span class="st">  </span><span class="kw"><a href="https://rdrr.io/pkg/keras/man/layer_dense.html">layer_dense</a></span>(<span class="dt">name =</span> <span class="st">"output"</span>, <span class="dt">units =</span> <span class="kw"><a href="https://rdrr.io/r/base/length.html">length</a></span>(y) <span class="op">*</span><span class="st"> </span>length_out) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb16-113" data-line-number="113"><span class="st">  </span><span class="kw"><a href="https://rdrr.io/pkg/keras/man/layer_reshape.html">layer_reshape</a></span>(<span class="dt">name =</span> <span class="st">"output_reshape"</span>, <span class="dt">target_shape =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(length_out, <span class="kw"><a href="https://rdrr.io/r/base/length.html">length</a></span>(y)))</a>
<a class="sourceLine" id="cb16-114" data-line-number="114"></a>
<a class="sourceLine" id="cb16-115" data-line-number="115"><span class="co"># wrap-up to full model</span></a>
<a class="sourceLine" id="cb16-116" data-line-number="116">model &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/pkg/keras/man/keras_model.html">keras_model</a></span>(<span class="dt">inputs =</span> input, <span class="dt">outputs =</span> output)</a>
<a class="sourceLine" id="cb16-117" data-line-number="117"></a>
<a class="sourceLine" id="cb16-118" data-line-number="118"><span class="co"># compile the model</span></a>
<a class="sourceLine" id="cb16-119" data-line-number="119">model <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/pkg/keras/man/reexports.html">compile</a></span>(</a>
<a class="sourceLine" id="cb16-120" data-line-number="120">  <span class="dt">optimizer =</span> <span class="kw"><a href="https://rdrr.io/pkg/keras/man/optimizer_adam.html">optimizer_adam</a></span>(<span class="dt">lr =</span> <span class="fl">0.0001</span>),</a>
<a class="sourceLine" id="cb16-121" data-line-number="121">  <span class="dt">loss =</span> <span class="st">"mean_absolute_error"</span></a>
<a class="sourceLine" id="cb16-122" data-line-number="122">)</a>
<a class="sourceLine" id="cb16-123" data-line-number="123"></a>
<a class="sourceLine" id="cb16-124" data-line-number="124"><span class="co"># get generator meta</span></a>
<a class="sourceLine" id="cb16-125" data-line-number="125">steps_per_epoch &lt;-<span class="st"> </span><span class="kw"><a href="../reference/generator_meta.html">generator_meta</a></span>(data_train_gen, <span class="st">"steps_to_all"</span>)</a>
<a class="sourceLine" id="cb16-126" data-line-number="126">validation_steps &lt;-<span class="st"> </span><span class="kw"><a href="../reference/generator_meta.html">generator_meta</a></span>(data_val_gen, <span class="st">"steps_to_all"</span>)</a>
<a class="sourceLine" id="cb16-127" data-line-number="127"></a>
<a class="sourceLine" id="cb16-128" data-line-number="128"><span class="co"># fit the model</span></a>
<a class="sourceLine" id="cb16-129" data-line-number="129">history &lt;-<span class="st"> </span>model <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/pkg/keras/man/fit_generator.html">fit_generator</a></span>(</a>
<a class="sourceLine" id="cb16-130" data-line-number="130">  <span class="dt">generator =</span> data_train_gen,</a>
<a class="sourceLine" id="cb16-131" data-line-number="131">  <span class="dt">steps_per_epoch =</span> steps_per_epoch,</a>
<a class="sourceLine" id="cb16-132" data-line-number="132">  <span class="dt">epochs =</span> <span class="dv">100</span>,</a>
<a class="sourceLine" id="cb16-133" data-line-number="133">  <span class="dt">validation_data =</span> data_val_gen,</a>
<a class="sourceLine" id="cb16-134" data-line-number="134">  <span class="dt">validation_steps =</span> validation_steps</a>
<a class="sourceLine" id="cb16-135" data-line-number="135">)</a>
<a class="sourceLine" id="cb16-136" data-line-number="136"></a>
<a class="sourceLine" id="cb16-137" data-line-number="137"><span class="co"># get prediction on train</span></a>
<a class="sourceLine" id="cb16-138" data-line-number="138">pred_train &lt;-<span class="st"> </span>model <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb16-139" data-line-number="139"><span class="st">  </span><span class="kw"><a href="https://rdrr.io/pkg/keras/man/predict_generator.html">predict_generator</a></span>(</a>
<a class="sourceLine" id="cb16-140" data-line-number="140">    <span class="dt">generator =</span> <span class="kw"><a href="../reference/generator_mode.html">generator_mode</a></span>(data_train_gen, <span class="st">"prediction"</span>),</a>
<a class="sourceLine" id="cb16-141" data-line-number="141">    <span class="dt">steps =</span> <span class="kw"><a href="../reference/generator_meta.html">generator_meta</a></span>(data_train_gen, <span class="st">"steps_to_all"</span>)</a>
<a class="sourceLine" id="cb16-142" data-line-number="142">  )</a>
<a class="sourceLine" id="cb16-143" data-line-number="143"></a>
<a class="sourceLine" id="cb16-144" data-line-number="144">pred_train &lt;-<span class="st"> </span>data_train_gen <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb16-145" data-line-number="145"><span class="st">  </span><span class="kw"><a href="../reference/tidy_prediction.html">tidy_prediction</a></span>(pred_train) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb16-146" data-line-number="146"><span class="st">  </span><span class="kw">mutate</span>(</a>
<a class="sourceLine" id="cb16-147" data-line-number="147">    <span class="dt">date =</span> <span class="kw"><a href="https://rdrr.io/r/utils/head.html">tail</a></span>(data_train<span class="op">$</span>date, <span class="kw"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(.)),</a>
<a class="sourceLine" id="cb16-148" data-line-number="148">    <span class="dt">passenger =</span> <span class="kw">rec_rev</span>(passenger, rec)</a>
<a class="sourceLine" id="cb16-149" data-line-number="149">  )</a>
<a class="sourceLine" id="cb16-150" data-line-number="150"></a>
<a class="sourceLine" id="cb16-151" data-line-number="151"><span class="co"># get prediction on validation</span></a>
<a class="sourceLine" id="cb16-152" data-line-number="152">pred_val &lt;-<span class="st"> </span>model <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb16-153" data-line-number="153"><span class="st">  </span><span class="kw"><a href="https://rdrr.io/pkg/keras/man/predict_generator.html">predict_generator</a></span>(</a>
<a class="sourceLine" id="cb16-154" data-line-number="154">    <span class="dt">generator =</span> <span class="kw"><a href="../reference/generator_mode.html">generator_mode</a></span>(data_val_gen, <span class="st">"prediction"</span>),</a>
<a class="sourceLine" id="cb16-155" data-line-number="155">    <span class="dt">steps =</span> <span class="kw"><a href="../reference/generator_meta.html">generator_meta</a></span>(data_val_gen, <span class="st">"steps_to_all"</span>)</a>
<a class="sourceLine" id="cb16-156" data-line-number="156">  )</a>
<a class="sourceLine" id="cb16-157" data-line-number="157"></a>
<a class="sourceLine" id="cb16-158" data-line-number="158">pred_val &lt;-<span class="st"> </span>data_val_gen <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb16-159" data-line-number="159"><span class="st">  </span><span class="kw"><a href="../reference/tidy_prediction.html">tidy_prediction</a></span>(pred_val) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb16-160" data-line-number="160"><span class="st">  </span><span class="kw">mutate</span>(</a>
<a class="sourceLine" id="cb16-161" data-line-number="161">    <span class="dt">date =</span> <span class="kw"><a href="https://rdrr.io/r/utils/head.html">tail</a></span>(data_val<span class="op">$</span>date, <span class="kw"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(.)),</a>
<a class="sourceLine" id="cb16-162" data-line-number="162">    <span class="dt">passenger =</span> <span class="kw">rec_rev</span>(passenger, rec)</a>
<a class="sourceLine" id="cb16-163" data-line-number="163">  )</a>
<a class="sourceLine" id="cb16-164" data-line-number="164"></a>
<a class="sourceLine" id="cb16-165" data-line-number="165"><span class="co"># get prediction on test</span></a>
<a class="sourceLine" id="cb16-166" data-line-number="166">pred_test &lt;-<span class="st"> </span>model <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb16-167" data-line-number="167"><span class="st">  </span><span class="kw"><a href="https://rdrr.io/pkg/keras/man/predict_generator.html">predict_generator</a></span>(</a>
<a class="sourceLine" id="cb16-168" data-line-number="168">    <span class="dt">generator =</span> <span class="kw"><a href="../reference/generator_mode.html">generator_mode</a></span>(data_test_gen, <span class="st">"prediction"</span>),</a>
<a class="sourceLine" id="cb16-169" data-line-number="169">    <span class="dt">steps =</span> <span class="kw"><a href="../reference/generator_meta.html">generator_meta</a></span>(data_test_gen, <span class="st">"steps_to_all"</span>)</a>
<a class="sourceLine" id="cb16-170" data-line-number="170">  )</a>
<a class="sourceLine" id="cb16-171" data-line-number="171"></a>
<a class="sourceLine" id="cb16-172" data-line-number="172">pred_test &lt;-<span class="st"> </span>data_test_gen <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb16-173" data-line-number="173"><span class="st">  </span><span class="kw"><a href="../reference/tidy_prediction.html">tidy_prediction</a></span>(pred_test) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb16-174" data-line-number="174"><span class="st">  </span><span class="kw">mutate</span>(</a>
<a class="sourceLine" id="cb16-175" data-line-number="175">    <span class="dt">date =</span> <span class="kw"><a href="https://rdrr.io/r/utils/head.html">tail</a></span>(data_test<span class="op">$</span>date, <span class="kw"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(.)),</a>
<a class="sourceLine" id="cb16-176" data-line-number="176">    <span class="dt">passenger =</span> <span class="kw">rec_rev</span>(passenger, rec)</a>
<a class="sourceLine" id="cb16-177" data-line-number="177">  )</a>
<a class="sourceLine" id="cb16-178" data-line-number="178"></a>
<a class="sourceLine" id="cb16-179" data-line-number="179"><span class="co"># wrap-up all data</span></a>
<a class="sourceLine" id="cb16-180" data-line-number="180">data_list &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(</a>
<a class="sourceLine" id="cb16-181" data-line-number="181">  <span class="st">"Actual"</span> =<span class="st"> </span>airpassenger_df,</a>
<a class="sourceLine" id="cb16-182" data-line-number="182">  <span class="st">"Prediction-Train"</span> =<span class="st"> </span>pred_train,</a>
<a class="sourceLine" id="cb16-183" data-line-number="183">  <span class="st">"Prediction-Validation"</span> =<span class="st"> </span><span class="kw">bind_rows</span>(<span class="kw"><a href="https://rdrr.io/r/utils/head.html">tail</a></span>(pred_train, <span class="dv">1</span>), pred_val),</a>
<a class="sourceLine" id="cb16-184" data-line-number="184">  <span class="st">"Prediction-Test"</span> =<span class="st"> </span><span class="kw">bind_rows</span>(<span class="kw"><a href="https://rdrr.io/r/utils/head.html">tail</a></span>(pred_val, <span class="dv">1</span>), pred_test)</a>
<a class="sourceLine" id="cb16-185" data-line-number="185">)</a>
<a class="sourceLine" id="cb16-186" data-line-number="186"></a>
<a class="sourceLine" id="cb16-187" data-line-number="187"><span class="co"># prepare visualization data</span></a>
<a class="sourceLine" id="cb16-188" data-line-number="188">data_viz &lt;-<span class="st"> </span><span class="kw">bind_rows</span>(data_list, <span class="dt">.id =</span> <span class="st">"series"</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb16-189" data-line-number="189"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">series =</span> <span class="kw"><a href="https://rdrr.io/r/base/factor.html">factor</a></span>(series, <span class="dt">levels =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(</a>
<a class="sourceLine" id="cb16-190" data-line-number="190">    <span class="st">"Actual"</span>,</a>
<a class="sourceLine" id="cb16-191" data-line-number="191">    <span class="st">"Prediction-Train"</span>,</a>
<a class="sourceLine" id="cb16-192" data-line-number="192">    <span class="st">"Prediction-Validation"</span>,</a>
<a class="sourceLine" id="cb16-193" data-line-number="193">    <span class="st">"Prediction-Test"</span></a>
<a class="sourceLine" id="cb16-194" data-line-number="194">  )))</a>
<a class="sourceLine" id="cb16-195" data-line-number="195"></a>
<a class="sourceLine" id="cb16-196" data-line-number="196"><span class="co"># visualize</span></a>
<a class="sourceLine" id="cb16-197" data-line-number="197"><span class="kw">ggplot</span>(data_viz, <span class="kw">aes</span>(<span class="dt">x =</span> date, <span class="dt">y =</span> passenger)) <span class="op">+</span></a>
<a class="sourceLine" id="cb16-198" data-line-number="198"><span class="st">  </span><span class="kw">geom_line</span>(<span class="kw">aes</span>(<span class="dt">colour =</span> series)) <span class="op">+</span></a>
<a class="sourceLine" id="cb16-199" data-line-number="199"><span class="st">  </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="ot">NULL</span>, <span class="dt">y =</span> <span class="ot">NULL</span>, <span class="dt">colour =</span> <span class="ot">NULL</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb16-200" data-line-number="200"><span class="st">  </span><span class="kw">theme_minimal</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb16-201" data-line-number="201"><span class="st">  </span><span class="kw">theme</span>(<span class="dt">legend.position =</span> <span class="st">"top"</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb16-202" data-line-number="202"><span class="st">  </span><span class="kw">scale_colour_manual</span>(<span class="dt">values =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(</a>
<a class="sourceLine" id="cb16-203" data-line-number="203">    <span class="st">"Actual"</span> =<span class="st"> "black"</span>,</a>
<a class="sourceLine" id="cb16-204" data-line-number="204">    <span class="st">"Prediction-Train"</span> =<span class="st"> "blue"</span>,</a>
<a class="sourceLine" id="cb16-205" data-line-number="205">    <span class="st">"Prediction-Validation"</span> =<span class="st"> "green"</span>,</a>
<a class="sourceLine" id="cb16-206" data-line-number="206">    <span class="st">"Prediction-Test"</span> =<span class="st"> "red"</span></a>
<a class="sourceLine" id="cb16-207" data-line-number="207">  ))</a></code></pre></div>
<p><img src="timeseries_files/figure-html/unnamed-chunk-18-1.png" width="85%" style="display: block; margin: auto;"></p>
</div>
</div>
<div id="references" class="section level2 unnumbered">
<h2 class="hasAnchor">
<a href="#references" class="anchor"></a>References</h2>
<div id="refs" class="references">
<div id="ref-chollet_tensorflow_2017">
<p>Chollet, F., &amp; Allaire, J. (2017). TensorFlow for R: Time series forecasting with recurrent neural networks. Retrieved from <a href="https://blogs.rstudio.com/tensorflow/posts/2017-12-20-time-series-forecasting-with-recurrent-neural-networks/">https://blogs.rstudio.com/tensorflow/posts/2017-12-20-time-series-forecasting-with-recurrent-neural-networks/</a></p>
</div>
<div id="ref-dancho_tensorflow_2018">
<p>Dancho, M., &amp; Keydana, S. (2018). TensorFlow for R: Predicting sunspot frequency with Keras. Retrieved from <a href="https://blogs.rstudio.com/tensorflow/posts/2018-06-25-sunspots-lstm/">https://blogs.rstudio.com/tensorflow/posts/2018-06-25-sunspots-lstm/</a></p>
</div>
<div id="ref-hochreiter_long_1997">
<p>Hochreiter, S., &amp; Schmidhuber, J. (1997). Long short-term memory. <em>Neural Computation</em>, <em>9</em>(8), 1735–1780.</p>
</div>
<div id="ref-laptev_engineering_2017">
<p>Laptev, N., Smyl, S., &amp; Shanmugam, S. (2017). Engineering Extreme Event Forecasting at Uber with Recurrent Neural Networks. <em>Uber Engineering Blog</em>. Retrieved from <a href="https://eng.uber.com/neural-networks/">https://eng.uber.com/neural-networks/</a></p>
</div>
<div id="ref-van_den_oord_wavenet_2016">
<p>Oord, A. van den, &amp; Dieleman, S. (2016). WaveNet: A Generative Model for Raw Audio. <em>Deepmind</em>. Retrieved from <a href="https://deepmind.com/blog/article/wavenet-generative-model-raw-audio">https://deepmind.com/blog/article/wavenet-generative-model-raw-audio</a></p>
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">

        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#introduction">Introduction</a></li>
      <li><a href="#practical-example">Practical example</a></li>
      <li><a href="#references">References</a></li>
      </ul>
</div>
      </div>

</div>



      <footer><div class="bgypkg">
  <p>kerasgenerator is a part of <strong>bagasbgy's packages</strong>. Learn more at <a href="https://bagasbgy.com">bagasbgy.com</a>.</p>
</div>

<div class="author">
  <p>
    Developed by <a href="https://bagasbgy.com">R. Dimas Bagas Herlambang</a>.
    Site built by <a href="https://pkgdown.r-lib.org">pkgdown</a>.
  </p>
</div>

      </footer>
</div>

  


  </body>
</html>
